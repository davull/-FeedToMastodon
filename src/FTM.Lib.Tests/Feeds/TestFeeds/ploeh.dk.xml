<?xml version="1.0"?>
<rss version="2.0">

  <channel>
    <title>ploeh blog</title>
    <link>https://blog.ploeh.dk</link>
    <description>danish software design</description>
    <language>en-us</language>
    <copyright>Mark Seemann</copyright>
    <pubDate>Wed, 01 Jan 2025 10:55:38 UTC</pubDate>
    <lastBuildDate>Wed, 01 Jan 2025 10:55:38 UTC</lastBuildDate>

    
      <item>
        <title>Pytest is fast</title>
        <link>https://blog.ploeh.dk/2024/12/30/pytest-is-fast/</link>
        <pubDate>Mon, 30 Dec 2024 16:01:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;One major attraction of Python. A recent realization.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Ever since I became aware of the distinction between statically and dynamically typed languages, I&apos;ve struggled to understand the attraction of dynamically typed languages. As regular readers may have noticed, this is &lt;a href=&quot;/2021/08/09/am-i-stuck-in-a-local-maximum&quot;&gt;a bias that doesn&apos;t sit well with me&lt;/a&gt;. Clearly, there are advantages to dynamic languages that I fail to notice. Is it &lt;a href=&quot;/2024/12/09/implementation-and-usage-mindsets&quot;&gt;a question of mindset&lt;/a&gt;? Or is it a combination of several small advantages?
    &lt;/p&gt;
    &lt;p&gt;
        In this article, I&apos;ll discuss another potential benefit of at least one dynamically typed language, &lt;a href=&quot;https://www.python.org/&quot;&gt;Python&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;c9d1927a5f6e4df0bdb1e71766f37d1f&quot;&gt;
        Fast feedback &lt;a href=&quot;#c9d1927a5f6e4df0bdb1e71766f37d1f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Rapid feedback is a cornerstone of &lt;a href=&quot;/ref/modern-software-engineering&quot;&gt;modern software engineering&lt;/a&gt;. I&apos;ve always considered the &lt;a href=&quot;/2011/04/29/Feedbackmechanismsandtradeoffs&quot;&gt;feedback from the compiler an important mechanism&lt;/a&gt;, but I&apos;ve recently begun to realize that it comes with a price. While a good type system keeps you honest, compilation takes time, too.
    &lt;/p&gt;
    &lt;p&gt;
        Since I&apos;ve been so entrenched in the camp of statically typed languages (C#, &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;, &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt;), I&apos;ve tended to regard compilation as a mandatory step. And since the compiler needs to run anyway, you might as well take advantage of it. Use the type system to &lt;a href=&quot;https://blog.janestreet.com/effective-ml-video/&quot;&gt;make illegal states unrepresentable&lt;/a&gt;, and all that.
    &lt;/p&gt;
    &lt;p&gt;
        Even so, I&apos;ve noticed that compilation time isn&apos;t a fixed size. This observation surely borders on the banal, but with sufficient cognitive bias, it can, apparently, take years to come to even such a trivial conclusion. After initial years with various programming languages, my formative years as a programmer were spent with C#. As it turns out, the C# compiler is relatively fast.
    &lt;/p&gt;
    &lt;p&gt;
        This is probably a combination of factors. Since C# is a one of the most popular languages, it has a big and skilled engineering team, and it&apos;s my impression that much effort goes into making it as fast and efficient as possible.
    &lt;/p&gt;
    &lt;p&gt;
        I also speculate that, since the C# type system isn&apos;t as powerful as F#&apos;s or Haskell&apos;s, there&apos;s simply work that it can&apos;t do. When you can&apos;t expression certain constraints or relationships with the type system, the compiler can&apos;t check them, either.
    &lt;/p&gt;
    &lt;p&gt;
        That said, the C# compiler seems to have become slower over the years. This could be a consequence of all the extra language features that accumulate.
    &lt;/p&gt;
    &lt;p&gt;
        The F# compiler, in comparison, has always taken longer than the C# compiler. Again, this may be due to a combination of a smaller engineering team and that it actually &lt;em&gt;can&lt;/em&gt; check more things at compile time, since the type system is more expressive.
    &lt;/p&gt;
    &lt;p&gt;
        This, at least, seems to fit with the observation that the Haskell compiler is even slower than F#. The language is incredibly expressive. There&apos;s a lot of constraints and relationships that you can model with the type system. Clearly, the compiler has to perform extra work to check that your types line up.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;re often left with the impression that &lt;em&gt;if it compiles, it works&lt;/em&gt;. The drawback is that getting Haskell code to compile may be a non-trivial undertaking.
    &lt;/p&gt;
    &lt;p&gt;
        One thing is that you&apos;ll have to wait for the compiler. Another is that if you practice test-driven development (TDD), you&apos;ll have to compile the test code, too. Only once the tests are compiled can you run them. And &lt;a href=&quot;/2012/05/24/TDDtestsuitesshouldrunin10secondsorless&quot;&gt;TDD test suites should run in 10 seconds or less&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;c156a0786a0940a29d37d9982881d5d5&quot;&gt;
        Skipping compilation with pytest &lt;a href=&quot;#c156a0786a0940a29d37d9982881d5d5&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A few years ago I had to learn a bit of Python, so I decided to try &lt;a href=&quot;https://adventofcode.com/2022&quot;&gt;Advent of Code 2022&lt;/a&gt; in Python. As the puzzles got harder, I added unit tests with &lt;a href=&quot;https://pytest.org/&quot;&gt;pytest&lt;/a&gt;. When I ran them, I was taken aback at how fast they ran.
    &lt;/p&gt;
    &lt;p&gt;
        There&apos;s no compilation step, so the test suite runs immediately. Obviously, if you&apos;ve made a mistake that a compiler would have caught, the test fails, but if the code makes sense to the interpreter, it just runs.
    &lt;/p&gt;
    &lt;p&gt;
        For various reasons, I ran out of steam, as one does with Advent of Code, but I managed to write a good little test suite. Until day 17, it ran in 0.15-0.20 seconds on my little laptop. To be honest, though, once I added tests for day 17, feedback time jumped to just under two seconds. This is clearly because I&apos;d written some inefficient code for my System Under Test.
    &lt;/p&gt;
    &lt;p&gt;
        I can&apos;t really blame a test framework for being slow, when it&apos;s really my own code that slows it down.
    &lt;/p&gt;
    &lt;p&gt;
        A counter-argument is that a compiled language is much faster than an interpreted one. Thus, one might think that a faster language would counter poor implementations. Not so.
    &lt;/p&gt;
    &lt;h3 id=&quot;c97e1f3c539a4ef78d2a07f25e9c6b0c&quot;&gt;
        TDD with Haskell &lt;a href=&quot;#c97e1f3c539a4ef78d2a07f25e9c6b0c&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As I&apos;ve already outlined, the Haskell compiler takes more time than C#, and obviously it takes more time than a language that isn&apos;t compiled at all. On the other hand, Haskell compiles to native machine code. My experience with it is that once you&apos;ve compiled your program, it&apos;s &lt;em&gt;fast&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In order to compare the two styles, I decided to record compilation and test times while doing &lt;a href=&quot;https://adventofcode.com/&quot;&gt;Advent of Code 2024&lt;/a&gt; in Haskell. I set up a Haskell code base with &lt;a href=&quot;https://haskellstack.org/&quot;&gt;Stack&lt;/a&gt; and &lt;a href=&quot;https://hackage.haskell.org/package/HUnit&quot;&gt;HUnit&lt;/a&gt;, as &lt;a href=&quot;/2018/05/07/inlined-hunit-test-lists&quot;&gt;I usually do&lt;/a&gt;. As I worked through the puzzles, I&apos;d be adding and running tests. Every time I recorded the time it took, using the &lt;a href=&quot;https://en.wikipedia.org/wiki/Time_(Unix)&quot;&gt;time&lt;/a&gt; command to measure the time it took for &lt;code&gt;stack test&lt;/code&gt; to run.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ve plotted the observations in this chart:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/haskell-compile-and-test-times.png&quot; alt=&quot;Scatter plot of more than a thousand compile-and-test times, measured in seconds.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The chart shows more than a thousand observations, with the first to the left, and the latest to the right. The times recorded are the entire time it took from I started a test run until I had an answer. For this, I used the time command&apos;s &lt;em&gt;real&lt;/em&gt; time measurement, rather than &lt;em&gt;user&lt;/em&gt; or &lt;em&gt;sys&lt;/em&gt; time. What matters is the feedback time; not the CPU time.
    &lt;/p&gt;
    &lt;p&gt;
        Each measurement is in seconds. The dashed orange line indicates the linear trend.
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s not the first time I&apos;ve written Haskell code, so I knew what to expect. While you get the occasional fast turnaround time, it easily takes around ten seconds to compile even an empty code base. It seems that there&apos;s a constant overhead of that size. While there&apos;s an upward trend line as I added more and more code, and more tests, actually running the tests takes almost no time. The initial &apos;average&apos; feedback time was around eight seconds, and 1100 observations later, the trends sits around 11.5 seconds. At this time, I had more than 200 test cases.
    &lt;/p&gt;
    &lt;p&gt;
        You may also notice that the observations vary quite a bit. You occasionally see sub-second times, but also turnaround times over thirty seconds. There&apos;s an explanation for both.
    &lt;/p&gt;
    &lt;p&gt;
        The sub-second times usually happen if I run the test suite twice without changing any code. In that case, the Haskell Stack correctly skips recompiling the code and instead just reruns the tests. This only highlights that I&apos;m not waiting for the tests to execute. The tests are fast. It&apos;s the compiler that causes over 90% of the delay.
    &lt;/p&gt;
    &lt;p&gt;
        (Why would I rerun a test suite without changing any code? This mostly happens when I take a break from programming, or if I get distracted by another task. In such cases, when I return to the code, I usually run the test suite in order to remind myself of the state in which I left it. Sometimes, it turns out, I&apos;d left the code in a state were the last thing I did was to run all tests.)
    &lt;/p&gt;
    &lt;p&gt;
        The other extremes have a different explanation.
    &lt;/p&gt;
    &lt;h3 id=&quot;8fa24383e06349718fca6cb70f95c98f&quot;&gt;
        IDE woes &lt;a href=&quot;#8fa24383e06349718fca6cb70f95c98f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Why do I have to suffer through those turnaround times over twenty seconds? A few times over thirty?
    &lt;/p&gt;
    &lt;p&gt;
        The short answer is that these represent complete rebuilds. Most of these are caused by problems with the &lt;a href=&quot;https://en.wikipedia.org/wiki/Integrated_development_environment&quot;&gt;IDE&lt;/a&gt;. For Haskell development, I use &lt;a href=&quot;https://code.visualstudio.com/&quot;&gt;Visual Studio Code&lt;/a&gt; with the &lt;a href=&quot;https://marketplace.visualstudio.com/items?itemName=haskell.haskell&quot;&gt;Haskell extension&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Perhaps it&apos;s only my setup that&apos;s messed up, but whenever I change a function in the System Under Test (SUT), I can. not. make. VS Code pick up that the API changed. Even if I correct my tests so that they still compile and run successfully from the command line, VS Code will keep insisting that the code is wrong.
    &lt;/p&gt;
    &lt;p&gt;
        This is, of course, annoying. One of the major selling points of statically type languages is that a good IDE can tell you if you made mistakes. Well, if it operates on an outdated view of what the SUT looks like, this no longer works.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ve tried restarting the Haskell Language Server, but that doesn&apos;t work. The only thing that works, as far as I&apos;ve been able to discover, is to close VS Code, delete &lt;code&gt;.stack-work&lt;/code&gt;, recompile, and reopen VS Code. Yes, that takes a minute or two, so not something I like doing too often.
    &lt;/p&gt;
    &lt;p&gt;
        Deleting &lt;code&gt;.stack-work&lt;/code&gt; does trigger a full rebuild, which is why we see those long build times.
    &lt;/p&gt;
    &lt;h3 id=&quot;81ef3b41740145af98094e9335a130eb&quot;&gt;
        Striking a good balance &lt;a href=&quot;#81ef3b41740145af98094e9335a130eb&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        What bothers me about dynamic languages is that I find discoverability and encapsulation so hard. I can&apos;t just look at the type of an operation and deduce what inputs it might take, or what the output might look like.
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, if you give me a plain text file with F# or Haskell, I can&apos;t do that either. A static type system doesn&apos;t magically surface that kind of information. Instead, you may rely on an IDE to provide such information at your fingertips. The Haskell extension, for example, gives you a little automatic type annotation above your functions, as discussed in the article &lt;a href=&quot;/2024/11/04/pendulum-swing-no-haskell-type-annotation-by-default&quot;&gt;Pendulum swing: no Haskell type annotation by default&lt;/a&gt;, and shown in a figure reprinted here for your convenience:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/haskell-code-with-inferred-type-displayed-by-vs-code.png&quot; alt=&quot;Screen shot of a Haskell function in Visual Studio Code with the function&apos;s type automatically displayed above it by the Haskell extension.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If this is to work well, this information must be immediate and responsive. On my system it isn&apos;t.
    &lt;/p&gt;
    &lt;p&gt;
        It may, again, be that there&apos;s some problem with my particular tool chain setup. Or perhaps a four-year-old Lenovo X1 Carbon is just too puny a machine to effectively run such a tool.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, I don&apos;t have similar issues with C# in Visual Studio (not VS Code). When I make changes, the IDE quickly responds and tells me if I&apos;ve made a mistake. To be honest, even here, I feel that &lt;a href=&quot;/2023/07/24/is-software-getting-worse&quot;&gt;it was faster and more responsive a decade ago&lt;/a&gt;, but compared to Haskell programming, the feedback I get with C# is close to immediate.
    &lt;/p&gt;
    &lt;p&gt;
        My experience with F# is somewhere in between. Visual Studio is quicker to pick up changes in F# code than VS Code is to reflect changes in Haskell, but it&apos;s not as fast as C#.
    &lt;/p&gt;
    &lt;p&gt;
        With Python, what little IDE integration is available is usually not trustworthy. Essentially, when suggesting callable operations, the IDE is mostly guessing, based on what it&apos;s already seen.
    &lt;/p&gt;
    &lt;p&gt;
        But, good Lord! The tests run fast.
    &lt;/p&gt;
    &lt;h3 id=&quot;4ea6dd100fbf4cc1b9c2941520a051bf&quot;&gt;
        Conclusion &lt;a href=&quot;#4ea6dd100fbf4cc1b9c2941520a051bf&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        My recent experiences with both Haskell and Python programming is giving me a better understanding of the balances and trade-offs involved with picking a language. While I still favour statically typed languages, I&apos;m beginning to see some attractive qualities on the other side.
    &lt;/p&gt;
    &lt;p&gt;
        Particularly, if you buy the argument that TDD suites should run in 10 seconds or less, this effectively means that I can&apos;t do TDD in Haskell. Not with the hardware I&apos;m running. Python, on the other hand, seems eminently well-suited for TDD.
    &lt;/p&gt;
    &lt;p&gt;
        That doesn&apos;t sit too well with me, but on the other hand, I&apos;m glad. I&apos;ve learned about a benefit of a dynamically typed language. While you may consider all of this ordinary and trite, it feels like a small breakthrough to me. I&apos;ve been trying hard to see past my own limitations, and it finally feels as though I&apos;ve found a few chinks in the armour of my biases.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll keep pushing those envelopes to see what else I may learn.
    &lt;/p&gt;
&lt;/div&gt;

&lt;div id=&quot;comments&quot;&gt;
    &lt;hr&gt;
    &lt;h2 id=&quot;comments-header&quot;&gt;
        Comments
    &lt;/h2&gt;

    &lt;div class=&quot;comment&quot; id=&quot;b760e53201c74532a33f1ae4a10407f9&quot;&gt;
        &lt;div class=&quot;comment-author&quot;&gt;Daniel Tartaglia &lt;a href=&quot;#b760e53201c74532a33f1ae4a10407f9&quot;&gt;#&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;commentt-content&quot;&gt;
            &lt;p&gt;An interesting insight, but if you consider that the compiler is effectively an additional test suit that is verifying the types are being used correctly, that extra compilation time is really just a whole suite of tests that you didn&apos;t have to write. I can&apos;t help but wonder how long it would take to manually implement all the tests that would be required to satisfy those checks in Python, and how much slower the Python test suite would then be.&lt;/p&gt;
            &lt;p&gt;Like you, I have a strong bias for typesafe languages (or at least moderately typesafe ones). The way I&apos;ve always explained it is as follows: Developers tend to work faster when writing with dynamic typed languages because they don&apos;t have to explain as much to a compiler. This literally means less code to write. However, because the developer &lt;i&gt;hasen&apos;t&lt;/i&gt; fully explained themself, any follow-on developer does not have as much context to work with.&lt;/p&gt;
            &lt;p&gt;After all, whether the language requires it or not, the developers need to define and consider types. The only question is, do they have to &lt;i&gt;write it down&lt;/i&gt;&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class=&quot;comment-date&quot;&gt;2025-01-01 01:26 UTC&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/12/30/pytest-is-fast</guid>
      </item>
    
      <item>
        <title>Implementing rod-cutting</title>
        <link>https://blog.ploeh.dk/2024/12/23/implementing-rod-cutting/</link>
        <pubDate>Mon, 23 Dec 2024 08:53:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;From pseudocode to implementation in three languages.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article picks up where &lt;a href=&quot;/2024/12/09/implementation-and-usage-mindsets&quot;&gt;Implementation and usage mindsets&lt;/a&gt; left off, examining how &lt;a href=&quot;https://www.infoq.com/presentations/Simple-Made-Easy/&quot;&gt;easy&lt;/a&gt; it is to implement an algorithm in three different programming languages.
    &lt;/p&gt;
    &lt;p&gt;
        As an example, I&apos;ll use the bottom-up rod-cutting algorithm from &lt;a href=&quot;/ref/clrs&quot;&gt;Introduction to Algorithms&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;0a09280df48e48c7b5257346dc98eab3&quot;&gt;
        Rod-cutting &lt;a href=&quot;#0a09280df48e48c7b5257346dc98eab3&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The problem is simple:
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;Serling Enterprises buys long steel rods and cuts them into shorter rods, which it then sells. Each cut is free. The management of Serling Enterprises wants to know the best way to cut up the rods.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;/ref/clrs&quot;&gt;Introduction to Algorithms. Fourth edition&lt;/a&gt;, ch. 14.1&lt;/cite&gt;&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        You&apos;re given an array of prices, or rather revenues, that each size is worth. The example from the book is given as a table:
    &lt;/p&gt;
    &lt;table&gt;
        &lt;tbody&gt;
            &lt;tr&gt;
                &lt;td&gt;length &lt;em&gt;i&lt;/em&gt;&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;3&lt;/td&gt;
                &lt;td&gt;4&lt;/td&gt;
                &lt;td&gt;5&lt;/td&gt;
                &lt;td&gt;6&lt;/td&gt;
                &lt;td&gt;7&lt;/td&gt;
                &lt;td&gt;8&lt;/td&gt;
                &lt;td&gt;9&lt;/td&gt;
                &lt;td&gt;10&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;price &lt;em&gt;p&lt;sub&gt;i&lt;/sub&gt;&lt;/em&gt;&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;5&lt;/td&gt;
                &lt;td&gt;8&lt;/td&gt;
                &lt;td&gt;9&lt;/td&gt;
                &lt;td&gt;10&lt;/td&gt;
                &lt;td&gt;17&lt;/td&gt;
                &lt;td&gt;17&lt;/td&gt;
                &lt;td&gt;20&lt;/td&gt;
                &lt;td&gt;24&lt;/td&gt;
                &lt;td&gt;30&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;p&gt;
        Notice that while this implies an array like &lt;code&gt;[1, 5, 8, 9, 10, 17, 17, 20, 24, 30]&lt;/code&gt;, the array is understood to be one-indexed, as is the most common case in the book. Most languages, including all three languages in this article, have zero-indexed arrays, but it turns out that we can get around the issue by adding a leading zero to the array: &lt;code&gt;[0, 1, 5, 8, 9, 10, 17, 17, 20, 24, 30]&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Thus, given that price array, the best you can do with a rod of length &lt;em&gt;10&lt;/em&gt; is to leave it uncut, yielding a revenue of &lt;em&gt;30&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/rod-size-10-no-cut.png&quot; alt=&quot;A rod divided into 10 segments, left uncut, with the number 30 above it.&quot; width=&quot;400&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, if you have a rod of length &lt;em&gt;7&lt;/em&gt;, you can cut it into two rods of lengths &lt;em&gt;1&lt;/em&gt; and &lt;em&gt;6&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/rod-size-7-cut-into-2.png&quot; alt=&quot;Two rods, one of a single segment, and one made from six segments. Above the single segment is the number 1, and above the six segments is the number 17.&quot; width=&quot;320&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Another solution for a rod of length &lt;em&gt;7&lt;/em&gt; is to cut it into three rods of sizes &lt;em&gt;2&lt;/em&gt;, &lt;em&gt;2&lt;/em&gt;, and &lt;em&gt;3&lt;/em&gt;. Both solutions yield a total revenue of &lt;em&gt;18&lt;/em&gt;. Thus, while more than one optimal solution exists, the algorithm given here only identifies one of them.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;Extended-Bottom-Up-Cut-Rod(p, n)
 1 let r[0:n] and s[1:n] be new arrays
 2 r[0] = 0
 3 for j = 1 to n                // for increasing rod length j
 4     q = -∞
 5     for i = 1 to j            // i is the position of the first cut
 6         if q &amp;lt; p[i] + r[j - i]
 7             q = p[i] + r[j - i]
 8             s[j] = i         // best cut location so far for length j
 9     r[j] = q                 // remember the solution value for length j
10 return r and s&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Which programming language is this? It&apos;s no particular language, but rather pseudocode.
    &lt;/p&gt;
    &lt;p&gt;
        The reason that the function is called &lt;code&gt;Extended-Bottom-Up-Cut-Rod&lt;/code&gt; is that the book pedagogically goes through a few other algorithms before arriving at this one. Going forward, I don&apos;t intend to keep that rather verbose name, but instead just call the function &lt;code&gt;cut_rod&lt;/code&gt;, &lt;code&gt;cutRod&lt;/code&gt;, or &lt;code&gt;Rod.cut&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;p&lt;/code&gt; parameter is a one-indexed price (or revenue) array, as explained above, and &lt;code&gt;n&lt;/code&gt; is a rod size (e.g. &lt;code&gt;10&lt;/code&gt; or &lt;code&gt;7&lt;/code&gt;, reflecting the above examples).
    &lt;/p&gt;
    &lt;p&gt;
        Given the above price array and &lt;code&gt;n = 10&lt;/code&gt;, the algorithm returns two arrays, &lt;code&gt;r&lt;/code&gt; for maximum possible revenue for a given cut, and &lt;code&gt;s&lt;/code&gt; for the size of the maximizing cut.
    &lt;/p&gt;
    &lt;table&gt;
        &lt;thead&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;em&gt;i&lt;/em&gt;&lt;/td&gt;
                &lt;td&gt;0&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;3&lt;/td&gt;
                &lt;td&gt;4&lt;/td&gt;
                &lt;td&gt;5&lt;/td&gt;
                &lt;td&gt;6&lt;/td&gt;
                &lt;td&gt;7&lt;/td&gt;
                &lt;td&gt;8&lt;/td&gt;
                &lt;td&gt;9&lt;/td&gt;
                &lt;td&gt;10&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;em&gt;r&lt;/em&gt;[&lt;em&gt;i&lt;/em&gt;]&lt;/td&gt;
                &lt;td&gt;0&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;5&lt;/td&gt;
                &lt;td&gt;8&lt;/td&gt;
                &lt;td&gt;10&lt;/td&gt;
                &lt;td&gt;13&lt;/td&gt;
                &lt;td&gt;17&lt;/td&gt;
                &lt;td&gt;18&lt;/td&gt;
                &lt;td&gt;22&lt;/td&gt;
                &lt;td&gt;25&lt;/td&gt;
                &lt;td&gt;30&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;em&gt;s&lt;/em&gt;[&lt;em&gt;i&lt;/em&gt;]&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;3&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;6&lt;/td&gt;
                &lt;td&gt;1&lt;/td&gt;
                &lt;td&gt;2&lt;/td&gt;
                &lt;td&gt;3&lt;/td&gt;
                &lt;td&gt;10&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;p&gt;
        Such output doesn&apos;t really give a &lt;em&gt;solution&lt;/em&gt;, but rather the raw data to find a solution. For example, for &lt;code&gt;n = 10&lt;/code&gt; (= &lt;em&gt;i&lt;/em&gt;), you consult the table for (one-indexed) index &lt;em&gt;10&lt;/em&gt;, and see that you can get the revenue &lt;em&gt;30&lt;/em&gt; from making a cut at position &lt;em&gt;10&lt;/em&gt; (which effectively means no cut). For &lt;code&gt;n = 7&lt;/code&gt;, you consult the table for index 7 and observe that you can get the total revenue &lt;em&gt;18&lt;/em&gt; by making a cut at position &lt;em&gt;1&lt;/em&gt;. This leaves you with two rods, and you again consult the table. For &lt;code&gt;n = 1&lt;/code&gt;, you can get the revenue &lt;em&gt;1&lt;/em&gt; by making a cut at position &lt;em&gt;1&lt;/em&gt;; i.e. no further cut. For &lt;code&gt;n = 7 - 1 = 6&lt;/code&gt; you consult the table and observe that you can get the revenue &lt;em&gt;17&lt;/em&gt; by making a cut at position &lt;em&gt;6&lt;/em&gt;, again indicating that no further cut is necessary.
    &lt;/p&gt;
    &lt;p&gt;
        Another procedure prints the solution, using the above process:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;Print-Cut-Rod-Solution(p, n)
 1 (r, s) = Extended-Bottom-Up-Cut-Rod(p, n)
 2 while n &amp;gt; 0
 3     print s[n]    // cut location for length n
 4     n = n - s[n]  // length of the remainder of the rod&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Again, the procedure is given as pseudocode.
    &lt;/p&gt;
    &lt;p&gt;
        How easy is it translate this algorithm into code in a real programming language? Not surprisingly, this depends on the language.
    &lt;/p&gt;
    &lt;h3 id=&quot;36447b3aa2a14becbb895fd70fdd9d4a&quot;&gt;
        Translation to Python &lt;a href=&quot;#36447b3aa2a14becbb895fd70fdd9d4a&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The hypothesis of the &lt;a href=&quot;/2024/12/09/implementation-and-usage-mindsets&quot;&gt;previous&lt;/a&gt; article is that dynamically typed languages may be more suited for implementation tasks. The dynamically typed language that I know best is &lt;a href=&quot;https://www.python.org/&quot;&gt;Python&lt;/a&gt;, so let&apos;s try that.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;def&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;cut_rod&lt;/span&gt;(p,&amp;nbsp;n):
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r&amp;nbsp;=&amp;nbsp;[0]&amp;nbsp;*&amp;nbsp;(n&amp;nbsp;+&amp;nbsp;1)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;s&amp;nbsp;=&amp;nbsp;[0]&amp;nbsp;*&amp;nbsp;(n&amp;nbsp;+&amp;nbsp;1)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r[0]&amp;nbsp;=&amp;nbsp;0
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;j&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;range&lt;/span&gt;(1,&amp;nbsp;n&amp;nbsp;+&amp;nbsp;1):
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;q&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;float&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;-inf&amp;#39;&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;i&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;range&lt;/span&gt;(1,&amp;nbsp;j&amp;nbsp;+&amp;nbsp;1):
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;q&amp;nbsp;&amp;lt;&amp;nbsp;p[i]&amp;nbsp;+&amp;nbsp;r[j&amp;nbsp;-&amp;nbsp;i]:
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;q&amp;nbsp;=&amp;nbsp;p[i]&amp;nbsp;+&amp;nbsp;r[j&amp;nbsp;-&amp;nbsp;i]
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;s[j]&amp;nbsp;=&amp;nbsp;i
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r[j]&amp;nbsp;=&amp;nbsp;q
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;r,&amp;nbsp;s&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        That does, indeed, turn out to be straightforward. I had to figure out the syntax for initializing arrays, and how to represent negative infinity, but a combination of &lt;a href=&quot;https://github.com/features/copilot&quot;&gt;GitHub Copilot&lt;/a&gt; and a few web searches quickly cleared that up.
    &lt;/p&gt;
    &lt;p&gt;
        The same is true for the &lt;code&gt;Print-Cut-Rod-Solution&lt;/code&gt; procedure.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;def&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;print_cut_rod_solution&lt;/span&gt;(p,&amp;nbsp;n):
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r,&amp;nbsp;s&amp;nbsp;=&amp;nbsp;cut_rod(p,&amp;nbsp;n)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;while&lt;/span&gt;&amp;nbsp;n&amp;nbsp;&amp;gt;&amp;nbsp;0:
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;print&lt;/span&gt;(s[n])
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;n&amp;nbsp;=&amp;nbsp;n&amp;nbsp;-&amp;nbsp;s[n]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Apart from minor syntactical differences, the pseudocode translates directly to Python.
    &lt;/p&gt;
    &lt;p&gt;
        So far, the hypothesis seems to hold. This particular dynamically typed language, at least, easily implements that particular algorithm. If we must speculate about underlying reasons, we may argue that a dynamically typed language is &lt;a href=&quot;/2019/12/16/zone-of-ceremony&quot;&gt;low on ceremony&lt;/a&gt;. You don&apos;t have to get side-tracked by declaring types of parameters, variables, or return values.
    &lt;/p&gt;
    &lt;p&gt;
        That, at least, is a common complaint about statically typed languages that I hear when I discuss with lovers of dynamically typed languages.
    &lt;/p&gt;
    &lt;p&gt;
        Let us, then, try to implement the rod-cutting algorithm in a statically typed language.
    &lt;/p&gt;
    &lt;h3 id=&quot;a55c4ff33cf247f0b57ae58aa6795343&quot;&gt;
        Translation to Java &lt;a href=&quot;#a55c4ff33cf247f0b57ae58aa6795343&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Together with other &lt;a href=&quot;https://en.wikipedia.org/wiki/C_(programming_language)&quot;&gt;C&lt;/a&gt;-based languages, &lt;a href=&quot;https://www.java.com/&quot;&gt;Java&lt;/a&gt; is infamous for requiring a high amount of ceremony to get anything done. How easy is it to translate the rod-cutting pseudocode to Java? Not surprisingly, it turns out that one has to jump through a few more hoops.
    &lt;/p&gt;
    &lt;p&gt;
        First, of course, one has to set up a code base and choose a build system. I&apos;m not well-versed in Java development, but here I (more or less) arbitrarily chose &lt;a href=&quot;https://gradle.org/&quot;&gt;gradle&lt;/a&gt;. When you&apos;re new to an ecosystem, this can be a significant barrier, but I know from decades of C# programming that tooling alleviates much of that pain. Still, a single &lt;code&gt;.py&lt;/code&gt; file this isn&apos;t.
    &lt;/p&gt;
    &lt;p&gt;
        Apart from that, the biggest hurdle turned out to be that, as far as I can tell, Java doesn&apos;t have native tuple support. Thus, in order to return two arrays, I would have to either pick a reusable package that implements tuples, or define a custom class for that purpose. Object-oriented programmers often argue that tuples represent poor design, since a tuple doesn&apos;t really communicate the role or intent of each element. Given that the rod-cutting algorithm returns two integer arrays, I&apos;d be inclined to agree. You can&apos;t even tell them apart based on their types. For that reason, I chose to define a class to hold the result of the algorithm.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RodCuttingSolution&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;revenues;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;sizes;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RodCuttingSolution&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;revenues,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;sizes)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;.revenues&amp;nbsp;=&amp;nbsp;revenues;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;.sizes&amp;nbsp;=&amp;nbsp;sizes;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getRevenues&lt;/span&gt;()&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;revenues;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getSizes&lt;/span&gt;()&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;sizes;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Armed with this return type, the rest of the translation went smoothly.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;RodCuttingSolution&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;cutRod&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;p,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;n)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;var&amp;nbsp;r&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[n&amp;nbsp;+&amp;nbsp;1];
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;var&amp;nbsp;s&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[n&amp;nbsp;+&amp;nbsp;1];
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r[0]&amp;nbsp;=&amp;nbsp;0;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;j&amp;nbsp;=&amp;nbsp;1;&amp;nbsp;j&amp;nbsp;&amp;lt;=&amp;nbsp;n;&amp;nbsp;j++)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;var&amp;nbsp;q&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Integer&lt;/span&gt;.MIN_VALUE;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;i&amp;nbsp;=&amp;nbsp;1;&amp;nbsp;i&amp;nbsp;&amp;lt;=&amp;nbsp;j;&amp;nbsp;i++)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(q&amp;nbsp;&amp;lt;&amp;nbsp;p[i]&amp;nbsp;+&amp;nbsp;r[j&amp;nbsp;-&amp;nbsp;i])&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;q&amp;nbsp;=&amp;nbsp;p[i]&amp;nbsp;+&amp;nbsp;r[j&amp;nbsp;-&amp;nbsp;i];
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;s[j]&amp;nbsp;=&amp;nbsp;i;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;r[j]&amp;nbsp;=&amp;nbsp;q;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;RodCuttingSolution&lt;/span&gt;(r,&amp;nbsp;s);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Granted, there&apos;s a bit more ceremony involved compared to the Python code, since one must declare the types of both input parameters and method return type. You also have to declare the type of the arrays when initializing them, and you could argue that the &lt;code&gt;for&lt;/code&gt; loop syntax is more complicated than Python&apos;s &lt;code&gt;for ... in range ...&lt;/code&gt; syntax. One may also complain that all the brackets and parentheses makes it harder to read the code.
    &lt;/p&gt;
    &lt;p&gt;
        While I&apos;m used to such C-like code, I&apos;m not immune to such criticism. I actually do find the Python code more readable.
    &lt;/p&gt;
    &lt;p&gt;
        Translating the &lt;code&gt;Print-Cut-Rod-Solution&lt;/code&gt; pseudocode is a bit easier:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;void&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;printCutRodSolution&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;[]&amp;nbsp;p,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;n)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;var&amp;nbsp;result&amp;nbsp;=&amp;nbsp;cutRod(p,&amp;nbsp;n);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;while&lt;/span&gt;&amp;nbsp;(n&amp;nbsp;&amp;gt;&amp;nbsp;0)&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;System&lt;/span&gt;.out.println(result.getSizes()[n]);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;n&amp;nbsp;=&amp;nbsp;n&amp;nbsp;-&amp;nbsp;result.getSizes()[n];
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The overall structure of the code remains intact, but again we&apos;re burdened with extra ceremony. We have to declare input and output types, and call that awkward &lt;code&gt;getSizes&lt;/code&gt; method to retrieve the array of cut sizes.
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s possible that my Java isn&apos;t perfectly &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt;. After all, although I&apos;ve read many books with Java examples over the years, I rarely write Java code. Additionally, you may argue that &lt;code&gt;static&lt;/code&gt; methods exhibit a code smell like &lt;a href=&quot;https://wiki.c2.com/?FeatureEnvySmell&quot;&gt;Feature Envy&lt;/a&gt;. I might agree, but the purpose of the current example is to examine how easy or difficult it is to implement a particular algorithm in various languages. Now that we have an implementation in Java, we might wish to refactor to a more object-oriented design, but that&apos;s outside the scope of this article.
    &lt;/p&gt;
    &lt;p&gt;
        Given that the rod-cutting algorithm isn&apos;t the most complex algorithm that exists, we may jump to the conclusion that Java isn&apos;t &lt;em&gt;that bad&lt;/em&gt; compared to Python. Consider, however, how the extra ceremony on display here impacts your work if you have to implement a larger algorithm, or if you need to iterate to find an algorithm on your own.
    &lt;/p&gt;
    &lt;p&gt;
        To be clear, C# would require a similar amount of ceremony, and I don&apos;t even want to think about doing this in C.
    &lt;/p&gt;
    &lt;p&gt;
        All that said, it&apos;d be irresponsible to extrapolate from only a few examples. You&apos;d need both more languages and more problems before it even seems reasonable to draw any conclusions. I don&apos;t, however, intend the present example to constitute a full argument. Rather, it&apos;s an illustration of an idea that I haven&apos;t pulled out of thin air.
    &lt;/p&gt;
    &lt;p&gt;
        One of the points of &lt;a href=&quot;/2019/12/16/zone-of-ceremony&quot;&gt;Zone of Ceremony&lt;/a&gt; is that the degree of awkwardness isn&apos;t necessarily correlated to whether types are dynamically or statically defined. While I&apos;m sure that I miss lots of points made by &apos;dynamists&apos;, this is a point that I often feel is missed by that camp. One language that exemplifies that &apos;beyond-ceremony&apos; zone is &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;0bb95c0e7967419680fe3e6fcc9aed41&quot;&gt;
        Translation to F# &lt;a href=&quot;#0bb95c0e7967419680fe3e6fcc9aed41&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        If I&apos;m right, we should be able to translate the rod-cutting pseudocode to F# with approximately the same amount of trouble than when translating to Python. How do we fare?
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;cut&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;&amp;nbsp;:&amp;nbsp;_&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;array&lt;/span&gt;)&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Array&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;zeroCreate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;+&amp;nbsp;1)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Array&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;zeroCreate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;+&amp;nbsp;1)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;[0]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;&amp;lt;-&lt;/span&gt;&amp;nbsp;0
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;&amp;nbsp;=&amp;nbsp;1&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;to&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;mutable&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;q&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int32&lt;/span&gt;.MinValue
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;&amp;nbsp;=&amp;nbsp;1&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;to&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;q&lt;/span&gt;&amp;nbsp;&amp;lt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;]&amp;nbsp;+&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;&amp;nbsp;-&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;then&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;q&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;&amp;lt;-&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;]&amp;nbsp;+&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;&amp;nbsp;-&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;&amp;lt;-&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;j&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;&amp;lt;-&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;q&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Fairly well, as it turns out, although we &lt;em&gt;do&lt;/em&gt; have to annotate &lt;code&gt;p&lt;/code&gt; by indicating that it&apos;s an array. Still, the underscore in front of the &lt;code&gt;array&lt;/code&gt; keyword indicates that we&apos;re happy to let the compiler infer the type of array (which is &lt;code&gt;int array&lt;/code&gt;).
    &lt;/p&gt;
    &lt;p&gt;
        (We &lt;em&gt;can&lt;/em&gt; get around that issue by writing &lt;code&gt;Array.item i p&lt;/code&gt; instead of &lt;code&gt;p[i]&lt;/code&gt;, but that&apos;s verbose in a different way.)
    &lt;/p&gt;
    &lt;p&gt;
        Had we chosen to instead implement the algorithm based on an input list or map, we wouldn&apos;t have needed the type hint. One could therefore argue that the reason that the hint is even required is because arrays aren&apos;t the most idiomatic data structure for a functional language like F#.
    &lt;/p&gt;
    &lt;p&gt;
        Otherwise, I don&apos;t find that this translation was much harder than translating to Python, and I personally prefer &lt;code&gt;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;j&lt;/span&gt;&amp;nbsp;=&amp;nbsp;1&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;to&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;&lt;/code&gt; over &lt;code&gt;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;j&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;range&lt;/span&gt;(1,&amp;nbsp;n&amp;nbsp;+&amp;nbsp;1):&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        We also need to add the &lt;code&gt;mutable&lt;/code&gt; keyword to allow &lt;code&gt;q&lt;/code&gt; to change during the loop. You could argue that this is another example of additional ceremony, While I agree, it&apos;s not much related to static versus dynamic typing, but more to how values are immutable by default in F#. If I recall correctly, JavaScript similarly distinguishes between &lt;code&gt;let&lt;/code&gt;, &lt;code&gt;var&lt;/code&gt;, and &lt;code&gt;const&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Translating &lt;code&gt;Print-Cut-Rod-Solution&lt;/code&gt; requires, again due to values being immutable by default, a bit more effort than Python, but not much:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;printSolution&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;_,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;cut&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;mutable&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;n&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;while&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;&amp;nbsp;&amp;gt;&amp;nbsp;0&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;printfn&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;%i&lt;/span&gt;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;[&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;&amp;lt;-&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;&amp;nbsp;-&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;[&lt;span style=&quot;color:#a08000;&quot;&gt;n&lt;/span&gt;]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I had to shadow the &lt;code&gt;n&lt;/code&gt; parameter with a &lt;code&gt;mutable&lt;/code&gt; variable to stay as close to the pseudocode as possible. Again, one may argue that the overall problem here isn&apos;t the static type system, but that programming based on mutation isn&apos;t idiomatic for F# (or other functional programming languages). As you&apos;ll see in the next article, a more idiomatic implementation is even simpler than this one.
    &lt;/p&gt;
    &lt;p&gt;
        Notice, however, that the &lt;code&gt;printSolution&lt;/code&gt; action requires no type declarations or annotations.
    &lt;/p&gt;
    &lt;p&gt;
        Let&apos;s see it all in use:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&amp;gt; let p = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|];;
val p: int array = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|]

&amp;gt; Rod.printSolution p 7;;
1
6&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This little interactive session reproduces the example illustrated in the beginning of this article, when given the price array from the book and a rod of size &lt;em&gt;7&lt;/em&gt;, the solution printed indicates cuts at positions &lt;em&gt;1&lt;/em&gt; and &lt;em&gt;6&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        I find it telling that the translation to F# is on par with the translation to Python, even though the structure of the pseudocode is quite imperative.
    &lt;/p&gt;
    &lt;h3 id=&quot;eb28d2ce98b34628b2ec4d0df8905492&quot;&gt;
        Conclusion &lt;a href=&quot;#eb28d2ce98b34628b2ec4d0df8905492&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        You could, perhaps, say that if your mindset is predominantly imperative, implementing an algorithm using Python is likely easier than both F# or Java. If, on the other hand, you&apos;re mostly in an implementation mindset, but not strongly attached to whether the implementation should be imperative, object-oriented, or functional, I&apos;d offer the conjecture that a language like F# is as implementation-friendly as a language like Python.
    &lt;/p&gt;
    &lt;p&gt;
        If, on the other hand, you&apos;re more focused on encapsulating and documenting how an existing API works, perhaps that shift of perspective suggests another evaluation of dynamically versus statically typed languages.
    &lt;/p&gt;
    &lt;p&gt;
        In any case, the F# code shown here is hardly idiomatic, so it might be illuminating to see what happens if we refactor it.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; Encapsulating rod-cutting.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/12/23/implementing-rod-cutting</guid>
      </item>
    
      <item>
        <title>A restaurant sandwich</title>
        <link>https://blog.ploeh.dk/2024/12/16/a-restaurant-sandwich/</link>
        <pubDate>Mon, 16 Dec 2024 19:11:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;An Impureim Sandwich example in C#.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        When learning functional programming (FP) people often struggle with how to organize code. How do you &lt;a href=&quot;/2020/02/24/discerning-and-maintaining-purity&quot;&gt;discern and maintain purity&lt;/a&gt;? &lt;a href=&quot;/2017/02/02/dependency-rejection&quot;&gt;How do you do Dependency Injection in FP?&lt;/a&gt; What does &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;a functional architecture&lt;/a&gt; look like?
    &lt;/p&gt;
    &lt;p&gt;
        A common FP design pattern is the &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt;. The entry point of an application is always impure, so you push all impure actions to the boundary of the system. This is also known as &lt;a href=&quot;https://www.destroyallsoftware.com/screencasts/catalog/functional-core-imperative-shell&quot;&gt;Functional Core, Imperative Shell&lt;/a&gt;. If you have a &lt;a href=&quot;/2017/07/10/pure-interactions&quot;&gt;micro-operation-based architecture&lt;/a&gt;, which includes all web-based systems, you can often get by with a &apos;sandwich&apos;. Perform impure actions to collect all the data you need. Pass all data to a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt;. Finally, use impure actions to handle the &lt;a href=&quot;https://en.wikipedia.org/wiki/Referential_transparency&quot;&gt;referentially transparent&lt;/a&gt; return value from the pure function.
    &lt;/p&gt;
    &lt;p&gt;
        No design pattern applies universally, and neither does this one. In my experience, however, it&apos;s surprisingly often possible to apply this architecture. We&apos;re far past the &lt;a href=&quot;https://en.wikipedia.org/wiki/Pareto_principle&quot;&gt;Pareto principle&lt;/a&gt;&apos;s 80 percent.
    &lt;/p&gt;
    &lt;p&gt;
        Examples may help illustrate the pattern, as well as explore its boundaries. In this article you&apos;ll see how I refactored an entry point of a &lt;a href=&quot;https://en.wikipedia.org/wiki/REST&quot;&gt;REST&lt;/a&gt; API, specifically the &lt;code&gt;PUT&lt;/code&gt; handler in the sample code base that accompanies &lt;a href=&quot;/2021/06/14/new-book-code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;67463d3ade684a2b9de807b261ebb03c&quot;&gt;
        Starting point &lt;a href=&quot;#67463d3ade684a2b9de807b261ebb03c&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As discussed in the book, the architecture of the sample code base is, in fact, Functional Core, Imperative Shell. This isn&apos;t, however, the main theme of the book, and the code doesn&apos;t explicitly apply the Impureim Sandwich. In spirit, that&apos;s actually what&apos;s going on, but it isn&apos;t clear from looking at the code. This was a deliberate choice I made, because I wanted to highlight other software engineering practices. This does have the effect, though, that the Impureim Sandwich is invisible.
    &lt;/p&gt;
    &lt;p&gt;
        For example, the book follows &lt;a href=&quot;/2019/11/04/the-80-24-rule&quot;&gt;the 80/24 rule&lt;/a&gt; closely. This was a didactic choice on my part. Most code bases I&apos;ve seen in the wild have far too big methods, so I wanted to hammer home the message that it&apos;s possible to develop and maintain a non-trivial code base with small code blocks. This meant, however, that I had to split up HTTP request handlers (in ASP.NET known as &lt;em&gt;action methods&lt;/em&gt; on Controllers).
    &lt;/p&gt;
    &lt;p&gt;
        The most complex HTTP handler is the one that handles &lt;code&gt;PUT&lt;/code&gt; requests for reservations. Clients use this action when they want to make changes to a restaurant reservation.
    &lt;/p&gt;
    &lt;p&gt;
        The action method actually invoked by an HTTP request is this &lt;code&gt;Put&lt;/code&gt; method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&lt;span style=&quot;color:#2b91af;&quot;&gt;HttpPut&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;restaurants/{restaurantId}/reservations/{id}&amp;quot;&lt;/span&gt;)]
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Put&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;throw&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ArgumentNullException&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;nameof&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;));
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;TryParse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;out&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rid&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;?&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Validate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rid&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BadRequestResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;RestaurantDatabase
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRestaurant&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryUpdate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since I, for pedagogical reasons, wanted to fit each method inside an 80x24 box, I made a few somewhat unnatural design choices. The above code is one of them. While I don&apos;t consider it completely indefensible, this method does a bit of up-front input validation and verification, and then delegates execution to the &lt;code&gt;TryUpdate&lt;/code&gt; method.
    &lt;/p&gt;
    &lt;p&gt;
        This may seem all fine and dandy until you realize that the only caller of &lt;code&gt;TryUpdate&lt;/code&gt; is that &lt;code&gt;Put&lt;/code&gt; method. A similar thing happens in &lt;code&gt;TryUpdate&lt;/code&gt;: It calls a method that has only that one caller. We may try to inline those two methods to see if we can spot the Impureim Sandwich.
    &lt;/p&gt;
    &lt;h3 id=&quot;dab8cd4011a5493ea55b47cb2240839b&quot;&gt;
        Inlined Transaction Script &lt;a href=&quot;#dab8cd4011a5493ea55b47cb2240839b&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Inlining those two methods leave us with a larger, &lt;a href=&quot;https://martinfowler.com/eaaCatalog/transactionScript.html&quot;&gt;Transaction Script&lt;/a&gt;-like entry point:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&lt;span style=&quot;color:#2b91af;&quot;&gt;HttpPut&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;restaurants/{restaurantId}/reservations/{id}&amp;quot;&lt;/span&gt;)]
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Put&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;throw&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ArgumentNullException&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;nameof&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;));
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;TryParse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;out&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rid&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;?&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Validate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rid&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BadRequestResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;RestaurantDatabase
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRestaurant&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TransactionScope&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TransactionScopeAsyncFlowOption&lt;/span&gt;.Enabled);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;existing&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Id)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;existing&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.At)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Where&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;.Id&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;!=&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Id).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToList&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;&amp;nbsp;=&amp;nbsp;Clock.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetCurrentDateTime&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Update&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Complete&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkObjectResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToDto&lt;/span&gt;());
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        While I&apos;ve definitely seen longer methods in the wild, this variation is already so big that it no longer fits on my laptop screen. I have to scroll up and down to read the whole thing. When looking at the bottom of the method, I have to &lt;em&gt;remember&lt;/em&gt; what was at the top, because I can no longer see it.
    &lt;/p&gt;
    &lt;p&gt;
        A major point of &lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt; is that what limits programmer productivity is human cognition. If you have to scroll your screen because you can&apos;t see the whole method at once, does that fit in your brain? Chances are, it doesn&apos;t.
    &lt;/p&gt;
    &lt;p&gt;
        Can you spot the Impureim Sandwich now?
    &lt;/p&gt;
    &lt;p&gt;
        If you can&apos;t, that&apos;s understandable. It&apos;s not really clear because there&apos;s quite a few small decisions being made in this code. You could argue, for example, that this decision is referentially transparent:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;existing&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        These two lines of code are deterministic and have no side effects. The branch only returns a &lt;code&gt;NotFoundResult&lt;/code&gt; when &lt;code&gt;existing is null&lt;/code&gt;. Additionally, these two lines of code are surrounded by impure actions both before and after. Is this the Sandwich, then?
    &lt;/p&gt;
    &lt;p&gt;
        No, it&apos;s not. This is how &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; imperative code looks. To borrow a diagram from &lt;a href=&quot;/2020/03/23/repeatable-execution&quot;&gt;another article&lt;/a&gt;, pure and impure code is interleaved without discipline:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/impure-with-stripes-of-purity.png&quot; alt=&quot;A box of mostly impure (red) code with vertical stripes of green symbolising pure code.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Even so, the above &lt;code&gt;Put&lt;/code&gt; method implements the Functional Core, Imperative Shell architecture. The &lt;code&gt;Put&lt;/code&gt; method &lt;em&gt;is&lt;/em&gt; the Imperative Shell, but where&apos;s the Functional Core?
    &lt;/p&gt;
    &lt;h3 id=&quot;e9ccab8ae8234c139934b87238dcf672&quot;&gt;
        Shell perspective &lt;a href=&quot;#e9ccab8ae8234c139934b87238dcf672&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        One thing to be aware of is that when looking at the Imperative Shell code, the Functional Core is close to invisible. This is because it&apos;s typically only a single function call.
    &lt;/p&gt;
    &lt;p&gt;
        In the above &lt;code&gt;Put&lt;/code&gt; method, this is the Functional Core:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;();&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s only a few lines of code, and had I not given myself the constraint of staying within an 80 character line width, I could have instead laid it out like this and inlined the &lt;code&gt;ok&lt;/code&gt; flag:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;();&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Now that I try this, in fact, it turns out that this actually still stays within 80 characters. To be honest, I don&apos;t know exactly why I had that former code instead of this, but perhaps I found the latter alternative too dense. Or perhaps I simply didn&apos;t think of it. Code is rarely perfect. Usually when I revisit a piece of code after having been away from it for some time, I find some thing that I want to change.
    &lt;/p&gt;
    &lt;p&gt;
        In any case, that&apos;s beside the point. What matters here is that when you&apos;re looking through the Imperative Shell code, the Functional Core looks insignificant. Blink and you&apos;ll miss it. Even if we ignore all the other small pure decisions (the &lt;code&gt;if&lt;/code&gt; statements) and pretend that we already have an Impureim Sandwich, from this viewpoint, the architecture &lt;em&gt;looks&lt;/em&gt; like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/impure-tiny-pure-impure-sandwich-box.png&quot; alt=&quot;A box with a big red section on top, a thin green sliver middle, and another big red part at the bottom.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s tempting to ask, then: What&apos;s all the fuss about? Why even bother?
    &lt;/p&gt;
    &lt;p&gt;
        This is a natural experience for a code reader. After all, if you don&apos;t know a code base well, you often start at the entry point to try to understand how the application handles a certain stimulus. Such as an HTTP &lt;code&gt;PUT&lt;/code&gt; request. When you do that, you see all of the Imperative Shell code before you see the Functional Core code. This could give you the wrong impression about the balance of responsibility.
    &lt;/p&gt;
    &lt;p&gt;
        After all, code like the above &lt;code&gt;Put&lt;/code&gt; method has inlined most of the impure code so that it&apos;s right in your face. Granted, there&apos;s still some code hiding behind, say, &lt;code&gt;Repository.ReadReservations&lt;/code&gt;, but a substantial fraction of the imperative code is visible in the method.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, the Functional Core is just a single function call. If we inlined all of that code, too, the picture might rather look like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/impure-pure-impure-sandwich-box.png&quot; alt=&quot;A box with a thin red slice on top, a thick green middle, and a thin red slice at the bottom.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This obviously depends on the de-facto ratio of pure to imperative code. In any case, inlining the pure code is a thought experiment only, because the whole point of functional architecture is that &lt;a href=&quot;/2021/07/28/referential-transparency-fits-in-your-head&quot;&gt;a referentially transparent function fits in your head&lt;/a&gt;. Regardless of the complexity and amount of code hiding behind that &lt;code&gt;MaitreD.WillAccept&lt;/code&gt; function, the return value is &lt;em&gt;equal&lt;/em&gt; to the function call. It&apos;s the ultimate abstraction.
    &lt;/p&gt;
    &lt;h3 id=&quot;f3019f4107254a82b4280753cbbfab5f&quot;&gt;
        Standard combinators &lt;a href=&quot;#f3019f4107254a82b4280753cbbfab5f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As I&apos;ve already suggested, the inlined &lt;code&gt;Put&lt;/code&gt; method looks like a Transaction Script. The &lt;a href=&quot;https://en.wikipedia.org/wiki/Cyclomatic_complexity&quot;&gt;cyclomatic complexity&lt;/a&gt; fortunately hovers on &lt;a href=&quot;https://en.wikipedia.org/wiki/The_Magical_Number_Seven,_Plus_or_Minus_Two&quot;&gt;the magical number seven&lt;/a&gt;, and branching is exclusively organized around &lt;a href=&quot;https://en.wikipedia.org/wiki/Guard_(computer_science)&quot;&gt;Guard Clauses&lt;/a&gt;. Apart from that, there are no nested &lt;code&gt;if&lt;/code&gt; statements or &lt;code&gt;for&lt;/code&gt; loops.
    &lt;/p&gt;
    &lt;p&gt;
        Apart from the Guard Clauses, this mostly looks like a procedure that runs in a straight line from top to bottom. The exception is all those small conditionals that may cause the procedure to exit prematurely. Conditions like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;TryParse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;out&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rid&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;();&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        or
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BadRequestResult&lt;/span&gt;();&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Such checks occur throughout the method. Each of them are actually small pure islands amidst all the imperative code, but each is ad hoc. Each checks if it&apos;s possible for the procedure to continue, and returns a kind of error value if it decides that it&apos;s not.
    &lt;/p&gt;
    &lt;p&gt;
        Is there a way to model such &apos;derailments&apos; from the main flow?
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;ve ever encountered Scott Wlaschin&apos;s &lt;a href=&quot;https://fsharpforfunandprofit.com/rop/&quot;&gt;Railway Oriented Programming&lt;/a&gt; you may already see where this is going. Railway-oriented programming is a fantastic metaphor, because it gives you a way to visualize that you have, indeed, a main track, but then you have a side track that you may shuffle some trains too. And once the train is on the side track, it can&apos;t go back to the main track.
    &lt;/p&gt;
    &lt;p&gt;
        That&apos;s how the &lt;a href=&quot;/2022/05/09/an-either-monad&quot;&gt;Either monad&lt;/a&gt; works. Instead of all those ad-hoc &lt;code&gt;if&lt;/code&gt; statements, we should be able to replace them with what we may call &lt;em&gt;standard combinators&lt;/em&gt;. The most important of these combinators is &lt;a href=&quot;/2022/03/28/monads&quot;&gt;monadic bind&lt;/a&gt;. Composing a Transaction Script like &lt;code&gt;Put&lt;/code&gt; with standard combinators will &apos;hide away&apos; those small decisions, and make the Sandwich nature more apparent.
    &lt;/p&gt;
    &lt;p&gt;
        If we had had pure code, we could just have composed Either-valued functions. Unfortunately, most of what&apos;s going on in the &lt;code&gt;Put&lt;/code&gt; method happens in a Task-based context. Thankfully, Either is one of those monads that nest well, implying that we can &lt;a href=&quot;/2024/11/25/nested-monads&quot;&gt;turn the combination into a composed TaskEither monad&lt;/a&gt;. The linked article shows the core &lt;code&gt;TaskEither&lt;/code&gt; &lt;code&gt;SelectMany&lt;/code&gt; implementations.
    &lt;/p&gt;
    &lt;p&gt;
        The way to encode all those small decisions between &apos;main track&apos; or &apos;side track&apos;, then, is to wrap &apos;naked&apos; values in the desired &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;/code&gt; &lt;a href=&quot;https://bartoszmilewski.com/2014/01/14/functors-are-containers/&quot;&gt;container&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryParseGuid&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;()))&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This little code snippet makes use of a few small building blocks that we also need to introduce. First, .NET&apos;s standard &lt;code&gt;TryParse&lt;/code&gt; APIs don&apos;t, compose, but since &lt;a href=&quot;/2019/07/15/tester-doer-isomorphisms&quot;&gt;they&apos;re isomorphic to Maybe-valued functions&lt;/a&gt;, you can write an adapter like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;?&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;TryParseGuid&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;candidate&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;TryParse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;candidate&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;out&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;guid&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;guid&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;else&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In this code base, I treat &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/nullable-reference-types&quot;&gt;nullable reference types&lt;/a&gt; as equivalent to the &lt;a href=&quot;/2022/04/25/the-maybe-monad&quot;&gt;Maybe monad&lt;/a&gt;, but if your language doesn&apos;t have that feature, you can use Maybe instead.
    &lt;/p&gt;
    &lt;p&gt;
        To implement the &lt;code&gt;Put&lt;/code&gt; method, however, we don&apos;t want nullable (or Maybe) values. We need Either values, so we may introduce a &lt;a href=&quot;/2022/07/18/natural-transformations&quot;&gt;natural transformation&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;?&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;candidate&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;left&lt;/span&gt;)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;struct&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;candidate&lt;/span&gt;.HasValue)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Right&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;candidate&lt;/span&gt;.Value);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Left&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;left&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; one might just make use of the &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Maybe.html#v:maybe&quot;&gt;built-in&lt;/a&gt; &lt;a href=&quot;/2019/05/20/maybe-catamorphism&quot;&gt;Maybe catamorphism&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; maybe (Left &quot;boo!&quot;) Right $ Just 123
Right 123
ghci&amp;gt; maybe (Left &quot;boo!&quot;) Right $ Nothing
Left &quot;boo!&quot;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Such conversions from &lt;code&gt;Maybe&lt;/code&gt; to &lt;code&gt;Either&lt;/code&gt; hover just around the &lt;a href=&quot;https://wiki.haskell.org/Fairbairn_threshold&quot;&gt;Fairbairn threshold&lt;/a&gt;, but since we are going to need it more than once, it makes sense to add a specialized &lt;code&gt;OnNull&lt;/code&gt; transformation to the C# code base. The one shown here handles &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/nullable-value-types&quot;&gt;nullable value types&lt;/a&gt;, but the code base also includes an overload that handles nullable reference types. It&apos;s almost identical.
    &lt;/p&gt;
    &lt;h3 id=&quot;f158fc8250db4f07b1419a044fe23f91&quot;&gt;
        Support for query syntax &lt;a href=&quot;#f158fc8250db4f07b1419a044fe23f91&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        There&apos;s more than one way to consume monadic values in C#. While many C# developers like &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/linq/&quot;&gt;LINQ&lt;/a&gt;, most seem to prefer the familiar &lt;em&gt;method call syntax&lt;/em&gt;; that is, just call the &lt;code&gt;Select&lt;/code&gt;, &lt;code&gt;SelectMany&lt;/code&gt;, and &lt;code&gt;Where&lt;/code&gt; methods as the normal &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/programming-guide/classes-and-structs/extension-methods&quot;&gt;extension methods&lt;/a&gt; they are. Another option, however, is to use &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/linq/get-started/query-expression-basics&quot;&gt;query syntax&lt;/a&gt;. This is what I&apos;m aiming for here, since it&apos;ll make it easier to spot the Impureim Sandwich.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ll see the entire sandwich later in the article. Before that, I&apos;ll highlight details and explain how to implement them. You can always scroll down to see the end result, and then scroll back here, if that&apos;s more to your liking.
    &lt;/p&gt;
    &lt;p&gt;
        The sandwich starts by parsing the &lt;code&gt;id&lt;/code&gt; into a &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.guid&quot;&gt;GUID&lt;/a&gt; using the above building blocks:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;sandwich&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;rid&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryParseGuid&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;()))&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It then immediately proceeds to &lt;code&gt;Validate&lt;/code&gt; (&lt;a href=&quot;https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/&quot;&gt;parse&lt;/a&gt;, really) the &lt;code&gt;dto&lt;/code&gt; into a proper Domain Model:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservation&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Validate&lt;/span&gt;(rid).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BadRequestResult&lt;/span&gt;())&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that the second &lt;code&gt;from&lt;/code&gt; expression doesn&apos;t wrap the result with &lt;code&gt;Task.FromResult&lt;/code&gt;. How does that work? Is the return value of &lt;code&gt;dto.Validate&lt;/code&gt; already a &lt;code&gt;Task&lt;/code&gt;? No, this works because I added &apos;degenerate&apos; &lt;code&gt;SelectMany&lt;/code&gt; overloads:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;)));
}
 
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;k&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;k&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;)));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that the &lt;code&gt;selector&lt;/code&gt; only produces an &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&lt;/code&gt; value, rather than &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;. This allows query syntax to &apos;pick up&apos; the previous value (&lt;code&gt;rid&lt;/code&gt;, which is &apos;really&apos; a &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;) and continue with a function that doesn&apos;t produce a &lt;code&gt;Task&lt;/code&gt;, but rather just an &lt;code&gt;Either&lt;/code&gt; value. The first of these two overloads then wraps that &lt;code&gt;Either&lt;/code&gt; value and wraps it with &lt;code&gt;Task.FromResult&lt;/code&gt;. The second overload is just the usual &lt;a href=&quot;/2019/12/16/zone-of-ceremony&quot;&gt;ceremony&lt;/a&gt; that enables query syntax.
    &lt;/p&gt;
    &lt;p&gt;
        Why, then, doesn&apos;t the &lt;code&gt;sandwich&lt;/code&gt; use the same trick for &lt;code&gt;rid&lt;/code&gt;? Why does it explicitly call &lt;code&gt;Task.FromResult&lt;/code&gt;?
    &lt;/p&gt;
    &lt;p&gt;
        As far as I can tell, this is because of type inference. It looks as though the C# compiler infers the monad&apos;s type from the first expression. If I change the first expression to
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;rid&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryParseGuid&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;())&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        the compiler thinks that the query expression is based on &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&lt;/code&gt;, rather than &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;. This means that once we run into the first &lt;code&gt;Task&lt;/code&gt; value, the entire expression no longer works.
    &lt;/p&gt;
    &lt;p&gt;
        By explicitly wrapping the first expression in a &lt;code&gt;Task&lt;/code&gt;, the compiler correctly infers the monad we&apos;d like it to. If there&apos;s a more elegant way to do this, I&apos;m not aware of it.
    &lt;/p&gt;
    &lt;h3 id=&quot;066473b442cc4dd4904b43dccd257fa4&quot;&gt;
        Values that don&apos;t fail &lt;a href=&quot;#066473b442cc4dd4904b43dccd257fa4&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The sandwich proceeds to query various databases, using the now-familiar &lt;code&gt;OnNull&lt;/code&gt; combinators to transform nullable values to &lt;code&gt;Either&lt;/code&gt; values.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;restaurant&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;RestaurantDatabase
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRestaurant&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;())
&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;existing&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation.Id)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;())&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This works like before because both &lt;code&gt;GetRestaurant&lt;/code&gt; and &lt;code&gt;ReadReservation&lt;/code&gt; are queries that may fail to return a value. Here&apos;s the interface definition of &lt;code&gt;ReadReservation&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;?&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice the question mark that indicates that the result may be &lt;code&gt;null&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;GetRestaurant&lt;/code&gt; method is similar.
    &lt;/p&gt;
    &lt;p&gt;
        The next query that the sandwich has to perform, however, is different. The return type of the &lt;code&gt;ReadReservations&lt;/code&gt; method is &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;. Notice that the type contained in the &lt;code&gt;Task&lt;/code&gt; is &lt;em&gt;not&lt;/em&gt; nullable. Barring database connection errors, this query &lt;a href=&quot;/2024/01/29/error-categories-and-category-errors&quot;&gt;can&apos;t fail&lt;/a&gt;. If it finds no data, it returns an empty collection.
    &lt;/p&gt;
    &lt;p&gt;
        Since the value isn&apos;t nullable, we can&apos;t use &lt;code&gt;OnNull&lt;/code&gt; to turn it into a &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; value. We could try to use the &lt;code&gt;Right&lt;/code&gt; creation function for that.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Right&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Right&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This works, but is awkward:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservations&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation.At)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Right&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;))&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The problem with calling &lt;code&gt;Either.Right&lt;/code&gt; is that while the compiler can infer which type to use for &lt;code&gt;R&lt;/code&gt;, it doesn&apos;t know what the &lt;code&gt;L&lt;/code&gt; type is. Thus, we have to tell it, and we can&apos;t tell it what &lt;code&gt;L&lt;/code&gt; is without &lt;em&gt;also&lt;/em&gt; telling it what &lt;code&gt;R&lt;/code&gt; is. Even though it already knows that.
    &lt;/p&gt;
    &lt;p&gt;
        In such scenarios, the &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; compiler can usually figure it out, and &lt;a href=&quot;https://en.wikipedia.org/wiki/Glasgow_Haskell_Compiler&quot;&gt;GHC&lt;/a&gt; always can (unless you add some exotic language extensions to your code). C# doesn&apos;t have any syntax that enables you to tell the compiler about only the type that it doesn&apos;t know about, and let it infer the rest.
    &lt;/p&gt;
    &lt;p&gt;
        All is not lost, though, because there&apos;s a little trick you can use in cases such as this. You &lt;em&gt;can&lt;/em&gt; let the C# compiler infer the &lt;code&gt;R&lt;/code&gt; type so that you only have to tell it what &lt;code&gt;L&lt;/code&gt; is. It&apos;s a two-stage process. First, define an extension method on &lt;code&gt;R&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RightBuilder&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;ToRight&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RightBuilder&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The only type argument on this &lt;code&gt;ToRight&lt;/code&gt; method is &lt;code&gt;R&lt;/code&gt;, and since the &lt;code&gt;right&lt;/code&gt; parameter is of the type &lt;code&gt;R&lt;/code&gt;, the C# compiler can always infer the type of &lt;code&gt;R&lt;/code&gt; from the type of &lt;code&gt;right&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        What&apos;s &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;RightBuilder&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&lt;/code&gt;? It&apos;s this little auxiliary class:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RightBuilder&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;nbsp;right;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RightBuilder&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;.right&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;right&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithLeft&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;&amp;gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Right&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;(right);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The code base for &lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt; was written on .NET 3.1, but today you could have made this a &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/record&quot;&gt;record&lt;/a&gt; instead. The only purpose of this class is to break the type inference into two steps so that the &lt;code&gt;R&lt;/code&gt; type can be automatically inferred. In this way, you only need to tell the compiler what the &lt;code&gt;L&lt;/code&gt; type is.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservations&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation.At)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToRight&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithLeft&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;())&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As indicated, this style of programming isn&apos;t language-neutral. Even if you find this little trick neat, I&apos;d much rather have the compiler just figure it out for me. The entire &lt;code&gt;sandwich&lt;/code&gt; query expression is already defined as working with &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;, and the &lt;code&gt;L&lt;/code&gt; type can&apos;t change like the &lt;code&gt;R&lt;/code&gt; type can. Functional compilers can figure this out, and while I intend this article to show object-oriented programmers how functional programming sometimes work, I don&apos;t wish to pretend that it&apos;s a good idea to write code like this in C#. I&apos;ve &lt;a href=&quot;/2019/03/18/the-programmer-as-decision-maker&quot;&gt;covered that ground already&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Not surprisingly, there&apos;s a mirror-image &lt;code&gt;ToLeft&lt;/code&gt;/&lt;code&gt;WithRight&lt;/code&gt; combo, too.
    &lt;/p&gt;
    &lt;h3 id=&quot;8628f41e4a8d4c6e8d282c5a64ad1c44&quot;&gt;
        Working with Commands &lt;a href=&quot;#8628f41e4a8d4c6e8d282c5a64ad1c44&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The ultimate goal with the &lt;code&gt;Put&lt;/code&gt; method is to modify a row in the database. The method to do that has this interface definition:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Update&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I usually call that non-generic &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.threading.tasks.task&quot;&gt;Task&lt;/a&gt; class for &apos;asynchronous &lt;code&gt;void&lt;/code&gt;&apos; when explaining it to non-C# programmers. The &lt;code&gt;Update&lt;/code&gt; method is an asynchronous &lt;a href=&quot;https://en.wikipedia.org/wiki/Command%E2%80%93query_separation&quot;&gt;Command&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;code&gt;Task&lt;/code&gt; and &lt;code&gt;void&lt;/code&gt; aren&apos;t legal values for use with LINQ query syntax, so you have to find a way to work around that limitation. In this case I defined a local helper method to make it look like a Query:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;RunUpdate&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TransactionScope&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Update&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Complete&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It just echoes back the &lt;code&gt;reservation&lt;/code&gt; parameter once the &lt;code&gt;Update&lt;/code&gt; has completed. This makes it composable in the larger query expression.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ll probably not be surprised when I tell you that both F# and Haskell handle this scenario gracefully, without requiring any hoop-jumping.
    &lt;/p&gt;
    &lt;h3 id=&quot;d7c6feabfcb74e2eb5174a9ad3dd9c7f&quot;&gt;
        Full sandwich &lt;a href=&quot;#d7c6feabfcb74e2eb5174a9ad3dd9c7f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Those are all the building block. Here&apos;s the full &lt;code&gt;sandwich&lt;/code&gt; definition, colour-coded like the examples in &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim sandwich&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkObjectResult&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;sandwich&lt;/span&gt;&amp;nbsp;=
&lt;span style=&quot;background-color: palegreen;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;rid&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryParseGuid&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;()))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservation&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Validate&lt;/span&gt;(rid).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BadRequestResult&lt;/span&gt;())&lt;/span&gt;
 
&lt;span style=&quot;background-color: lightsalmon;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;restaurant&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;RestaurantDatabase
    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRestaurant&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;existing&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation.Id)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OnNull&lt;/span&gt;((&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;)&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFoundResult&lt;/span&gt;())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservations&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation.At)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToRight&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithLeft&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;now&amp;nbsp;=&amp;nbsp;Clock.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetCurrentDateTime&lt;/span&gt;()&lt;/span&gt;
 
&lt;span style=&quot;background-color: palegreen;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;reservations2&amp;nbsp;=
    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reservations.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Where&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;.Id&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;!=&lt;/span&gt;&amp;nbsp;reservation.Id)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;ok&amp;nbsp;=&amp;nbsp;restaurant.MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;now,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reservations2,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;reservation)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservation2&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ok&amp;nbsp;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;?&amp;nbsp;reservation.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToRight&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithLeft&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToLeft&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithRight&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;()&lt;/span&gt;
 
&lt;span style=&quot;background-color: lightsalmon;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;reservation3&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;RunUpdate&lt;/span&gt;(restaurant.Id,&amp;nbsp;reservation2,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToRight&lt;/span&gt;().&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithLeft&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;())&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;select&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkObjectResult&lt;/span&gt;(reservation3.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToDto&lt;/span&gt;());&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As is evident from the colour-coding, this isn&apos;t quite a sandwich. The structure is honestly more accurately depicted like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/pure-impure-pure-impure-box.png&quot; alt=&quot;A box with green, red, green, and red horizontal tiers.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve previously argued, &lt;a href=&quot;/2023/10/09/whats-a-sandwich&quot;&gt;while the metaphor becomes strained, this still works well as a functional-programming architecture&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        As defined here, the &lt;code&gt;sandwich&lt;/code&gt; value is a &lt;code&gt;Task&lt;/code&gt; that must be awaited.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkObjectResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;either&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;sandwich&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;either&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        By awaiting the task, we get an &lt;code&gt;Either&lt;/code&gt; value. The &lt;code&gt;Put&lt;/code&gt; method, on the other hand, must return an &lt;code&gt;ActionResult&lt;/code&gt;. How do you turn an &lt;code&gt;Either&lt;/code&gt; object into a single object?
    &lt;/p&gt;
    &lt;p&gt;
        By pattern matching on it, as the code snippet shows. The &lt;code&gt;L&lt;/code&gt; type is already an &lt;code&gt;ActionResult&lt;/code&gt;, so we return it without changing it. If C# had had a built-in identity function, I&apos;d used that, but idiomatically, we instead use the &lt;code&gt;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&lt;/code&gt; lambda expression.
    &lt;/p&gt;
    &lt;p&gt;
        The same is the case for the &lt;code&gt;R&lt;/code&gt; type, because &lt;code&gt;OkObjectResult&lt;/code&gt; inherits from &lt;code&gt;ActionResult&lt;/code&gt;. The identity expression automatically performs the type conversion for us.
    &lt;/p&gt;
    &lt;p&gt;
        This, by the way, is a recurring pattern with Either values that I run into in all languages. You&apos;ve essentially computed an &lt;code&gt;Either&amp;lt;T, T&amp;gt;&lt;/code&gt;, with the same type on both sides, and now you just want to return whichever &lt;code&gt;T&lt;/code&gt; value is contained in the Either value. You&apos;d think this is such a common pattern that Haskell has a nice abstraction for it, but &lt;a href=&quot;https://hoogle.haskell.org/?hoogle=Either%20a%20a%20-%3E%20a&quot;&gt;even Hoogle fails to suggest a commonly-accepted function that does this&lt;/a&gt;. Apparently, &lt;code&gt;either id id&lt;/code&gt; is considered below the Fairbairn threshold, too.
    &lt;/p&gt;
    &lt;h3 id=&quot;fc8f5dd20a494cc297a55ce57c865212&quot;&gt;
        Conclusion &lt;a href=&quot;#fc8f5dd20a494cc297a55ce57c865212&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        This article presents an example of a non-trivial Impureim Sandwich. When I introduced the pattern, I gave a few examples. I&apos;d deliberately chosen these examples to be simple so that they highlighted the structure of the idea. The downside of that didactic choice is that some commenters found the examples too simplistic. Therefore, I think that there&apos;s value in going through more complex examples.
    &lt;/p&gt;
    &lt;p&gt;
        The code base that accompanies &lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt; is complex enough that it borders on the realistic. It was deliberately written that way, and since I assume that the code base is familiar to readers of the book, I thought it&apos;d be a good resource to show how an Impureim Sandwich might look. I explicitly chose to refactor the &lt;code&gt;Put&lt;/code&gt; method, since it&apos;s easily the most complicated process in the code base.
    &lt;/p&gt;
    &lt;p&gt;
        The benefit of that code base is that it&apos;s written in a programming language that reach a large audience. Thus, for the reader curious about functional programming I thought that this could also be a useful introduction to some intermediate concepts.
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve commented along the way, however, I wouldn&apos;t expect anyone to write production C# code like this. If you&apos;re able to do this, you&apos;re also able to do it in a language better suited for this programming paradigm.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/12/16/a-restaurant-sandwich</guid>
      </item>
    
      <item>
        <title>Implementation and usage mindsets</title>
        <link>https://blog.ploeh.dk/2024/12/09/implementation-and-usage-mindsets/</link>
        <pubDate>Mon, 09 Dec 2024 21:45:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A one-dimensional take on the enduring static-versus-dynamic debate.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It recently occurred to me that one possible explanation for the standing, and probably never-ending, debate about static versus dynamic types may be that each camp have disjoint perspectives on the kinds of problems their favourite languages help them solve. In short, my hypothesis is that perhaps lovers of dynamically-typed languages often approach a problem from an implementation mindset, whereas proponents of static types emphasize usage.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/implementation-versus-usage.png&quot; alt=&quot;A question mark in the middle. An arrow from left labelled &apos;implementation&apos; points to the question mark from a figure indicating a person. Another arrow from the right labelled &apos;usage&apos; points to the question mark from another figure indicating a person.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll expand on this idea here, and then provide examples in two subsequent articles.
    &lt;/p&gt;
    &lt;h3 id=&quot;d748f29ae31543fbb6db537711800c62&quot;&gt;
        Background &lt;a href=&quot;#d748f29ae31543fbb6db537711800c62&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        For years I&apos;ve struggled to understand &apos;the other side&apos;. While I&apos;m firmly in the statically typed camp, I realize that many highly skilled programmers and thought leaders enjoy, or get great use out of, dynamically typed languages. This worries me, because it &lt;a href=&quot;/2021/08/09/am-i-stuck-in-a-local-maximum&quot;&gt;might indicate that I&apos;m stuck in a local maximum&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In other words, just because I, personally, prefer static types, it doesn&apos;t follow that static types are universally better than dynamic types.
    &lt;/p&gt;
    &lt;p&gt;
        In reality, it&apos;s probably rather the case that we&apos;re dealing with a false dichotomy, and that the problem is really multi-dimensional.
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;Let me stop you right there: I don&apos;t think there is a real dynamic typing versus static typing debate.
        &lt;/p&gt;
        &lt;p&gt;
            &quot;What such debates normally are is language X vs language Y debates (where X happens to be dynamic and Y happens to be static).&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;https://twitter.com/KevlinHenney/status/1425513161252278280&quot;&gt;Kevlin Henney&lt;/a&gt;&lt;/cite&gt;&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        Even so, I can&apos;t help thinking about such things. Am I missing something?
    &lt;/p&gt;
    &lt;p&gt;
        For the past few years, I&apos;ve dabbled with &lt;a href=&quot;https://www.python.org/&quot;&gt;Python&lt;/a&gt; to see what writing in a popular dynamically typed language is like. It&apos;s not a bad language, and I can clearly see how it&apos;s attractive. Even so, I&apos;m still frustrated every time I return to some Python code after a few weeks or more. The lack of static types makes it hard for me to pick up, or revisit, old code.
    &lt;/p&gt;
    &lt;h3 id=&quot;8b6d87e0536d40b6aaec28d8e6356553&quot;&gt;
        A question of perspective? &lt;a href=&quot;#8b6d87e0536d40b6aaec28d8e6356553&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Whenever I run into a difference of opinion, I often interpret it as a difference in perspective. Perhaps it&apos;s my academic background as an economist, but I consider it a given that people have different motivations, and that incentives influence actions.
    &lt;/p&gt;
    &lt;p&gt;
        A related kind of analysis deals with problem definitions. Are we even trying to solve the same problem?
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ve &lt;a href=&quot;/2021/08/09/am-i-stuck-in-a-local-maximum&quot;&gt;discussed such questions before, but in a different context&lt;/a&gt;. Here, it strikes me that perhaps programmers who gravitate toward dynamically typed languages are focused on another problem than the other group.
    &lt;/p&gt;
    &lt;p&gt;
        Again, I&apos;d like to emphasize that I don&apos;t consider the world so black and white in reality. Some developers straddle the two camps, and as the above Kevlin Henney quote suggests, there really aren&apos;t only two kinds of languages. &lt;a href=&quot;https://en.wikipedia.org/wiki/C_(programming_language)&quot;&gt;C&lt;/a&gt; and &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; are both statically typed, but the similarities stop there. Likewise, I don&apos;t know if it&apos;s fair to put JavaScript and &lt;a href=&quot;https://clojure.org/&quot;&gt;Clojure&lt;/a&gt; in the same bucket.
    &lt;/p&gt;
    &lt;p&gt;
        That said, I&apos;d still like to offer the following hypothesis, in the spirit that although &lt;a href=&quot;https://en.wikipedia.org/wiki/All_models_are_wrong&quot;&gt;all models are wrong&lt;/a&gt;, some are useful.
    &lt;/p&gt;
    &lt;p&gt;
        The idea is that if you&apos;re trying to solve a problem related to &lt;em&gt;implementation&lt;/em&gt;, dynamically typed languages may be more suitable. If you&apos;re trying to implement an algorithm, or even trying to invent one, a dynamic language seems useful. One year, I did a good chunk of &lt;a href=&quot;https://adventofcode.com/&quot;&gt;Advent of Code&lt;/a&gt; in Python, and didn&apos;t find it harder than in Haskell. (I ultimately ran out of steam for reasons unrelated to Python.)
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, if your main focus may be &lt;em&gt;usage&lt;/em&gt; of your code, perhaps you&apos;ll find a statically typed language more useful. At least, I do. I can use the static type system to communicate how my APIs work. How to instantiate my classes. How to call my functions. How return values are shaped. In other words, the preconditions, invariants, and postconditions of my reusable code: &lt;a href=&quot;/encapsulation-and-solid/&quot;&gt;Encapsulation&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;f0cbf02e11484e9a8c8d0fab9a6463f2&quot;&gt;
        Examples &lt;a href=&quot;#f0cbf02e11484e9a8c8d0fab9a6463f2&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Some examples may be in order. In the next two articles, I&apos;ll first examine how easy it is to implement an algorithm in various programming languages. Then I&apos;ll discuss how to encapsulate that algorithm.
    &lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href=&quot;/2024/12/23/implementing-rod-cutting&quot;&gt;Implementing rod-cutting&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;Encapsulating rod-cutting&lt;/li&gt;
    &lt;/ul&gt;
    &lt;p&gt;
        The articles will both discuss the rod-cutting problem from &lt;a href=&quot;/ref/clrs&quot;&gt;Introduction to Algorithms&lt;/a&gt;, but I&apos;ll introduce the problem in the next article.
    &lt;/p&gt;
    &lt;h3 id=&quot;97b3e722024b4228924faa2d6ff5d188&quot;&gt;
        Conclusion &lt;a href=&quot;#97b3e722024b4228924faa2d6ff5d188&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I&apos;d be naive if I believed that a single model can fully explain why some people prefer dynamically typed languages, and others rather like statically typed languages. Even so, suggesting a model helps me understand how to analyze problems.
    &lt;/p&gt;
    &lt;p&gt;
        My hypothesis is that dynamically typed languages may be suitable for implementing algorithms, whereas statically typed languages offer better encapsulation.
    &lt;/p&gt;
    &lt;p&gt;
        This may be used as a heuristic for &apos;picking the right tool for the job&apos;. If I need to suss out an algorithm, perhaps I should do it in Python. If, on the other hand, I need to publish a reusable library, perhaps Haskell is a better choice.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2024/12/23/implementing-rod-cutting&quot;&gt;Implementing rod-cutting&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/12/09/implementation-and-usage-mindsets</guid>
      </item>
    
      <item>
        <title>Short-circuiting an asynchronous traversal</title>
        <link>https://blog.ploeh.dk/2024/12/02/short-circuiting-an-asynchronous-traversal/</link>
        <pubDate>Mon, 02 Dec 2024 09:32:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Another C# example.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is a continuation of &lt;a href=&quot;/2024/11/18/collecting-and-handling-result-values&quot;&gt;an earlier post&lt;/a&gt; about refactoring a piece of imperative code to a &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt;. It all started with &lt;a href=&quot;https://stackoverflow.com/q/79112836/126014&quot;&gt;a Stack Overflow question&lt;/a&gt;, but read the previous article, and you&apos;ll be up to speed.
    &lt;/p&gt;
    &lt;h3 id=&quot;2bf66b90d3ba4dfe980538175b647070&quot;&gt;
        Imperative outset &lt;a href=&quot;#2bf66b90d3ba4dfe980538175b647070&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To begin, consider this mostly imperative code snippet:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;();
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;();
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;&amp;nbsp;=&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;,&amp;nbsp;hasError:&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;updateResult&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;updateResult&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;&amp;lt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;)&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;);&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;&amp;nbsp;},
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;);&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;},
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.hasError&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.hasError)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Results&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;BadRequest&lt;/span&gt;();
}
 
&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SaveChangesAsync&lt;/span&gt;();
 
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Results&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Ok&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;([..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;],&amp;nbsp;[..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;]));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll recap a few points from the previous article. Apart from one crucial detail, it&apos;s similar to the other post. One has to infer most of the types and APIs, since the original post didn&apos;t show more code than that. If you&apos;re used to engaging with Stack Overflow questions, however, it&apos;s not too hard to figure out what most of the moving parts do.
    &lt;/p&gt;
    &lt;p&gt;
        The most non-obvious detail is that the code uses a library called &lt;a href=&quot;https://github.com/mcintyre321/OneOf/&quot;&gt;OneOf&lt;/a&gt;, which supplies general-purpose, but rather abstract, sum types. Both the container type &lt;code&gt;OneOf&lt;/code&gt;, as well as the two indicator types &lt;code&gt;NotFound&lt;/code&gt; and &lt;code&gt;Error&lt;/code&gt; are defined in that library.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;Match&lt;/code&gt; method implements standard &lt;a href=&quot;/2018/05/22/church-encoding&quot;&gt;Church encoding&lt;/a&gt;, which enables the code to pattern-match on the three alternative values that &lt;code&gt;UpdateItem&lt;/code&gt; returns.
    &lt;/p&gt;
    &lt;p&gt;
        One more detail also warrants an explicit description: The &lt;code&gt;itemsToUpdate&lt;/code&gt; object is an input argument of the type &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The major difference from before is that now the update process short-circuits on the first &lt;code&gt;Error&lt;/code&gt;. If an error occurs, it stops processing the rest of the items. In that case, it now returns &lt;code&gt;Results.BadRequest()&lt;/code&gt;, and it &lt;em&gt;doesn&apos;t&lt;/em&gt; save the changes to &lt;code&gt;dbContext&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The implementation makes use of mutable state and undisciplined I/O. How do you refactor it to a more functional design?
    &lt;/p&gt;
    &lt;h3 id=&quot;d5b47b3ebb0345ea9b1d2879755bec12&quot;&gt;
        Short-circuiting traversal &lt;a href=&quot;#d5b47b3ebb0345ea9b1d2879755bec12&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;The standard Traverse function&lt;/a&gt; isn&apos;t lazy, or rather, it does consume the entire input sequence. Even various &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; data structures I investigated do that. And yes, I even tried to &lt;code&gt;traverse&lt;/code&gt; &lt;a href=&quot;https://hackage.haskell.org/package/list-t/docs/ListT.html&quot;&gt;ListT&lt;/a&gt;. If there&apos;s a data structure that you can &lt;code&gt;traverse&lt;/code&gt; with deferred execution of I/O-bound actions, I&apos;m not aware of it.
    &lt;/p&gt;
    &lt;p&gt;
        That said, all is not lost, but you&apos;ll need to implement a more specialized traversal. While consuming the input sequence, the function needs to know when to stop. It can&apos;t do that on just any &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.collections.generic.ienumerable-1&quot;&gt;IEnumerable&amp;lt;T&amp;gt;&lt;/a&gt;, because it has no information about &lt;code&gt;T&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If, on the other hand, you specialize the traversal to a sequence of items with more information, you can stop processing if it encounters a particular condition. You could generalize this to, say, &lt;code&gt;IEnumerable&amp;lt;Either&amp;lt;L, R&amp;gt;&amp;gt;&lt;/code&gt;, but since I already have the OneOf library in scope, I&apos;ll use that, instead of implementing or pulling in a general-purpose &lt;a href=&quot;/2018/06/11/church-encoded-either&quot;&gt;Either&lt;/a&gt; data type.
    &lt;/p&gt;
    &lt;p&gt;
        In fact, I&apos;ll just use a three-way &lt;code&gt;OneOf&lt;/code&gt; type compatible with the one that &lt;code&gt;UpdateItem&lt;/code&gt; returns.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Sequence&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;tasks&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;tasks&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.IsT2)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;break&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This implementation doesn&apos;t care what &lt;code&gt;T1&lt;/code&gt; or &lt;code&gt;T2&lt;/code&gt; is, so they&apos;re free to be &lt;code&gt;ShoppingListItem&lt;/code&gt; and &lt;code&gt;NotFound&lt;/code&gt;. The third type argument, on the other hand, must be &lt;code&gt;Error&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;if&lt;/code&gt; conditional looks a bit odd, but as I wrote, the types that ship with the OneOf library have rather abstract APIs. A three-way &lt;code&gt;OneOf&lt;/code&gt; value comes with three case tests called &lt;code&gt;IsT0&lt;/code&gt;, &lt;code&gt;IsT1&lt;/code&gt;, and &lt;code&gt;IsT2&lt;/code&gt;. Notice that the library uses a zero-indexed naming convention for its type parameters. &lt;code&gt;IsT2&lt;/code&gt; returns &lt;code&gt;true&lt;/code&gt; if the value is the &lt;em&gt;third&lt;/em&gt; kind, in this case &lt;code&gt;Error&lt;/code&gt;. If a &lt;code&gt;task&lt;/code&gt; turns out to produce an &lt;code&gt;Error&lt;/code&gt;, the &lt;code&gt;Sequence&lt;/code&gt; method adds that one error, but then stops processing any remaining items.
    &lt;/p&gt;
    &lt;p&gt;
        Some readers may complain that the entire implementation of &lt;code&gt;Sequence&lt;/code&gt; is imperative. It hardly matters that much, since the mutation doesn&apos;t escape the method. The behaviour is as functional as it&apos;s possible to make it. It&apos;s fundamentally I/O-bound, so we can&apos;t consider it a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt;. That said, if we hypothetically imagine that all the &lt;code&gt;tasks&lt;/code&gt; are deterministic and have no side effects, the &lt;code&gt;Sequence&lt;/code&gt; function does become a pure function when viewed as a black box. From the outside, you can&apos;t tell that the implementation is imperative.
    &lt;/p&gt;
    &lt;p&gt;
        It &lt;em&gt;is&lt;/em&gt; possible to implement &lt;code&gt;Sequence&lt;/code&gt; in a proper functional style, and it might make &lt;a href=&quot;/2020/01/13/on-doing-katas&quot;&gt;a good exercise&lt;/a&gt;. I think, however, that it&apos;ll be difficult in C#. In &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; or Haskell I&apos;d use recursion, and while you &lt;em&gt;can&lt;/em&gt; do that in C#, I admit that I&apos;ve lost sight of whether or not &lt;a href=&quot;/2015/12/22/tail-recurse&quot;&gt;tail recursion&lt;/a&gt; is supported by the C# compiler.
    &lt;/p&gt;
    &lt;p&gt;
        Be that as it may, the traversal implementation doesn&apos;t change.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;items&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;items&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Sequence&lt;/span&gt;();
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You can now &lt;code&gt;Traverse&lt;/code&gt; the &lt;code&gt;itemsToUpdate&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As the &lt;code&gt;// Impure&lt;/code&gt; comment may suggest, this constitutes the first impure layer of an &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;e7d6b741e8e1406b9588a5788df0ff9b&quot;&gt;
        Aggregating the results &lt;a href=&quot;#e7d6b741e8e1406b9588a5788df0ff9b&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Since the above statement awaits the traversal, the &lt;code&gt;results&lt;/code&gt; object is a &apos;pure&apos; object that can be passed to a pure function. This does, however, assume that &lt;code&gt;ShoppingListItem&lt;/code&gt; is an immutable object.
    &lt;/p&gt;
    &lt;p&gt;
        The next step must collect results and &lt;code&gt;NotFound&lt;/code&gt;-related failures, but contrary to the previous article, it must short-circuit if it encounters an &lt;code&gt;Error&lt;/code&gt;. This again suggests an Either-like data structure, but again I&apos;ll repurpose a &lt;code&gt;OneOf&lt;/code&gt; container. I&apos;ll start by defining a &lt;code&gt;seed&lt;/code&gt; for an aggregation (a &lt;em&gt;left fold&lt;/em&gt;).
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;seed&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;),&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromT0&lt;/span&gt;(([],&amp;nbsp;[]));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This type can be either a tuple or an error. The .NET tendency is often to define an explicit &lt;code&gt;Result&amp;lt;TSuccess, TFailure&amp;gt;&lt;/code&gt; type, where &lt;code&gt;TSuccess&lt;/code&gt; is defined to the left of &lt;code&gt;TFailure&lt;/code&gt;. This, for example, is &lt;a href=&quot;https://learn.microsoft.com/dotnet/fsharp/language-reference/results&quot;&gt;how F# defines Result types&lt;/a&gt;, and other .NET libraries tend to emulate that design. That&apos;s also what I&apos;ve done here, although I admit that I&apos;m regularly confused when going back and forth between F# and Haskell, where the &lt;code&gt;Right&lt;/code&gt; case is &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatically&lt;/a&gt; considered to indicate success.
    &lt;/p&gt;
    &lt;p&gt;
        As already discussed, OneOf follows a zero-indexed naming convention for type parameters, so &lt;code&gt;FromT0&lt;/code&gt; indicates the first (or leftmost) case. The seed is thus initialized with a tuple that contains two empty sequences.
    &lt;/p&gt;
    &lt;p&gt;
        As in the previous article, you can now use the &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.linq.enumerable.aggregate&quot;&gt;Aggregate&lt;/a&gt; method to collect the result you want.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Aggregate&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;seed&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;MapT0&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item1.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Append&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item2)),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;MapT0&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item1,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item2.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Append&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;.Item))),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;e&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;e&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;MapT0&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item1.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;(),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;t&lt;/span&gt;.Item2.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;()));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This expression is a two-step composition. I&apos;ll get back to the concluding &lt;code&gt;MapT0&lt;/code&gt; in a moment, but let&apos;s first discuss what happens in the &lt;code&gt;Aggregate&lt;/code&gt; step. Since the &lt;code&gt;state&lt;/code&gt; is now a discriminated union, the big lambda expression not only has to &lt;code&gt;Match&lt;/code&gt; on the &lt;code&gt;result&lt;/code&gt;, but it also has to deal with the two mutually exclusive cases in which &lt;code&gt;state&lt;/code&gt; can be.
    &lt;/p&gt;
    &lt;p&gt;
        Although it comes third in the code listing, it may be easiest to explain if we start with the error case. Keep in mind that the &lt;code&gt;seed&lt;/code&gt; starts with the optimistic assumption that the operation is going to succeed. If, however, we encounter an error &lt;code&gt;e&lt;/code&gt;, we now switch the &lt;code&gt;state&lt;/code&gt; to the &lt;code&gt;Error&lt;/code&gt; case. Once in that state, it stays there.
    &lt;/p&gt;
    &lt;p&gt;
        The two other &lt;code&gt;result&lt;/code&gt; cases map over the first (i.e. the success) case, appending the result to the appropriate sequence in the tuple &lt;code&gt;t&lt;/code&gt;. Since these expressions map over the first (zero-indexed) case, these updates only run as long as the &lt;code&gt;state&lt;/code&gt; is in the success case. If the &lt;code&gt;state&lt;/code&gt; is in the error state, these lambda expressions don&apos;t run, and the &lt;code&gt;state&lt;/code&gt; doesn&apos;t change.
    &lt;/p&gt;
    &lt;p&gt;
        After having collected the tuple of sequences, the final step is to map over the success case, turning the tuple &lt;code&gt;t&lt;/code&gt; into a &lt;code&gt;BulkUpdateResult&lt;/code&gt;. That&apos;s what &lt;code&gt;MapT0&lt;/code&gt; does: It maps over the first (zero-indexed) case, which contains the tuple of sequences. It&apos;s a standard &lt;a href=&quot;/2018/03/22/functors&quot;&gt;functor&lt;/a&gt; projection.
    &lt;/p&gt;
    &lt;h3 id=&quot;e4c3b20a30c34b4785ccdd886b20d197&quot;&gt;
        Saving the changes and returning the results &lt;a href=&quot;#e4c3b20a30c34b4785ccdd886b20d197&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The final, impure step in the sandwich is to save the changes and return the results:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bulkUpdateResult&lt;/span&gt;&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SaveChangesAsync&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Results&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Ok&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bulkUpdateResult&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;},
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;_&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Results&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;BadRequest&lt;/span&gt;()));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Note that it only calls &lt;code&gt;dbContext.SaveChangesAsync()&lt;/code&gt; in case the &lt;code&gt;result&lt;/code&gt; is a success.
    &lt;/p&gt;
    &lt;h3 id=&quot;a6d28bd9d66a4e068bc4cd4ba21dde32&quot;&gt;
        Accumulating the bulk-update result &lt;a href=&quot;#a6d28bd9d66a4e068bc4cd4ba21dde32&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        So far, I&apos;ve assumed that the final &lt;code&gt;BulkUpdateResult&lt;/code&gt; class is just a simple immutable container without much functionality. If, however, we add some copy-and-update functions to it, we can use that to aggregate the result, instead of an anonymous tuple.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Store&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;([..&amp;nbsp;StoredItems,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;],&amp;nbsp;FailedItems);
 
&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Fail&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;(StoredItems,&amp;nbsp;[..&amp;nbsp;FailedItems,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;]);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I would have personally preferred the name &lt;code&gt;NotFound&lt;/code&gt; instead of &lt;code&gt;Fail&lt;/code&gt;, but I was going with the original post&apos;s &lt;code&gt;failedItems&lt;/code&gt; terminology, and I thought that it made more sense to call a method &lt;code&gt;Fail&lt;/code&gt; when it adds to a collection called &lt;code&gt;FailedItems&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Adding these two instance methods to &lt;code&gt;BulkUpdateResult&lt;/code&gt; simplifies the composing code:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Aggregate&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromT0&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;([],&amp;nbsp;[])),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;MapT0&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bur&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bur&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Store&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;)),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;MapT0&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bur&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;bur&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Fail&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;.Item)),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;e&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;e&lt;/span&gt;));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This variation starts with an empty &lt;code&gt;BulkUpdateResult&lt;/code&gt; and then uses &lt;code&gt;Store&lt;/code&gt; or &lt;code&gt;Fail&lt;/code&gt; as appropriate to update the state. The final, impure step of the sandwich remains the same.
    &lt;/p&gt;
    &lt;h3 id=&quot;ed88649e2d75403ab654fe7c034b6c1f&quot;&gt;
        Conclusion &lt;a href=&quot;#ed88649e2d75403ab654fe7c034b6c1f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        It&apos;s a bit more tricky to implement a short-circuiting traversal than the standard traversal. You can, still, implement a specialized &lt;code&gt;Sequence&lt;/code&gt; or &lt;code&gt;Traverse&lt;/code&gt; method, but it requires that the input stream carries enough information to decide when to stop processing more items. In this article, I used a specialized three-way union, but you could generalize this to use a standard Either or Result type.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/12/02/short-circuiting-an-asynchronous-traversal</guid>
      </item>
    
      <item>
        <title>Nested monads</title>
        <link>https://blog.ploeh.dk/2024/11/25/nested-monads/</link>
        <pubDate>Mon, 25 Nov 2024 07:31:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;You can stack some monads in such a way that the composition is also a monad.&lt;/em&gt;
    &lt;/p&gt;
	&lt;p&gt;
		This article is part of &lt;a href=&quot;/2022/07/11/functor-relationships&quot;&gt;a series of articles about functor relationships&lt;/a&gt;. In a previous article you learned that &lt;a href=&quot;/2024/10/28/functor-compositions&quot;&gt;nested functors form a functor&lt;/a&gt;. You may have wondered if &lt;a href=&quot;/2022/03/28/monads&quot;&gt;monads&lt;/a&gt; compose in the same way. Does a monad nested in a monad form a monad?
	&lt;/p&gt;
    &lt;p&gt;
        As far as I know, there&apos;s no universal rule like that, but some monads compose well. Fortunately, it&apos;s been my experience that the combinations that you need in practice are among those that exist and are well-known. In a &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; context, it&apos;s often the case that you need to run some kind of &apos;effect&apos; inside &lt;code&gt;IO&lt;/code&gt;. Perhaps you want to use &lt;code&gt;Maybe&lt;/code&gt; or &lt;code&gt;Either&lt;/code&gt; nested within &lt;code&gt;IO&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In .NET, you may run into a similar need to compose task-based programming with an effect. This happens more often in &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; than in C#, since F# comes with other native monads (&lt;code&gt;option&lt;/code&gt; and &lt;code&gt;Result&lt;/code&gt;, to name the most common).
    &lt;/p&gt;
    &lt;h3 id=&quot;d84f448d09124e31a8fbeb27abe3d826&quot;&gt;
        Abstract shape &lt;a href=&quot;#d84f448d09124e31a8fbeb27abe3d826&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        You&apos;ll see some real examples in a moment, but as usual it helps to outline what it is that we&apos;re looking for. Imagine that you have a monad. We&apos;ll call it &lt;code&gt;F&lt;/code&gt; in keeping with tradition. In this article series, you&apos;ve seen how two or more &lt;a href=&quot;/2018/03/22/functors&quot;&gt;functors&lt;/a&gt; compose. When discussing the abstract shapes of things, we&apos;ve typically called our two abstract functors &lt;code&gt;F&lt;/code&gt; and &lt;code&gt;G&lt;/code&gt;. I&apos;ll stick to that naming scheme here, because monads are functors (&lt;a href=&quot;/2022/03/28/monads&quot;&gt;that you can flatten&lt;/a&gt;).
    &lt;/p&gt;
    &lt;p&gt;
        Now imagine that you have a value that stacks two monads: &lt;code&gt;F&amp;lt;G&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;. If the inner monad &lt;code&gt;G&lt;/code&gt; is the &apos;right&apos; kind of monad, that configuration itself forms a monad.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/nested-monads-transformed-to-single-monad.png&quot; alt=&quot;Nested monads depicted as concentric circles. To the left the circle F contains the circle G that again contains the circle a. To the right the wider circle FG contains the circle that contains a. An arrow points from the left circles to the right circles.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In the diagram, I&apos;ve simply named the combined monad &lt;code&gt;FG&lt;/code&gt;, which is a naming strategy I&apos;ve seen in the real world, too: &lt;code&gt;TaskResult&lt;/code&gt;, etc.
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve already mentioned, if there&apos;s a general theorem that says that this is always possible, I&apos;m not aware of it. To the contrary, I seem to recall reading that this is distinctly not the case, but the source escapes me at the moment. One hint, though, is offered in the documentation of &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Functor-Compose.html&quot;&gt;Data.Functor.Compose&lt;/a&gt;:
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;The composition of applicative functors is always applicative, but the composition of monads is not always a monad.&quot;
        &lt;/p&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        Thankfully, the monads that you mostly need to compose do, in fact, compose. They include &lt;a href=&quot;/2022/04/25/the-maybe-monad&quot;&gt;Maybe&lt;/a&gt;, &lt;a href=&quot;/2022/05/09/an-either-monad&quot;&gt;Either&lt;/a&gt;, &lt;a href=&quot;/2022/06/20/the-state-monad&quot;&gt;State&lt;/a&gt;, &lt;a href=&quot;/2022/11/14/the-reader-monad&quot;&gt;Reader&lt;/a&gt;, and &lt;a href=&quot;/2022/05/16/the-identity-monad&quot;&gt;Identity&lt;/a&gt; (okay, that one maybe isn&apos;t that useful). In other words, any monad &lt;code&gt;F&lt;/code&gt; that composes with e.g. &lt;code&gt;Maybe&lt;/code&gt;, that is, &lt;code&gt;F&amp;lt;Maybe&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;, also forms a monad.
    &lt;/p&gt;
    &lt;p&gt;
        Notice that it&apos;s the &apos;inner&apos; monad that determines whether composition is possible. Not the &apos;outer&apos; monad.
    &lt;/p&gt;
    &lt;p&gt;
        For what it&apos;s worth, I&apos;m basing much of this on my personal experience, which was again helpfully guided by &lt;a href=&quot;https://hackage.haskell.org/package/transformers/docs/Control-Monad-Trans-Class.html&quot;&gt;Control.Monad.Trans.Class&lt;/a&gt;. I don&apos;t, however, wish to turn this article into an article about monad transformers, because if you already know Haskell, you can read the documentation and look at examples. And if you don&apos;t know Haskell, the specifics of monad transformers don&apos;t readily translate to languages like C# or F#.
    &lt;/p&gt;
    &lt;p&gt;
        The conclusions do translate, but the specific language mechanics don&apos;t.
    &lt;/p&gt;
    &lt;p&gt;
        Let&apos;s look at some common examples.
    &lt;/p&gt;
    &lt;h3 id=&quot;51dcb0d54afc46d7b26b7f4021e08dbc&quot;&gt;
        TaskMaybe monad &lt;a href=&quot;#51dcb0d54afc46d7b26b7f4021e08dbc&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        We&apos;ll start with a simple, yet realistic example. The article &lt;a href=&quot;/2019/02/11/asynchronous-injection&quot;&gt;Asynchronous Injection&lt;/a&gt; shows a simple operation that involves reading from a database, making a decision, and potentially writing to the database. The final composition, repeated here for your convenience, is an asynchronous (that is, &lt;code&gt;Task&lt;/code&gt;-based) process.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryAccept&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;m&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;m&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;InternalServerError&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Table&amp;nbsp;unavailable&amp;quot;&lt;/span&gt;),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Ok&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The problem here is that &lt;code&gt;TryAccept&lt;/code&gt; returns &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&lt;/code&gt;, but since the overall workflow already &apos;runs in&apos; an &lt;a href=&quot;/2022/06/06/asynchronous-monads&quot;&gt;asynchronous monad&lt;/a&gt; (&lt;code&gt;Task&lt;/code&gt;), the monads are now nested as &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The way I dealt with that issue in the above code snippet was to rely on a &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;traversal&lt;/a&gt;, but it&apos;s actually an inelegant solution. The way that the &lt;code&gt;SelectMany&lt;/code&gt; invocation maps over the &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&lt;/code&gt; &lt;code&gt;m&lt;/code&gt; is awkward. Instead of &lt;a href=&quot;/2018/07/02/terse-operators-make-business-code-more-readable&quot;&gt;composing a business process&lt;/a&gt;, the scaffolding is on display, so to speak. Sometimes this is unavoidable, but at other times, there may be a better way.
    &lt;/p&gt;
    &lt;p&gt;
        In my defence, when I wrote that article in 2019 I had another pedagogical goal than teaching nested monads. It turns out, however, that you can rewrite the business process using the &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; stack as a monad in its own right.
    &lt;/p&gt;
    &lt;p&gt;
        A monad needs two functions: &lt;em&gt;return&lt;/em&gt; and either &lt;em&gt;bind&lt;/em&gt; or &lt;em&gt;join&lt;/em&gt;. In C# or F#, you can often treat &lt;em&gt;return&lt;/em&gt; as &apos;implied&apos;, in the sense that you can always wrap &lt;code&gt;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; in a call to &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.threading.tasks.task.fromresult&quot;&gt;Task.FromResult&lt;/a&gt;. You&apos;ll see that in a moment.
    &lt;/p&gt;
    &lt;p&gt;
        While you can be cavalier about monadic &lt;em&gt;return&lt;/em&gt;, you&apos;ll need to explicitly implement either &lt;em&gt;bind&lt;/em&gt; or &lt;em&gt;join&lt;/em&gt;. In this case, it turns out that the sample code base already had a &lt;code&gt;SelectMany&lt;/code&gt; implementation:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;m&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;m&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;nothing&lt;/span&gt;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;()),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;just&lt;/span&gt;:&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The method first awaits the &lt;code&gt;Maybe&lt;/code&gt; value, and then proceeds to &lt;code&gt;Match&lt;/code&gt; on it. In the &lt;code&gt;nothing&lt;/code&gt; case, you see the implicit &lt;em&gt;return&lt;/em&gt; being used. In the &lt;code&gt;just&lt;/code&gt; case, the &lt;code&gt;SelectMany&lt;/code&gt; method calls &lt;code&gt;selector&lt;/code&gt; with whatever &lt;code&gt;x&lt;/code&gt; value was contained in the &lt;code&gt;Maybe&lt;/code&gt; object. The result of calling &lt;code&gt;selector&lt;/code&gt; already has the desired type &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;, so the implementation simply returns that value without further ado.
    &lt;/p&gt;
    &lt;p&gt;
        This enables you to rewrite the &lt;code&gt;SelectMany&lt;/code&gt; call in the business process so that it instead looks like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryAccept&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;)))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;InternalServerError&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Table&amp;nbsp;unavailable&amp;quot;&lt;/span&gt;),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Ok&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        At first glance, it doesn&apos;t look like much of an improvement. To be sure, the lambda expression within the &lt;code&gt;SelectMany&lt;/code&gt; method no longer operates on a &lt;code&gt;Maybe&lt;/code&gt; value, but rather on the &lt;code&gt;Reservation&lt;/code&gt; Domain Model &lt;code&gt;r&lt;/code&gt;. On the other hand, we&apos;re now saddled with that graceless &lt;code&gt;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;i&lt;/span&gt;))&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Had this been Haskell, we could have made this more succinct by eta reducing the &lt;code&gt;Maybe&lt;/code&gt; case constructor and used the &lt;code&gt;&amp;lt;$&amp;gt;&lt;/code&gt; infix operator instead of &lt;code&gt;fmap&lt;/code&gt;; something like &lt;code&gt;Just &amp;lt;$&amp;gt; create r&lt;/code&gt;. In C#, on the other hand, we can do something that Haskell doesn&apos;t allow. We can overload the &lt;code&gt;SelectMany&lt;/code&gt; method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;)));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This overload generalizes the &apos;pattern&apos; exemplified by the above business process composition. Instead of a specific method call, it now works with any &lt;code&gt;selector&lt;/code&gt; function that returns &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&lt;/code&gt;. Since &lt;code&gt;selector&lt;/code&gt; only returns a &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&lt;/code&gt; value, and not a &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; value, as actually required in this nested monad, the overload has to map (that is, &lt;code&gt;Select&lt;/code&gt;) the result by wrapping it in a &lt;code&gt;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        This now enables you to improve the business process composition to something more readable.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryAccept&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rs&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;InternalServerError&lt;/span&gt;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Table&amp;nbsp;unavailable&amp;quot;&lt;/span&gt;),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Ok&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It even turned out to be possible to eta reduce the lambda expression instead of the (also valid, but more verbose) &lt;code&gt;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;)&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;re interested in the sample code, I&apos;ve pushed a branch named &lt;code&gt;use-monad-stack&lt;/code&gt; to &lt;a href=&quot;https://github.com/ploeh/asynchronous-injection&quot;&gt;the GitHub repository&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Not surprisingly, the F# &lt;code&gt;bind&lt;/code&gt; function is much terser:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;bind&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;match!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;with&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Some&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&amp;#39;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&amp;#39;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;None&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;None&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You can find that particular snippet in the code base that accompanies the article &lt;a href=&quot;/2019/12/02/refactoring-registration-flow-to-functional-architecture&quot;&gt;Refactoring registration flow to functional architecture&lt;/a&gt;, although as far as I can tell, it&apos;s not actually in use in that code base. I probably just added it because I could.
    &lt;/p&gt;
    &lt;p&gt;
        You can find Haskell examples of combining &lt;a href=&quot;https://hackage.haskell.org/package/transformers/docs/Control-Monad-Trans-Maybe.html&quot;&gt;MaybeT&lt;/a&gt; with &lt;code&gt;IO&lt;/code&gt; in various articles on this blog. One of them is &lt;a href=&quot;/2017/02/02/dependency-rejection&quot;&gt;Dependency rejection&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;74c0764ee623459596700a6462dd5452&quot;&gt;
        TaskResult monad &lt;a href=&quot;#74c0764ee623459596700a6462dd5452&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A similar, but slightly more complex, example involves nesting Either values in asynchronous workflows. In some languages, such as F#, Either is rather called &lt;a href=&quot;https://learn.microsoft.com/dotnet/fsharp/language-reference/results&quot;&gt;Result&lt;/a&gt;, and asynchronous workflows are modelled by a &lt;code&gt;Task&lt;/code&gt; &lt;a href=&quot;https://bartoszmilewski.com/2014/01/14/functors-are-containers/&quot;&gt;container&lt;/a&gt;, as already demonstrated above. Thus, on .NET at least, this nested monad is often called &lt;em&gt;TaskResult&lt;/em&gt;, but you may also see &lt;em&gt;AsyncResult&lt;/em&gt;, &lt;em&gt;AsyncEither&lt;/em&gt;, or other combinations. Depending on the programming language, such names may be used only for modules, and not for the container type itself. In C# or F# code, for example, you may look in vain after a class called &lt;code&gt;TaskResult&amp;lt;T&amp;gt;&lt;/code&gt;, but rather find a &lt;code&gt;TaskResult&lt;/code&gt; static class or module.
    &lt;/p&gt;
    &lt;p&gt;
        In C# you can define monadic &lt;em&gt;bind&lt;/em&gt; like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;throw&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ArgumentNullException&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;nameof&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;));
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;l&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Left&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;l&lt;/span&gt;)),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Here I&apos;ve again passed the eta-reduced &lt;code&gt;selector&lt;/code&gt; straight to the &lt;em&gt;right&lt;/em&gt; case of the &lt;code&gt;Either&lt;/code&gt; value, but &lt;code&gt;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;)&lt;/code&gt; works, too.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;em&gt;left&lt;/em&gt; case shows another example of &apos;implicit monadic &lt;em&gt;return&lt;/em&gt;&apos;. I didn&apos;t bother defining an explicit &lt;code&gt;Return&lt;/code&gt; function, but rather use &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Left&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;l&lt;/span&gt;))&lt;/code&gt; to return a &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; value.
    &lt;/p&gt;
    &lt;p&gt;
        As is the case with C#, you&apos;ll also need to add a special overload to enable the syntactic sugar of &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/linq/get-started/query-expression-basics&quot;&gt;query expressions&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Either&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;L&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;k&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;R&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;U&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;R1&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;source&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SelectMany&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;k&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;y&lt;/span&gt;)));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ll see a comprehensive example using these functions in a future article.
    &lt;/p&gt;
    &lt;p&gt;
        In F# I&apos;d often first define a module with a few functions including &lt;code&gt;bind&lt;/code&gt;, and then use those implementations to define a &lt;a href=&quot;https://learn.microsoft.com/dotnet/fsharp/language-reference/computation-expressions&quot;&gt;computation expression&lt;/a&gt;, but in &lt;a href=&quot;/2016/04/11/async-as-surrogate-io&quot;&gt;one article&lt;/a&gt;, I jumped straight to the expression builder:
    &lt;/p&gt;
    &lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#4ec9b0;&quot;&gt;AsyncEitherBuilder&lt;/span&gt;&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Async&amp;lt;Result&amp;lt;&amp;#39;a,&amp;#39;c&amp;gt;&amp;gt;&amp;nbsp;*&amp;nbsp;(&amp;#39;a&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;Result&amp;lt;&amp;#39;b,&amp;#39;c&amp;gt;&amp;gt;)&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;Result&amp;lt;&amp;#39;b,&amp;#39;c&amp;gt;&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;this.&lt;span style=&quot;color:navy;&quot;&gt;Bind&lt;/span&gt;(x,&amp;nbsp;&lt;span style=&quot;color:navy;&quot;&gt;f&lt;/span&gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;x&amp;#39;&amp;nbsp;=&amp;nbsp;x
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;match&lt;/span&gt;&amp;nbsp;x&amp;#39;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;with&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;&lt;span style=&quot;color:navy;&quot;&gt;Success&lt;/span&gt;&amp;nbsp;s&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:navy;&quot;&gt;f&lt;/span&gt;&amp;nbsp;s
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;&lt;span style=&quot;color:navy;&quot;&gt;Failure&lt;/span&gt;&amp;nbsp;f&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:navy;&quot;&gt;Failure&lt;/span&gt;&amp;nbsp;f&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;&amp;#39;a&amp;nbsp;-&amp;gt;&amp;nbsp;&amp;#39;a&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;this.&lt;span style=&quot;color:navy;&quot;&gt;ReturnFrom&lt;/span&gt;&amp;nbsp;x&amp;nbsp;=&amp;nbsp;x
 
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;asyncEither&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#4ec9b0;&quot;&gt;AsyncEitherBuilder&lt;/span&gt;&amp;nbsp;()&lt;/pre&gt;
	&lt;/p&gt;
    &lt;p&gt;
        That article also shows usage examples. Another article, &lt;a href=&quot;/2022/02/14/a-conditional-sandwich-example&quot;&gt;A conditional sandwich example&lt;/a&gt;, shows more examples of using this nested monad, although there, the computation expression is named &lt;code&gt;taskResult&lt;/code&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;e6426619b2ae4f8d97d62edfe9cae0ca&quot;&gt;
        Stateful computations that may fail &lt;a href=&quot;#e6426619b2ae4f8d97d62edfe9cae0ca&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To be honest, you mostly run into a scenario where nested monads are useful when some kind of &apos;effect&apos; (errors, mostly) is embedded in an &lt;a href=&quot;https://en.wikipedia.org/wiki/Input/output&quot;&gt;I/O&lt;/a&gt;-bound computation. In Haskell, this means &lt;code&gt;IO&lt;/code&gt;, in C# &lt;code&gt;Task&lt;/code&gt;, and in F# either &lt;code&gt;Task&lt;/code&gt; or &lt;code&gt;Async&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Other combinations are possible, however, but I&apos;ve rarely encountered a need for additional nested monads outside of Haskell. In multi-paradigmatic languages, you can usually find other good designs that address issues that you may occasionally run into in a purely functional language. The following example is a Haskell-only example. You can skip it if you don&apos;t know or care about Haskell.
    &lt;/p&gt;
    &lt;p&gt;
        Imagine that you want to keep track of some statistics related to a software service you offer. If the &lt;a href=&quot;https://en.wikipedia.org/wiki/Variance&quot;&gt;variance&lt;/a&gt; of some number (say, response time) exceeds 10 then you want to issue an alert that the &lt;a href=&quot;https://en.wikipedia.org/wiki/Service-level_agreement&quot;&gt;SLA&lt;/a&gt; was violated. Apparently, in your system, reliability means staying consistent.
    &lt;/p&gt;
    &lt;p&gt;
        You have millions of observations, and they keep arriving, so you need an &lt;a href=&quot;https://en.wikipedia.org/wiki/Online_algorithm&quot;&gt;online algorithm&lt;/a&gt;. For average and variance we&apos;ll use &lt;a href=&quot;https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance&quot;&gt;Welford&apos;s algorithm&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The following code uses these imports:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;import&lt;/span&gt;&amp;nbsp;Control.Monad
&lt;span style=&quot;color:blue;&quot;&gt;import&lt;/span&gt;&amp;nbsp;Control.Monad.Trans.State.Strict
&lt;span style=&quot;color:blue;&quot;&gt;import&lt;/span&gt;&amp;nbsp;Control.Monad.Trans.Maybe&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        First, you can define a data structure to hold the aggregate values required for the algorithm, as well as an initial, empty value:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;Aggregate&amp;nbsp;=&amp;nbsp;Aggregate&amp;nbsp;{&amp;nbsp;count&amp;nbsp;::&amp;nbsp;Int,&amp;nbsp;meanA&amp;nbsp;::&amp;nbsp;Double,&amp;nbsp;m2&amp;nbsp;::&amp;nbsp;Double&amp;nbsp;}&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;)
 
&lt;span style=&quot;color:#2b91af;&quot;&gt;emptyA&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;
emptyA&amp;nbsp;=&amp;nbsp;Aggregate&amp;nbsp;0&amp;nbsp;0&amp;nbsp;0&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You can also define a function to update the aggregate values with a new observation:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;update&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;
update&amp;nbsp;(Aggregate&amp;nbsp;count&amp;nbsp;mean&amp;nbsp;m2)&amp;nbsp;x&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;count&amp;#39;&amp;nbsp;=&amp;nbsp;count&amp;nbsp;+&amp;nbsp;1
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;delta&amp;nbsp;=&amp;nbsp;x&amp;nbsp;-&amp;nbsp;mean
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;mean&amp;#39;&amp;nbsp;=&amp;nbsp;mean&amp;nbsp;+&amp;nbsp;delta&amp;nbsp;/&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fromIntegral&lt;/span&gt;&amp;nbsp;count&amp;#39;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;delta2&amp;nbsp;=&amp;nbsp;x&amp;nbsp;-&amp;nbsp;mean&amp;#39;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;m2&amp;#39;&amp;nbsp;=&amp;nbsp;m2&amp;nbsp;+&amp;nbsp;delta&amp;nbsp;*&amp;nbsp;delta2
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Aggregate&amp;nbsp;count&amp;#39;&amp;nbsp;mean&amp;#39;&amp;nbsp;m2&amp;#39;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Given an existing &lt;code&gt;Aggregate&lt;/code&gt; record and a new observation, this function implements the algorithm to calculate a new &lt;code&gt;Aggregate&lt;/code&gt; record.
    &lt;/p&gt;
    &lt;p&gt;
        The values in an &lt;code&gt;Aggregate&lt;/code&gt; record, however, are only intermediary values that you can use to calculate statistics such as mean, variance, and sample variance. You&apos;ll need a data type and function to do that, as well:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;Statistics&amp;nbsp;=
&amp;nbsp;&amp;nbsp;Statistics
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&amp;nbsp;mean&amp;nbsp;::&amp;nbsp;Double,&amp;nbsp;variance&amp;nbsp;::&amp;nbsp;Double,&amp;nbsp;sampleVariance&amp;nbsp;::&amp;nbsp;Maybe&amp;nbsp;Double&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;)
 
&lt;span style=&quot;color:#2b91af;&quot;&gt;extractStatistics&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Statistics&lt;/span&gt;
extractStatistics&amp;nbsp;(Aggregate&amp;nbsp;count&amp;nbsp;mean&amp;nbsp;m2)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;count&amp;nbsp;&amp;lt;&amp;nbsp;1&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;then&lt;/span&gt;&amp;nbsp;Nothing
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;else&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;variance&amp;nbsp;=&amp;nbsp;m2&amp;nbsp;/&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fromIntegral&lt;/span&gt;&amp;nbsp;count
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sampleVariance&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;count&amp;nbsp;&amp;lt;&amp;nbsp;2&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;then&lt;/span&gt;&amp;nbsp;Nothing&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;else&lt;/span&gt;&amp;nbsp;Just&amp;nbsp;$&amp;nbsp;m2&amp;nbsp;/&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fromIntegral&lt;/span&gt;&amp;nbsp;(count&amp;nbsp;-&amp;nbsp;1)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Just&amp;nbsp;$&amp;nbsp;Statistics&amp;nbsp;mean&amp;nbsp;variance&amp;nbsp;sampleVariance&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is where the computation becomes &apos;failure-prone&apos;. Granted, we only have a real problem when we have zero observations, but this still means that we need to return a &lt;code&gt;Maybe Statistics&lt;/code&gt; value in order to avoid division by zero.
    &lt;/p&gt;
    &lt;p&gt;
        (There might be other designs that avoid that problem, or you might simply decide to tolerate that edge case and code around it in other ways. I&apos;ve decided to design the &lt;code&gt;extractStatistics&lt;/code&gt; function in this particular way in order to furnish an example. Work with me here.)
    &lt;/p&gt;
    &lt;p&gt;
        Let&apos;s say that as the next step, you&apos;d like to compose these two functions into a single function that both adds a new observation, computes the statistics, but also returns the updated &lt;code&gt;Aggregate&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        You &lt;em&gt;could&lt;/em&gt; write it like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;addAndCompute&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;Statistics&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;)
addAndCompute&amp;nbsp;x&amp;nbsp;agg&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;agg&amp;#39;&amp;nbsp;=&amp;nbsp;update&amp;nbsp;agg&amp;nbsp;x
&amp;nbsp;&amp;nbsp;stats&amp;nbsp;&amp;lt;-&amp;nbsp;extractStatistics&amp;nbsp;agg&amp;#39;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;(stats,&amp;nbsp;agg&amp;#39;)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This implementation uses &lt;code&gt;do&lt;/code&gt; notation to automate handling of &lt;code&gt;Nothing&lt;/code&gt; values. Still, it&apos;s a bit inelegant with its two &lt;code&gt;agg&lt;/code&gt; values only distinguishable by the prime sign after one of them, and the need to explicitly return a tuple of the value and the new state.
    &lt;/p&gt;
    &lt;p&gt;
        This is the kind of problem that the State monad addresses. You could instead write the function like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;addAndCompute&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;State&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Statistics&lt;/span&gt;)
addAndCompute&amp;nbsp;x&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;modify&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;flip&lt;/span&gt;&amp;nbsp;update&amp;nbsp;x
&amp;nbsp;&amp;nbsp;gets&amp;nbsp;extractStatistics&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You could actually also write it as a one-liner, but that&apos;s already a bit too terse to my liking:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;addAndCompute&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;State&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Statistics&lt;/span&gt;)
addAndCompute&amp;nbsp;x&amp;nbsp;=&amp;nbsp;modify&amp;nbsp;(`update`&amp;nbsp;x)&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;gets&amp;nbsp;extractStatistics&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        And if you really hate your co-workers, you can always visit &lt;a href=&quot;https://pointfree.io&quot;&gt;pointfree.io&lt;/a&gt; to entirely obscure that expression, but I digress.
    &lt;/p&gt;
    &lt;p&gt;
        The point is that the State monad &lt;a href=&quot;/ref/doocautbm&quot;&gt;amplifies the essential and eliminates the irrelevant&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Now you&apos;d like to add a function that issues an alert if the variance is greater than 10. Again, you &lt;em&gt;could&lt;/em&gt; write it like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;monitor&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;State&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;)
monitor&amp;nbsp;x&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;stats&amp;nbsp;&amp;lt;-&amp;nbsp;addAndCompute&amp;nbsp;x
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;case&lt;/span&gt;&amp;nbsp;stats&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;of&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Just&amp;nbsp;Statistics&amp;nbsp;{&amp;nbsp;variance&amp;nbsp;}&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;10&amp;nbsp;&amp;lt;&amp;nbsp;variance
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;then&lt;/span&gt;&amp;nbsp;Just&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;SLA&amp;nbsp;violation&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;else&lt;/span&gt;&amp;nbsp;Nothing
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Nothing&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Nothing&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        But again, the code is graceless with its explicit handling of &lt;code&gt;Maybe&lt;/code&gt; cases. Whenever you see code that matches &lt;code&gt;Maybe&lt;/code&gt; cases and maps &lt;code&gt;Nothing&lt;/code&gt; to &lt;code&gt;Nothing&lt;/code&gt;, your spider sense should be tingling. Could you abstract that away with a functor or monad?
    &lt;/p&gt;
    &lt;p&gt;
        Yes you can! You can use the &lt;code&gt;MaybeT&lt;/code&gt; monad transformer, which nests &lt;code&gt;Maybe&lt;/code&gt; computations inside another monad. In this case &lt;code&gt;State&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;monitor&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Double&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;State&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Aggregate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;)
monitor&amp;nbsp;x&amp;nbsp;=&amp;nbsp;runMaybeT&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;Statistics&amp;nbsp;{&amp;nbsp;variance&amp;nbsp;}&amp;nbsp;&amp;lt;-&amp;nbsp;MaybeT&amp;nbsp;$&amp;nbsp;addAndCompute&amp;nbsp;x
&amp;nbsp;&amp;nbsp;guard&amp;nbsp;(10&amp;nbsp;&amp;lt;&amp;nbsp;variance)
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;SLA&amp;nbsp;Violation&amp;quot;&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The function type is the same, but the implementation is much simpler. First, the code lifts the &lt;code&gt;Maybe&lt;/code&gt;-valued &lt;code&gt;addAndCompute&lt;/code&gt; result into &lt;code&gt;MaybeT&lt;/code&gt; and pattern-matches on the &lt;code&gt;variance&lt;/code&gt;. Since the code is now &apos;running in&apos; a &lt;code&gt;Maybe&lt;/code&gt;-like context, this line of code only executes if there&apos;s a &lt;code&gt;Statistics&lt;/code&gt; value to extract. If, on the other hand, &lt;code&gt;addAndCompute&lt;/code&gt; returns &lt;code&gt;Nothing&lt;/code&gt;, the function already short-circuits there.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;guard&lt;/code&gt; works just like imperative &lt;a href=&quot;https://en.wikipedia.org/wiki/Guard_(computer_science)&quot;&gt;Guard Clauses&lt;/a&gt;. The third line of code only runs if the &lt;code&gt;variance&lt;/code&gt; is greater than 10. In that case, it returns an alert message.
    &lt;/p&gt;
    &lt;p&gt;
        The entire &lt;code&gt;do&lt;/code&gt; workflow gets unwrapped with &lt;code&gt;runMaybeT&lt;/code&gt; so that we return back to a normal stateful computation that may fail.
    &lt;/p&gt;
    &lt;p&gt;
        Let&apos;s try it out:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; (evalState $ monitor 1 &amp;gt;&amp;gt; monitor 7) emptyA
Nothing
ghci&amp;gt; (evalState $ monitor 1 &amp;gt;&amp;gt; monitor 8) emptyA
Just &quot;SLA Violation&quot;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Good, rigorous testing suggests that it&apos;s working.
    &lt;/p&gt;
    &lt;h3 id=&quot;e67fa8bc1b40459c91c1c8b45595c379&quot;&gt;
        Conclusion &lt;a href=&quot;#e67fa8bc1b40459c91c1c8b45595c379&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        You sometimes run into situations where monads are nested. This mostly happens in I/O-bound computations, where you may have a Maybe or Either value embedded inside &lt;code&gt;Task&lt;/code&gt; or &lt;code&gt;IO&lt;/code&gt;. This can sometimes make working with the &apos;inner&apos; monad awkward, but in many cases there&apos;s a good solution at hand.
    &lt;/p&gt;
    &lt;p&gt;
        Some monads, like Maybe, Either, State, Reader, and Identity, nest nicely inside other monads. Thus, if your &apos;inner&apos; monad is one of those, you can turn the nested arrangement into a monad in its own right. This may help simplify your code base.
    &lt;/p&gt;
    &lt;p&gt;
        In addition to the common monads listed here, there are few more exotic ones that also play well in a nested configuration. Additionally, if your &apos;inner&apos; monad is a custom data structure of your own creation, it&apos;s up to you to investigate if it nests nicely in another monad. As far as I can tell, though, if you can make it nest in one monad (e.g Task, Async, or IO) you can probably make it nest in any monad.
    &lt;/p&gt;
	&lt;p&gt;
		&lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2018/01/08/software-design-isomorphisms&quot;&gt;Software design isomorphisms&lt;/a&gt;.
	&lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/11/25/nested-monads</guid>
      </item>
    
      <item>
        <title>Collecting and handling result values</title>
        <link>https://blog.ploeh.dk/2024/11/18/collecting-and-handling-result-values/</link>
        <pubDate>Mon, 18 Nov 2024 07:39:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;The answer is traverse. It&apos;s always traverse.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I recently came across &lt;a href=&quot;https://stackoverflow.com/q/79112836/126014&quot;&gt;a Stack Overflow question&lt;/a&gt; about collecting and handling &lt;a href=&quot;https://en.wikipedia.org/wiki/Tagged_union&quot;&gt;sum types&lt;/a&gt; (AKA discriminated unions or, in this case, result types). While the question was tagged &lt;em&gt;functional-programming&lt;/em&gt;, the overall structure of the code was so imperative, with so much interleaved &lt;a href=&quot;https://en.wikipedia.org/wiki/Input/output&quot;&gt;I/O&lt;/a&gt;, that it hardly &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;qualified as functional architecture&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Instead, I gave &lt;a href=&quot;https://stackoverflow.com/a/79112992/126014&quot;&gt;an answer which involved a minimal change to the code&lt;/a&gt;. Subsequently, the original poster asked to see a more functional version of the code. That&apos;s a bit too large a task for a Stack Overflow answer, I think, so I&apos;ll do it here on the blog instead.
    &lt;/p&gt;
    &lt;p&gt;
        Further comments and discussion on the original post reveal that the poster is interested in two alternatives. I&apos;ll start with the alternative that&apos;s only discussed, but not shown, in the question. The motivation for this ordering is that this variation is easier to implement than the other one, and I consider it pedagogical to start with the simplest case.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll do that in this article, and then follow up with another article that covers the short-circuiting case.
    &lt;/p&gt;
    &lt;h3 id=&quot;9b3987ad5daf4df48c8155a54fb39318&quot;&gt;
        Imperative outset &lt;a href=&quot;#9b3987ad5daf4df48c8155a54fb39318&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To begin, consider this mostly imperative code snippet:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;();
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;();
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;errors&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;();
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;&amp;nbsp;=&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;errors&lt;/span&gt;);
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;updateResult&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;updateResult&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;&amp;lt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;)&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;);&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;&amp;nbsp;},
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;);&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;},
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;errors&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;);&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;);
}
 
&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SaveChangesAsync&lt;/span&gt;();
 
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Results&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Ok&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;([..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItems&lt;/span&gt;],&amp;nbsp;[..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;failedItems&lt;/span&gt;],&amp;nbsp;[..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;errors&lt;/span&gt;]));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        There&apos;s quite a few things to take in, and one has to infer most of the types and APIs, since the original post didn&apos;t show more code than that. If you&apos;re used to engaging with Stack Overflow questions, however, it&apos;s not too hard to figure out what most of the moving parts do.
    &lt;/p&gt;
    &lt;p&gt;
        The most non-obvious detail is that the code uses a library called &lt;a href=&quot;https://github.com/mcintyre321/OneOf/&quot;&gt;OneOf&lt;/a&gt;, which supplies general-purpose, but rather abstract, sum types. Both the container type &lt;code&gt;OneOf&lt;/code&gt;, as well as the two indicator types &lt;code&gt;NotFound&lt;/code&gt; and &lt;code&gt;Error&lt;/code&gt; are defined in that library.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;Match&lt;/code&gt; method implements standard &lt;a href=&quot;/2018/05/22/church-encoding&quot;&gt;Church encoding&lt;/a&gt;, which enables the code to pattern-match on the three alternative values that &lt;code&gt;UpdateItem&lt;/code&gt; returns.
    &lt;/p&gt;
    &lt;p&gt;
        One more detail also warrants an explicit description: The &lt;code&gt;itemsToUpdate&lt;/code&gt; object is an input argument of the type &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The implementation makes use of mutable state and undisciplined I/O. How do you refactor it to a more functional design?
    &lt;/p&gt;
    &lt;h3 id=&quot;c4e1b030e919464aa22ade11a511414f&quot;&gt;
        Standard traversal &lt;a href=&quot;#c4e1b030e919464aa22ade11a511414f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I&apos;ll pretend that we only need to turn the above code snippet into a functional design. Thus, I&apos;m ignoring that the code is most likely part of a larger code base. Because of the implied database interaction, the method isn&apos;t a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt;. Unless it&apos;s a top-level method (that is, at the boundary of the application), it doesn&apos;t exemplify larger-scale &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        That said, my goal is to refactor the code to an &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt;: Impure actions first, then the meat of the functionality as a pure function, and then some more impure actions to complete the functionality. This strongly suggests that the first step should be to map over &lt;code&gt;itemsToUpdate&lt;/code&gt; and call &lt;code&gt;UpdateItem&lt;/code&gt; for each.
    &lt;/p&gt;
    &lt;p&gt;
        If, however, you do that, you get this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;results&lt;/code&gt; object is a sequence of tasks. If we consider &lt;a href=&quot;/2020/07/27/task-asynchronous-programming-as-an-io-surrogate&quot;&gt;Task as a surrogate for IO&lt;/a&gt;, each task should be considered impure, as it&apos;s either non-deterministic, has side effects, or both. This means that we can&apos;t pass &lt;code&gt;results&lt;/code&gt; to a pure function, and that frustrates the ambition to structure the code as an Impureim Sandwich.
    &lt;/p&gt;
    &lt;p&gt;
        This is one of the most common problems in functional programming, and the answer is usually: Use a &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;traversal&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Because this first, impure layer of the sandwich awaits the task, &lt;code&gt;results&lt;/code&gt; is now an immutable value that can be passed to the pure step. This, by the way, assumes that &lt;code&gt;ShoppingListItem&lt;/code&gt; is immutable, too.
    &lt;/p&gt;
    &lt;p&gt;
        Notice that I adjusted one of the cases of the discriminated union to &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;&lt;/code&gt; rather than just &lt;code&gt;NotFound&lt;/code&gt;. While the OneOf library ships with a &lt;code&gt;NotFound&lt;/code&gt; type, it doesn&apos;t have a generic container of that name, so I defined it myself:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Item&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I added it to make the next step simpler.
    &lt;/p&gt;
    &lt;h3 id=&quot;8f0e6fb0f34047ed99c59f6140a2b08f&quot;&gt;
        Aggregating the results &lt;a href=&quot;#8f0e6fb0f34047ed99c59f6140a2b08f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The next step is to sort the &lt;code&gt;results&lt;/code&gt; into three &apos;buckets&apos;, as it were.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;seed&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Enumerable&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Empty&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;(),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Enumerable&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Empty&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;(),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Enumerable&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Empty&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;);
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Aggregate&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;seed&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item1.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Append&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item2,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item3),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item1,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item2.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Append&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;.Item),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item3),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item1,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item2,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.Item3.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Append&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;))));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s also possible to inline the &lt;code&gt;seed&lt;/code&gt; value, but here I defined it in a separate expression in an attempt at making the code a little more readable. I don&apos;t know if I succeeded, because regardless of where it goes, it&apos;s hardly &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; to break tuple initialization over multiple lines. I had to, though, because otherwise the code would run &lt;a href=&quot;/2019/11/04/the-80-24-rule&quot;&gt;too far to the right&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The lambda expression handles each &lt;code&gt;result&lt;/code&gt; in &lt;code&gt;results&lt;/code&gt; and uses &lt;code&gt;Match&lt;/code&gt; to append the value to its proper &apos;bucket&apos;. The outer &lt;code&gt;result&lt;/code&gt; is a tuple of the three collections.
    &lt;/p&gt;
    &lt;h3 id=&quot;035012be047e431d8904686ec9915b8f&quot;&gt;
        Saving the changes and returning the results &lt;a href=&quot;#035012be047e431d8904686ec9915b8f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The final, impure step in the sandwich is to save the changes and return the results:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SaveChangesAsync&lt;/span&gt;();
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkResult&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;([..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.Item1],&amp;nbsp;[..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.Item2],&amp;nbsp;[..&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.Item3]));&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, the last line of code is pure, but &lt;a href=&quot;/2023/10/09/whats-a-sandwich&quot;&gt;that&apos;s not unusual&lt;/a&gt; when it comes to Impureim Sandwiches.
    &lt;/p&gt;
    &lt;h3 id=&quot;178ff7d455e44a619b67d911a6aecba7&quot;&gt;
        Accumulating the bulk-update result &lt;a href=&quot;#178ff7d455e44a619b67d911a6aecba7&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        So far, I&apos;ve assumed that the final &lt;code&gt;BulkUpdateResult&lt;/code&gt; class is just a simple immutable container without much functionality. If, however, we add some copy-and-update functions to it, we can use them to aggregate the result, instead of an anonymous tuple.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Store&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;([..&amp;nbsp;StoredItems,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;],&amp;nbsp;FailedItems,&amp;nbsp;Errors);
 
&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Fail&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;(StoredItems,&amp;nbsp;[..&amp;nbsp;FailedItems,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;],&amp;nbsp;Errors);
 
&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Error&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;(StoredItems,&amp;nbsp;FailedItems,&amp;nbsp;[..&amp;nbsp;Errors,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;]);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I would have personally preferred the name &lt;code&gt;NotFound&lt;/code&gt; instead of &lt;code&gt;Fail&lt;/code&gt;, but I was going with the original post&apos;s &lt;code&gt;failedItems&lt;/code&gt; terminology, and I thought that it made more sense to call a method &lt;code&gt;Fail&lt;/code&gt; when it adds to a collection called &lt;code&gt;FailedItems&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Adding these three instance methods to &lt;code&gt;BulkUpdateResult&lt;/code&gt; simplifies the composing code:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;OneOf&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NotFound&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ShoppingListItem&lt;/span&gt;&amp;gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Error&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;itemsToUpdate&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Traverse&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;UpdateItem&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;));
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;results&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Aggregate&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BulkUpdateResult&lt;/span&gt;([],&amp;nbsp;[],&amp;nbsp;[]),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Match&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Store&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;storedItem&lt;/span&gt;),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Fail&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;notFound&lt;/span&gt;.Item),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;state&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Error&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;error&lt;/span&gt;)));
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dbContext&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;SaveChangesAsync&lt;/span&gt;();
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;OkResult&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This variation starts with an empty &lt;code&gt;BulkUpdateResult&lt;/code&gt; and then uses &lt;code&gt;Store&lt;/code&gt;, &lt;code&gt;Fail&lt;/code&gt;, or &lt;code&gt;Error&lt;/code&gt; as appropriate to update the state.
    &lt;/p&gt;
    &lt;h3 id=&quot;32e680ea1dbb4bc7bc097e8fcfcb90e9&quot;&gt;
        Parallel Sequence &lt;a href=&quot;#32e680ea1dbb4bc7bc097e8fcfcb90e9&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        If the tasks you want to traverse are thread-safe, you might consider making the traversal concurrent. You can use &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.threading.tasks.task.whenall&quot;&gt;Task.WhenAll&lt;/a&gt; for that. It has the same type as &lt;code&gt;Sequence&lt;/code&gt;, so if you can live with the extra non-determinism that comes with parallel execution, you can use that instead:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Sequence&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;tasks&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;WhenAll&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;tasks&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since the method signature doesn&apos;t change, the rest of the code remains unchanged.
    &lt;/p&gt;
    &lt;h3 id=&quot;a54fe20498bd4aca99d7d4184209a4df&quot;&gt;
        Conclusion &lt;a href=&quot;#a54fe20498bd4aca99d7d4184209a4df&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        One of the most common stumbling blocks in functional programming is when you have a collection of values, and you need to perform an impure action (typically I/O) for each. This leaves you with a collection of impure values (&lt;code&gt;Task&lt;/code&gt; in C#, &lt;code&gt;Task&lt;/code&gt; or &lt;code&gt;Async&lt;/code&gt; in &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;, &lt;code&gt;IO&lt;/code&gt; in &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt;, etc.). What you actually need is a single impure value that contains the collection of results.
    &lt;/p&gt;
    &lt;p&gt;
        The solution to this kind of problem is to &lt;em&gt;traverse&lt;/em&gt; the collection, rather than mapping over it (with &lt;code&gt;Select&lt;/code&gt;, &lt;code&gt;map&lt;/code&gt;, &lt;code&gt;fmap&lt;/code&gt;, or similar). Note that computer scientists often talk about &lt;em&gt;traversing&lt;/em&gt; a data structure like a &lt;a href=&quot;https://en.wikipedia.org/wiki/Tree_(abstract_data_type)&quot;&gt;tree&lt;/a&gt;. This is a less well-defined use of the word, and not directly related. That said, you &lt;em&gt;can&lt;/em&gt; also write &lt;code&gt;Traverse&lt;/code&gt; and &lt;code&gt;Sequence&lt;/code&gt; functions for trees.
    &lt;/p&gt;
    &lt;p&gt;
        This article used a Stack Overflow question as the starting point for an example showing how to refactor imperative code to an Impureim Sandwich.
    &lt;/p&gt;
    &lt;p&gt;
        This completes the first variation requested in the Stack Overflow question.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2024/12/02/short-circuiting-an-asynchronous-traversal&quot;&gt;Short-circuiting an asynchronous traversal&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/11/18/collecting-and-handling-result-values</guid>
      </item>
    
      <item>
        <title>Traversals</title>
        <link>https://blog.ploeh.dk/2024/11/11/traversals/</link>
        <pubDate>Mon, 11 Nov 2024 07:45:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
	&lt;p&gt;
		&lt;em&gt;How to convert a list of tasks into an asynchronous list, and similar problems.&lt;/em&gt;
	&lt;/p&gt;
	&lt;p&gt;
		This article is part of &lt;a href=&quot;/2022/07/11/functor-relationships&quot;&gt;a series of articles about functor relationships&lt;/a&gt;. In a previous article you learned about &lt;a href=&quot;/2022/07/18/natural-transformations&quot;&gt;natural transformations&lt;/a&gt;, and then how &lt;a href=&quot;/2018/03/22/functors&quot;&gt;functors&lt;/a&gt; compose. You can skip several of them if you like, but you might find the one about &lt;a href=&quot;/2024/10/28/functor-compositions&quot;&gt;functor compositions&lt;/a&gt; relevant. Still, this article can be read independently of the rest of the series.
	&lt;/p&gt;
	&lt;p&gt;
		You can go a long way with just a single functor or &lt;a href=&quot;/2022/03/28/monads&quot;&gt;monad&lt;/a&gt;. Consider how useful C#&apos;s LINQ API is, or similar kinds of APIs in other languages - typically &lt;code&gt;map&lt;/code&gt; and &lt;code&gt;flatMap&lt;/code&gt; methods. These APIs work exclusively with the &lt;a href=&quot;/2022/04/19/the-list-monad&quot;&gt;List monad&lt;/a&gt; (which is also a functor). Working with lists, sequences, or collections is so useful that many languages have other kinds of special syntax specifically aimed at working with multiple values: &lt;a href=&quot;https://en.wikipedia.org/wiki/List_comprehension&quot;&gt;List comprehension&lt;/a&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		&lt;a href=&quot;/2022/06/06/asynchronous-monads&quot;&gt;Asynchronous monads&lt;/a&gt; like &lt;a href=&quot;https://docs.microsoft.com/dotnet/api/system.threading.tasks.task-1&quot;&gt;Task&amp;lt;T&amp;gt;&lt;/a&gt; or &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;&apos;s &lt;a href=&quot;https://fsharp.github.io/fsharp-core-docs/reference/fsharp-control-fsharpasync-1.html&quot;&gt;Async&amp;lt;&apos;T&amp;gt;&lt;/a&gt; are another kind of functor so useful in their own right that languages have special &lt;code&gt;async&lt;/code&gt; and &lt;code&gt;await&lt;/code&gt; keywords to compose them.
	&lt;/p&gt;
	&lt;p&gt;
		Sooner or later, though, you run into situations where you&apos;d like to combine two different functors.
	&lt;/p&gt;
	&lt;h3 id=&quot;ebf67a9789e44ad8997832e1ac7c17da&quot;&gt;
		Lists and tasks &lt;a href=&quot;#ebf67a9789e44ad8997832e1ac7c17da&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		It&apos;s not unusual to combine collections and asynchrony. If you make an asynchronous database query, you could easily receive something like &lt;code&gt;Task&amp;lt;IEnumerable&amp;lt;Reservation&amp;gt;&amp;gt;&lt;/code&gt;. This, in isolation, hardly causes problems, but things get more interesting when you need to compose multiple reads.
	&lt;/p&gt;
	&lt;p&gt;
		Consider a query like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;Task&amp;lt;Foo&amp;gt;&amp;nbsp;Read(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;id)&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		What happens if you have a collection of IDs that you&apos;d like to read? This happens:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;ids&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;[]&amp;nbsp;{&amp;nbsp;42,&amp;nbsp;1337,&amp;nbsp;2112&amp;nbsp;};
IEnumerable&amp;lt;Task&amp;lt;Foo&amp;gt;&amp;gt;&amp;nbsp;fooTasks&amp;nbsp;=&amp;nbsp;ids.Select(id&amp;nbsp;=&amp;gt;&amp;nbsp;Foo.Read(id));&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		You get a collection of Tasks, which may be awkward because you can&apos;t &lt;code&gt;await&lt;/code&gt; it. Perhaps you&apos;d rather prefer a single Task that contains a collection: &lt;code&gt;Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&lt;/code&gt;. In other words, you&apos;d like to flip the functors:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;IEnumerable&amp;lt;Task&amp;lt;Foo&amp;gt;&amp;gt;
Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		The top type is what you have. The bottom type is what you&apos;d like to have.
	&lt;/p&gt;
	&lt;p&gt;
		The combination of asynchrony and collections is so common that .NET has special methods to do that. I&apos;ll briefly mention one of these later, but what&apos;s the &lt;em&gt;general&lt;/em&gt; solution to this problem?
	&lt;/p&gt;
	&lt;p&gt;
		Whenever you need to flip two functors, you need a &lt;em&gt;traversal&lt;/em&gt;.
	&lt;/p&gt;
	&lt;h3 id=&quot;b962041a5e3d4eb9ba5101641407ca3f&quot;&gt;
		Sequence &lt;a href=&quot;#b962041a5e3d4eb9ba5101641407ca3f&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		As is almost always the case, we can look to &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; for a canonical definition of traversals - or, as the type class is called: &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Traversable.html&quot;&gt;Traversable&lt;/a&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		A &lt;em&gt;traversable functor&lt;/em&gt; is a functor that enables you to flip that functor and another functor, like the above C# example. In more succinct syntax:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;t (f a) -&amp;gt; f (t a)&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Here, &lt;code&gt;t&lt;/code&gt; symbolises any traversable functor (like &lt;code&gt;IEnumerable&amp;lt;T&amp;gt;&lt;/code&gt; in the above C# example), and &lt;code&gt;f&lt;/code&gt; is another functor (like &lt;code&gt;Task&amp;lt;T&amp;gt;&lt;/code&gt;, above). By flipping the functors I mean making &lt;code&gt;t&lt;/code&gt; and &lt;code&gt;f&lt;/code&gt; change places; just like &lt;code&gt;IEnumerable&lt;/code&gt; and &lt;code&gt;Task&lt;/code&gt;, above.
	&lt;/p&gt;
	&lt;p&gt;
		Thinking of &lt;a href=&quot;https://bartoszmilewski.com/2014/01/14/functors-are-containers/&quot;&gt;functors as containers&lt;/a&gt; we might depict the function like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;img src=&quot;/content/binary/traversal-sequence.png&quot; alt=&quot;Nested functors depicted as concentric circles. To the left the circle t contains the circle f that again contains the circle a. To the right the circle f contains the circle t that again contains the circle a. An arrow points from the left circles to the right circles.&quot;&gt;
	&lt;/p&gt;
	&lt;p&gt;
		To the left, we have an outer functor &lt;code&gt;t&lt;/code&gt; (e.g. &lt;code&gt;IEnumerable&lt;/code&gt;) that contains another functor &lt;code&gt;f&lt;/code&gt; (e.g. &lt;code&gt;Task&lt;/code&gt;) that again &apos;contains&apos; values of type &lt;code&gt;a&lt;/code&gt; (in C# typically called &lt;code&gt;T&lt;/code&gt;). We&apos;d like to flip how the containers are nested so that &lt;code&gt;f&lt;/code&gt; contains &lt;code&gt;t&lt;/code&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		Contrary to what you might expect, the function that does that isn&apos;t called &lt;em&gt;traverse&lt;/em&gt;; it&apos;s called &lt;em&gt;sequence&lt;/em&gt;. (For those readers who are interested in Haskell specifics, the function I&apos;m going to be talking about is actually called &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Traversable.html#v:sequenceA&quot;&gt;sequenceA&lt;/a&gt;. There&apos;s also a function called &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Traversable.html#v:sequence&quot;&gt;sequence&lt;/a&gt;, but it&apos;s not as general. The reason for the odd names are related to the evolution of various Haskell type classes.)
	&lt;/p&gt;
	&lt;p&gt;
		The &lt;em&gt;sequence&lt;/em&gt; function doesn&apos;t work for any old functor. First, &lt;code&gt;t&lt;/code&gt; has to be a &lt;em&gt;traversable functor&lt;/em&gt;. We&apos;ll get back to that later. Second, &lt;code&gt;f&lt;/code&gt; has to be an &lt;a href=&quot;/2018/10/01/applicative-functors&quot;&gt;applicative functor&lt;/a&gt;. (To be honest, I&apos;m not sure if this is &lt;em&gt;always&lt;/em&gt; required, or if it&apos;s possible to produce an example of a specific functor that isn&apos;t applicative, but where it&apos;s still possible to implement a &lt;em&gt;sequence&lt;/em&gt; function. The Haskell &lt;code&gt;sequenceA&lt;/code&gt; function has &lt;code&gt;Applicative f&lt;/code&gt; as a constraint, but as far as I can tell, this only means that this is a &lt;em&gt;sufficient&lt;/em&gt; requirement - not that it&apos;s necessary.)
	&lt;/p&gt;
	&lt;p&gt;
		Since tasks (e.g. &lt;code&gt;Task&amp;lt;T&amp;gt;&lt;/code&gt;) are applicative functors (they are, because &lt;a href=&quot;/2022/06/06/asynchronous-monads&quot;&gt;they are monads&lt;/a&gt;, and &lt;a href=&quot;/2022/03/28/monads&quot;&gt;all monads are applicative functors&lt;/a&gt;), that second requirement is fulfilled for the above example. I&apos;ll show you how to implement a &lt;code&gt;Sequence&lt;/code&gt; function in C# and how to use it, and then we&apos;ll return to the general discussion of what a traversable functor is:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;T&amp;gt;&amp;gt;&amp;nbsp;Sequence&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;IEnumerable&amp;lt;Task&amp;lt;T&amp;gt;&amp;gt;&amp;nbsp;source)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;source.Aggregate(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task.FromResult(Enumerable.Empty&amp;lt;T&amp;gt;()),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;(acc,&amp;nbsp;t)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;xs&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;acc;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;x&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;t;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;xs.Concat(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;[]&amp;nbsp;{&amp;nbsp;x&amp;nbsp;});
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;});
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		This &lt;code&gt;Sequence&lt;/code&gt; function enables you to flip any &lt;code&gt;IEnumerable&amp;lt;Task&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; to a &lt;code&gt;Task&amp;lt;IEnumerable&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;, including the above &lt;code&gt;fooTasks&lt;/code&gt;:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;fooTasks.Sequence();&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		You can also implement &lt;code&gt;sequence&lt;/code&gt; in F#:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Async&amp;lt;&amp;#39;a&amp;gt;&amp;nbsp;list&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;&amp;#39;a&amp;nbsp;list&amp;gt;&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sequence&amp;nbsp;asyncs&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;go&amp;nbsp;acc&amp;nbsp;t&amp;nbsp;=&amp;nbsp;async&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;xs&amp;nbsp;=&amp;nbsp;acc
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;x&amp;nbsp;&amp;nbsp;=&amp;nbsp;t
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;List.append&amp;nbsp;xs&amp;nbsp;[x]&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;List.fold&amp;nbsp;go&amp;nbsp;(fromValue&amp;nbsp;[])&amp;nbsp;asyncs&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		and use it like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;fooTasks&amp;nbsp;=&amp;nbsp;ids&amp;nbsp;|&amp;gt;&amp;nbsp;List.map&amp;nbsp;Foo.Read
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;fooTasks&amp;nbsp;|&amp;gt;&amp;nbsp;Async.sequence&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		For this example, I put the &lt;code&gt;sequence&lt;/code&gt; function in a local &lt;code&gt;Async&lt;/code&gt; module; it&apos;s not part of any published &lt;code&gt;Async&lt;/code&gt; module.
	&lt;/p&gt;
	&lt;p&gt;
		These C# and F# examples are specific translations: From lists of tasks to a task of list. If you need another translation, you&apos;ll have to write a new function for that particular combination of functors. Haskell has more general capabilities, so that you don&apos;t have to write functions for all combinations. I&apos;m not assuming that you know Haskell, however, so I&apos;ll proceed with the description.
	&lt;/p&gt;
	&lt;h3 id=&quot;d63d059d841b4d9783f42c0360b21662&quot;&gt;
		Traversable functor &lt;a href=&quot;#d63d059d841b4d9783f42c0360b21662&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		The &lt;em&gt;sequence&lt;/em&gt; function requires that the &apos;other&apos; functor (the one that&apos;s &lt;em&gt;not&lt;/em&gt; the traversable functor) is an applicative functor, but what about the traversable functor itself? What does it take to be a traversable functor?
	&lt;/p&gt;
	&lt;p&gt;
		I have to admit that I have to rely on Haskell specifics to a greater extent than normal. For most other concepts and abstractions in &lt;a href=&quot;/2017/10/04/from-design-patterns-to-category-theory&quot;&gt;the overall article series&lt;/a&gt;, I&apos;ve been able to draw on various sources, chief of which are &lt;a href=&quot;https://bartoszmilewski.com/2014/10/28/category-theory-for-programmers-the-preface/&quot;&gt;Category Theory for Programmers&lt;/a&gt;. In various articles, I&apos;ve cited my sources whenever possible. While I&apos;ve relied on Haskell libraries for &apos;canonical&apos; ways to &lt;em&gt;represent&lt;/em&gt; concepts in a programming language, I&apos;ve tried to present ideas as having a more universal origin than just Haskell.
	&lt;/p&gt;
	&lt;p&gt;
		When it comes to traversable functors, I haven&apos;t come across universal reasoning like that which gives rise to concepts like &lt;a href=&quot;/2017/10/06/monoids&quot;&gt;monoids&lt;/a&gt;, functors, &lt;a href=&quot;/2018/05/22/church-encoding&quot;&gt;Church encodings&lt;/a&gt;, or &lt;a href=&quot;/2019/04/29/catamorphisms&quot;&gt;catamorphisms&lt;/a&gt;. This is most likely a failing on my part.
	&lt;/p&gt;
	&lt;p&gt;
		Traversals of the Haskell kind are, however, so &lt;em&gt;useful&lt;/em&gt; that I find it appropriate to describe them. When consulting, it&apos;s a common solution to a lot of problems that people are having with functional programming.
	&lt;/p&gt;
	&lt;p&gt;
		Thus, based on Haskell&apos;s &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Traversable.html&quot;&gt;Data.Traversable&lt;/a&gt;, a traversable functor must:
		&lt;ul&gt;
			&lt;li&gt;be a functor&lt;/li&gt;
			&lt;li&gt;be a &apos;foldable&apos; functor&lt;/li&gt;
			&lt;li&gt;define a &lt;em&gt;sequence&lt;/em&gt; or &lt;em&gt;traverse&lt;/em&gt; function&lt;/li&gt;
		&lt;/ul&gt;
		You&apos;ve already seen examples of &lt;em&gt;sequence&lt;/em&gt; functions, and I&apos;m also assuming that (since you&apos;ve made it so far in the article already) you know what a functor is. But what&apos;s a &lt;em&gt;foldable&lt;/em&gt; functor?
	&lt;/p&gt;
	&lt;p&gt;
		Haskell comes with a &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Foldable.html&quot;&gt;Foldable&lt;/a&gt; type class. It defines a class of data that has a particular type of &lt;a href=&quot;/2019/04/29/catamorphisms&quot;&gt;catamorphism&lt;/a&gt;. As I&apos;ve outlined in my article on catamorphisms, Haskell&apos;s notion of a &lt;em&gt;fold&lt;/em&gt; sometimes coincides with a (or &apos;the&apos;) catamorphism for a type, and sometimes not. For &lt;a href=&quot;/2019/05/20/maybe-catamorphism&quot;&gt;Maybe&lt;/a&gt; and &lt;a href=&quot;/2019/05/27/list-catamorphism&quot;&gt;List&lt;/a&gt; they do coincide, while they don&apos;t for &lt;a href=&quot;/2019/06/03/either-catamorphism&quot;&gt;Either&lt;/a&gt; or &lt;a href=&quot;/2019/06/10/tree-catamorphism&quot;&gt;Tree&lt;/a&gt;. It&apos;s not that you can&apos;t define &lt;code&gt;Foldable&lt;/code&gt; for &lt;a href=&quot;/2018/06/11/church-encoded-either&quot;&gt;Either&lt;/a&gt; or &lt;a href=&quot;/2018/08/06/a-tree-functor&quot;&gt;Tree&lt;/a&gt;, it&apos;s just that it&apos;s not &apos;the&apos; &lt;em&gt;general&lt;/em&gt; catamorphism for that type.
	&lt;/p&gt;
	&lt;p&gt;
		I can&apos;t tell whether &lt;code&gt;Foldable&lt;/code&gt; is a universal abstraction, or if it&apos;s just an ad-hoc API that turns out to be useful in practice. It looks like the latter to me, but my knowledge is only limited. Perhaps I&apos;ll be wiser in a year or two.
	&lt;/p&gt;
	&lt;p&gt;
		I will, however, take it as licence to treat this topic a little less formally than I&apos;ve done with other articles. While there &lt;em&gt;are&lt;/em&gt; laws associated with &lt;code&gt;Traversable&lt;/code&gt;, they are rather complex, so I&apos;m going to skip them.
	&lt;/p&gt;
	&lt;p&gt;
		The above requirements will enable you to define traversable functors if you run into some more exotic ones, but in practice, the common functors List, &lt;a href=&quot;/2018/03/26/the-maybe-functor&quot;&gt;Maybe&lt;/a&gt;, &lt;a href=&quot;/2019/01/14/an-either-functor&quot;&gt;Either&lt;/a&gt;, &lt;a href=&quot;/2018/08/06/a-tree-functor&quot;&gt;Tree&lt;/a&gt;, and &lt;a href=&quot;/2018/09/03/the-identity-functor&quot;&gt;Identity&lt;/a&gt; are all traversable. That it useful to know. If any of those functors is the outer functor in a composition of functors, then you can flip them to the inner position as long as the other functor is an applicative functor.
	&lt;/p&gt;
	&lt;p&gt;
		Since &lt;code&gt;IEnumerable&amp;lt;T&amp;gt;&lt;/code&gt; is traversable, and &lt;code&gt;Task&amp;lt;T&amp;gt;&lt;/code&gt; (or &lt;code&gt;Async&amp;lt;&apos;T&amp;gt;&lt;/code&gt;) is an applicative functor, it&apos;s possible to use &lt;code&gt;Sequence&lt;/code&gt; to convert &lt;code&gt;IEnumerable&amp;lt;Task&amp;lt;Foo&amp;gt;&amp;gt;&lt;/code&gt; to &lt;code&gt;Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&lt;/code&gt;.
	&lt;/p&gt;
	&lt;h3 id=&quot;3346c092666c4dacb9a61cc1f622fc0f&quot;&gt;
		Traverse &lt;a href=&quot;#3346c092666c4dacb9a61cc1f622fc0f&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		The C# and F# examples you&apos;ve seen so far arrive at the desired type in a two-step process. First they produce the &apos;wrong&apos; type with &lt;code&gt;ids.Select(Foo.Read)&lt;/code&gt; or &lt;code&gt;ids&amp;nbsp;|&amp;gt;&amp;nbsp;List.map&amp;nbsp;Foo.Read&lt;/code&gt;, and then they use &lt;code&gt;Sequence&lt;/code&gt; to arrive at the desired type.
	&lt;/p&gt;
	&lt;p&gt;
		When you use two expressions, you need two lines of code, and you also need to come up with a name for the intermediary value. It might be easier to chain the two function calls into a single expression:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;ids.Select(Foo.Read).Sequence();&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Or, in F#:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;ids&amp;nbsp;|&amp;gt;&amp;nbsp;List.map&amp;nbsp;Foo.Read&amp;nbsp;|&amp;gt;&amp;nbsp;Async.sequence&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Chaining &lt;code&gt;Select&lt;/code&gt;/&lt;code&gt;map&lt;/code&gt; with &lt;code&gt;Sequence&lt;/code&gt;/&lt;code&gt;sequence&lt;/code&gt; is so common that it&apos;s a named function: &lt;em&gt;traverse&lt;/em&gt;. In C#:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;Traverse&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;IEnumerable&amp;lt;T&amp;gt;&amp;nbsp;source,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Func&amp;lt;T,&amp;nbsp;Task&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;selector)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;source.Select(selector).Sequence();
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		This makes usage a little easier:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;IEnumerable&amp;lt;Foo&amp;gt;&amp;gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;ids.Traverse(Foo.Read);&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		In F# the implementation might be similar:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;(&amp;#39;a&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;&amp;#39;b&amp;gt;)&amp;nbsp;-&amp;gt;&amp;nbsp;&amp;#39;a&amp;nbsp;list&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;&amp;#39;b&amp;nbsp;list&amp;gt;&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;traverse&amp;nbsp;f&amp;nbsp;xs&amp;nbsp;=&amp;nbsp;xs&amp;nbsp;|&amp;gt;&amp;nbsp;List.map&amp;nbsp;f&amp;nbsp;|&amp;gt;&amp;nbsp;sequence&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Usage then looks like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;foosTask&amp;nbsp;=&amp;nbsp;ids&amp;nbsp;|&amp;gt;&amp;nbsp;Async.traverse&amp;nbsp;Foo.Read&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		As you can tell, if you&apos;ve already implemented &lt;em&gt;sequence&lt;/em&gt; you can always implement &lt;em&gt;traverse&lt;/em&gt;. The converse is also true: If you&apos;ve already implemented &lt;em&gt;traverse&lt;/em&gt;, you can always implement &lt;em&gt;sequence&lt;/em&gt;. You&apos;ll see an example of that later.
	&lt;/p&gt;
	&lt;h3 id=&quot;117fac3b686e4db8b6c3c4e0ac556929&quot;&gt;
		A reusable idea &lt;a href=&quot;#117fac3b686e4db8b6c3c4e0ac556929&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		If you know the .NET Task Parallel Library (TPL), you may demur that my implementation of &lt;code&gt;Sequence&lt;/code&gt; seems like an inefficient version of &lt;a href=&quot;https://docs.microsoft.com/dotnet/api/system.threading.tasks.task.whenall&quot;&gt;Task.WhenAll&lt;/a&gt;, and that &lt;code&gt;Traverse&lt;/code&gt; could be written like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;Traverse&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;IEnumerable&amp;lt;T&amp;gt;&amp;nbsp;source,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Func&amp;lt;T,&amp;nbsp;Task&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;selector)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Task.WhenAll(source.Select(selector));
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		This alternative is certainly possible. Whether it&apos;s more efficient I don&apos;t know; I haven&apos;t measured. As foreshadowed in the beginning of the article, the combination of collections and asynchrony is so common that .NET has special APIs to handle that. You may ask, then: &lt;em&gt;What&apos;s the point?&lt;/em&gt;
	&lt;/p&gt;
	&lt;p&gt;
		The point of is that a traversable functor is &lt;em&gt;a reusable idea&lt;/em&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		You may be able to find existing APIs like &lt;code&gt;Task.WhenAll&lt;/code&gt; to deal with combinations of collections and asynchrony, but what if you need to deal with asynchronous Maybe or Either? Or a List of Maybes?
	&lt;/p&gt;
	&lt;p&gt;
		There may be no existing API to flip things around - before you add it. Now you know that there&apos;s a (dare I say it?) design pattern you can implement.
	&lt;/p&gt;
	&lt;h3 id=&quot;f81375a0121247698f0ad5eac4deebff&quot;&gt;
		Asynchronous Maybe &lt;a href=&quot;#f81375a0121247698f0ad5eac4deebff&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		Once people go beyond collections they often run into problems. You may, for example, decide to use the &lt;a href=&quot;/2022/04/25/the-maybe-monad&quot;&gt;Maybe monad&lt;/a&gt; in order to model the presence or absence of a value. Then, once you combine Maybe-based decision values with asynchronous processesing, you may run into problems.
	&lt;/p&gt;
	&lt;p&gt;
		For example, in my article &lt;a href=&quot;/2019/02/11/asynchronous-injection&quot;&gt;Asynchronous Injection&lt;/a&gt; I modelled the core domaim logic as returning &lt;code&gt;Maybe&amp;lt;Reservation&amp;gt;&lt;/code&gt;. When handling an HTTP request, the application should use that value to determine what to do next. If the return value is empty it should do nothing, but when the Maybe value is populated, it should save the reservation in a data store using this method:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;nbsp;Create(Reservation&amp;nbsp;reservation)&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Finally, if accepting the reservation, the HTTP handler (&lt;code&gt;ReservationsController&lt;/code&gt;) should return the resevation ID, which is the &lt;code&gt;int&lt;/code&gt; returned by &lt;code&gt;Create&lt;/code&gt;. Please refer to the article for details. It also links to the sample code on GitHub.
	&lt;/p&gt;
	&lt;p&gt;
		The entire expression is, however, &lt;code&gt;Task&lt;/code&gt;-based:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IActionResult&amp;gt;&amp;nbsp;Post(Reservation&amp;nbsp;reservation)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.ReadReservations(reservation.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(rs&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.TryAccept(rs,&amp;nbsp;reservation))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.SelectMany(m&amp;nbsp;=&amp;gt;&amp;nbsp;m.Traverse(Repository.Create))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Match(InternalServerError(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Table&amp;nbsp;unavailable&amp;quot;&lt;/span&gt;),&amp;nbsp;Ok);
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		The &lt;code&gt;Select&lt;/code&gt; and &lt;code&gt;SelectMany&lt;/code&gt; methods are defined on the &lt;code&gt;Task&lt;/code&gt; monad. The &lt;code&gt;m&lt;/code&gt; in the &lt;code&gt;SelectMany&lt;/code&gt; lambda expression is the &lt;code&gt;Maybe&amp;lt;Reservation&amp;gt;&lt;/code&gt; returned by &lt;code&gt;TryAccept&lt;/code&gt;. What would happen if you didn&apos;t have a &lt;code&gt;Traverse&lt;/code&gt; method?
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;Maybe&amp;lt;Task&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;whatIsThis&amp;nbsp;=&amp;nbsp;Repository.ReadReservations(reservation.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(rs&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.TryAccept(rs,&amp;nbsp;reservation))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(m&amp;nbsp;=&amp;gt;&amp;nbsp;m.Select(Repository.Create));&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Notice that &lt;code&gt;whatIsThis&lt;/code&gt; (so named because it&apos;s a temporary variable used to investigate the type of the expression so far) has an awkward type: &lt;code&gt;Task&amp;lt;Maybe&amp;lt;Task&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/code&gt;. That&apos;s a Task within a Maybe within a Task.
	&lt;/p&gt;
	&lt;p&gt;
		This makes it difficult to continue the composition and return an HTTP result.
	&lt;/p&gt;
	&lt;p&gt;
		Instead, use &lt;code&gt;Traverse&lt;/code&gt;:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;Task&amp;lt;Task&amp;lt;Maybe&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt;&amp;nbsp;whatIsThis&amp;nbsp;=&amp;nbsp;Repository.ReadReservations(reservation.Date)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(rs&amp;nbsp;=&amp;gt;&amp;nbsp;maîtreD.TryAccept(rs,&amp;nbsp;reservation))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(m&amp;nbsp;=&amp;gt;&amp;nbsp;m.Traverse(Repository.Create));&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		This flips the inner &lt;code&gt;Maybe&amp;lt;Task&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; to &lt;code&gt;Task&amp;lt;Maybe&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;. Now you have a Maybe within a Task within a Task. The outer two Tasks are now nicely nested, and it&apos;s a job for a monad to remove one level of nesting. That&apos;s the reason that the final composition uses &lt;code&gt;SelectMany&lt;/code&gt; instead of &lt;code&gt;Select&lt;/code&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		The &lt;code&gt;Traverse&lt;/code&gt; function is implemented like this:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;Task&amp;lt;Maybe&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;Traverse&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;Maybe&amp;lt;T&amp;gt;&amp;nbsp;source,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Func&amp;lt;T,&amp;nbsp;Task&amp;lt;TResult&amp;gt;&amp;gt;&amp;nbsp;selector)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;source.Match(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;nothing:&amp;nbsp;Task.FromResult(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;Maybe&amp;lt;TResult&amp;gt;()),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;just:&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;x&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;Maybe&amp;lt;TResult&amp;gt;(&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;selector(x)));
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		The &lt;em&gt;idea&lt;/em&gt; is reusable. You can also implement a similar traversal in F#:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;(&amp;#39;a&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;&amp;#39;b&amp;gt;)&amp;nbsp;-&amp;gt;&amp;nbsp;&amp;#39;a&amp;nbsp;option&amp;nbsp;-&amp;gt;&amp;nbsp;Async&amp;lt;&amp;#39;b&amp;nbsp;option&amp;gt;&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;traverse&amp;nbsp;f&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;function&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;Some&amp;nbsp;x&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;async&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;x&amp;#39;&amp;nbsp;=&amp;nbsp;f&amp;nbsp;x
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Some&amp;nbsp;x&amp;#39;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;None&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;async&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;None&amp;nbsp;}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		You can see the F# function as well as a usage example in the article &lt;a href=&quot;/2019/12/02/refactoring-registration-flow-to-functional-architecture&quot;&gt;Refactoring registration flow to functional architecture&lt;/a&gt;.
	&lt;/p&gt;
	&lt;h3 id=&quot;a9e25f8c3dc24d99b669f90a4e46afa0&quot;&gt;
		Sequence from traverse &lt;a href=&quot;#a9e25f8c3dc24d99b669f90a4e46afa0&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		You&apos;ve already seen that if you have a &lt;em&gt;sequence&lt;/em&gt; function, you can implement &lt;em&gt;traverse&lt;/em&gt;. I also claimed that the reverse is true: If you have &lt;em&gt;traverse&lt;/em&gt; you can implement &lt;em&gt;sequence&lt;/em&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		When you&apos;ve encountered these kinds of dual definitions a couple of times, you start to expect the ubiquitous identity function to make an appearance, and indeed it does:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sequence&amp;nbsp;x&amp;nbsp;=&amp;nbsp;traverse&amp;nbsp;id&amp;nbsp;x&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		That&apos;s the F# version where the identity function is built in as &lt;code&gt;id&lt;/code&gt;. In C# you&apos;d use a lambda expression:
	&lt;/p&gt;
	&lt;p&gt;
		&lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;Task&amp;lt;Maybe&amp;lt;T&amp;gt;&amp;gt;&amp;nbsp;Sequence&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;Maybe&amp;lt;Task&amp;lt;T&amp;gt;&amp;gt;&amp;nbsp;source)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;source.Traverse(x&amp;nbsp;=&amp;gt;&amp;nbsp;x);
}&lt;/pre&gt;
	&lt;/p&gt;
	&lt;p&gt;
		Since C# doesn&apos;t come with a predefined identity function, it&apos;s &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; to use &lt;code&gt;x&amp;nbsp;=&amp;gt;&amp;nbsp;x&lt;/code&gt; instead.
	&lt;/p&gt;
	&lt;h3 id=&quot;cc6c409706e24ea9b3ebefa49fcc3235&quot;&gt;
		Conclusion &lt;a href=&quot;#cc6c409706e24ea9b3ebefa49fcc3235&quot; title=&quot;permalink&quot;&gt;#&lt;/a&gt;
	&lt;/h3&gt;
	&lt;p&gt;
		Traversals are useful when you need to &apos;flip&apos; the order of two different, nested functors. The outer one must be a traversable functor, and the inner an applicative functor.
	&lt;/p&gt;
	&lt;p&gt;
		Common traversable functors are List, Maybe, Either, Tree, and Identity, but there are more than those. In .NET you often need them when combining them with Tasks. In Haskell, they are useful when combined with &lt;code&gt;IO&lt;/code&gt;.
	&lt;/p&gt;
	&lt;p&gt;
		&lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2024/11/25/nested-monads&quot;&gt;Nested monads&lt;/a&gt;.
	&lt;/p&gt;
&lt;/div&gt;

&lt;div id=&quot;comments&quot;&gt;
    &lt;hr&gt;
    &lt;h2 id=&quot;comments-header&quot;&gt;
        Comments
    &lt;/h2&gt;
    &lt;div class=&quot;comment&quot; id=&quot;c72c30e16cdd48419f95fd7ad5c74f81&quot;&gt;
        &lt;div class=&quot;comment-author&quot;&gt;qfilip &lt;a href=&quot;#c72c30e16cdd48419f95fd7ad5c74f81&quot;&gt;#&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;comment-content&quot;&gt;
            &lt;p&gt;
				Thanks for this one. You might be interested in &lt;a href=&quot;https://andrewlock.net/working-with-the-result-pattern-part-1-replacing-exceptions-as-control-flow/&quot;&gt;Andrew Lock&apos;s&lt;/a&gt; take on the whole subject as well.
			&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class=&quot;comment-date&quot;&gt;2024-11-17 14:51 UTC&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/11/11/traversals</guid>
      </item>
    
      <item>
        <title>Pendulum swing: no Haskell type annotation by default</title>
        <link>https://blog.ploeh.dk/2024/11/04/pendulum-swing-no-haskell-type-annotation-by-default/</link>
        <pubDate>Mon, 04 Nov 2024 07:45:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Are Haskell IDE plugins now good enough that you don&apos;t need explicit type annotations?&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        More than three years ago, I published &lt;a href=&quot;/2021/02/22/pendulum-swings&quot;&gt;a small article series&lt;/a&gt; to document that I&apos;d changed my mind on various small practices. Belatedly, here comes a fourth article, which, frankly, is a cousin rather than a sibling. Still, it fits the overall theme well enough to become another instalment in the series.
    &lt;/p&gt;
    &lt;p&gt;
        Here, I consider using fewer &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; type annotations, following a practice that I&apos;ve always followed in &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, though, it&apos;s not that I&apos;ve already applied the following practice for a long time, and only now write about it. It&apos;s rather that I feel the need to write this article to kick an old habit and start a new.
    &lt;/p&gt;
    &lt;h3 id=&quot;227874a509f24b93b9a091429b9ad03e&quot;&gt;
        Inertia &lt;a href=&quot;#227874a509f24b93b9a091429b9ad03e&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As I write in the dedication in &lt;a href=&quot;/2021/06/14/new-book-code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;,
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;To my parents:
        &lt;/p&gt;
        &lt;p&gt;
            &quot;My mother, Ulla Seemann, to whom I owe my attention to detail.
        &lt;/p&gt;
        &lt;p&gt;
            &quot;My father, Leif Seemann, from whom I inherited my contrarian streak.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;&lt;/cite&gt;, dedication&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        One should always be careful simplifying one&apos;s personality to a simple, easy-to-understand model, but a major point here is that I have two traits that pull in almost the opposite direction.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/neatness-contrariness-vector-sum.png&quot; alt=&quot;Two vectors labelled respectively neatness and contrariness pulling in almost opposing directions, while still not quite cancelling each other out, leaving a short vector sum pointing to the right.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Despite much work, I only make slow progress. My desire to make things neat and proper almost cancel out my tendency to go against the norms. I tend to automatically toe whatever line that exists until the cognitive dissonance becomes so great that I can no longer ignore it.
    &lt;/p&gt;
    &lt;p&gt;
        I then write an article for the blog to clarify my thoughts.
    &lt;/p&gt;
    &lt;p&gt;
        You may read what comes next and ask, &lt;em&gt;what took you so long?!&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I can only refer to the above. I may look calm on the surface, but underneath I&apos;m paddling like the dickens. Despite much work, though, only limited progress is visible.
    &lt;/p&gt;
    &lt;h3 id=&quot;a00a292d223a435b873f7cc1de1730c3&quot;&gt;
        Nudge &lt;a href=&quot;#a00a292d223a435b873f7cc1de1730c3&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Haskell is a statically typed language with the most powerful type system I know my way around. The types carry so much information that one can often infer &lt;a href=&quot;/2022/10/24/encapsulation-in-functional-programming&quot;&gt;a function&apos;s contract&lt;/a&gt; from the type alone. This is also fortunate, since many Haskell libraries tend to have, shall we say, minimal documentation. Even so, I&apos;ve often found myself able to figure out how to use an unfamiliar Haskell API by examining the various types that a library exports.
    &lt;/p&gt;
    &lt;p&gt;
        In fact, the type system is so powerful that it drives &lt;a href=&quot;https://hoogle.haskell.org/&quot;&gt;a specialized search engine&lt;/a&gt;. If you need a function with the type &lt;code&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;]&lt;/code&gt; you can search for it. Hoogle will list all functions that match that type, including functions that are more abstract than your specialized need. You don&apos;t even have to imagine what the name might be.
    &lt;/p&gt;
    &lt;p&gt;
        Since the type system is so powerful, it&apos;s a major means of communication. Thus, it makes sense that &lt;a href=&quot;https://en.wikipedia.org/wiki/Glasgow_Haskell_Compiler&quot;&gt;GHC&lt;/a&gt; regularly issues &lt;a href=&quot;https://downloads.haskell.org/ghc/latest/docs/users_guide/using-warnings.html#ghc-flag--Wmissing-signatures&quot;&gt;a warning&lt;/a&gt; if a function lacks a type annotation.
    &lt;/p&gt;
    &lt;p&gt;
        While the compiler enables you to control which warnings are turned on, the &lt;code&gt;missing-signatures&lt;/code&gt; warning is included in the popular &lt;a href=&quot;https://downloads.haskell.org/ghc/latest/docs/users_guide/using-warnings.html#ghc-flag--Wall&quot;&gt;all&lt;/a&gt; flag that most people, I take it, use. I do, at least.
    &lt;/p&gt;
    &lt;p&gt;
        If you forget to declare the type of a function, the compiler will complain:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;src\SecurityManager.hs:15:1: &lt;span style=&quot;color:red;&quot;&gt;warning&lt;/span&gt;: [&lt;span style=&quot;color:red;&quot;&gt;GHC-38417&lt;/span&gt;] [&lt;span style=&quot;color:red;&quot;&gt;-Wmissing-signatures&lt;/span&gt;]
    Top-level binding with no type signature:
      createUser :: (Monad m, Text.Printf.PrintfArg b,
                     Text.Printf.PrintfArg (t a), Foldable t, Eq (t a)) =&amp;gt;
                    (String -&amp;gt; m ()) -&amp;gt; m (t a) -&amp;gt; (t a -&amp;gt; b) -&amp;gt; m ()
&lt;span style=&quot;color:blue;&quot;&gt;   |&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;15 |&lt;/span&gt; &lt;span style=&quot;color:red;&quot;&gt;createUser&lt;/span&gt; writeLine readLine encrypt = do
&lt;span style=&quot;color:blue;&quot;&gt;   |&lt;/span&gt; &lt;span style=&quot;color:red;&quot;&gt;^^^^^^^^^^&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is a strong nudge that you&apos;re supposed to give each function a type declaration, so I&apos;ve been doing that for years. Neat and proper.
    &lt;/p&gt;
    &lt;p&gt;
        Of course, if you treat warnings as errors, as &lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;I recommend&lt;/a&gt;, the nudge becomes a law.
    &lt;/p&gt;
    &lt;h3 id=&quot;cf16318003ef46ed8c67d81217e56011&quot;&gt;
        Learning from F# &lt;a href=&quot;#cf16318003ef46ed8c67d81217e56011&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        While I try to adopt the style and &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idioms&lt;/a&gt; of any language I work in, it&apos;s always annoyed me that I had to add a type annotation to a Haskell function. After all, the compiler can usually infer the type. Frankly, adding a type signature feels like redundant ceremony. It&apos;s like having to declare a function in a header file before being able to implement it in another file.
    &lt;/p&gt;
    &lt;p&gt;
        This particularly bothers me because I&apos;ve long since abandoned type annotations in F#. As far as I can tell, most of the F# community has, too.
    &lt;/p&gt;
    &lt;p&gt;
        When you implement an F# function, you just write the implementation and let the compiler infer the type. (Code example from &lt;a href=&quot;/2019/12/16/zone-of-ceremony&quot;&gt;Zone of Ceremony&lt;/a&gt;.)
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;inline&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;consume&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;quantity&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;go&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;xs&lt;/span&gt;)&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;quantity&lt;/span&gt;&amp;nbsp;&amp;lt;=&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;then&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;append&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;xs&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;singleton&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;x&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;else&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;&amp;nbsp;+&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;x&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;xs&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;fold&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;go&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;LanguagePrimitives&lt;/span&gt;.GenericZero,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.empty)&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;snd&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since F# often has to interact with .NET code written in C#, you regularly have to add &lt;em&gt;some&lt;/em&gt; type annotations to help the compiler along:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;average&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;timeSpans&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;NonEmpty&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&amp;gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;[&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;timeSpans&lt;/span&gt;.Head&amp;nbsp;]&amp;nbsp;@&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;ofSeq&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;timeSpans&lt;/span&gt;.Tail
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;averageBy&lt;/span&gt;&amp;nbsp;(_.Ticks&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;double&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;int64&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;FromTicks&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Even so, I follow the rule of minimal annotations: Only add the type information required to compile, and let the compiler infer the rest. For example, the above &lt;a href=&quot;/2024/05/06/conservative-codomain-conjecture&quot;&gt;average function&lt;/a&gt; has the inferred type &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;NonEmpty&lt;/span&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&lt;/code&gt;. While I had to specify the input type in order to be able to use the &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.datetime.ticks&quot;&gt;Ticks property&lt;/a&gt;, I didn&apos;t have to specify the return type. So I didn&apos;t.
    &lt;/p&gt;
    &lt;p&gt;
        My impression from reading other people&apos;s F# code is that this is a common, albeit not universal, approach to type annotation.
    &lt;/p&gt;
    &lt;p&gt;
        This minimizes ceremony, since you only need to declare and maintain the types that the compiler can&apos;t infer. There&apos;s no reason to repeat the work that the compiler can already do, and in practice, if you do, it just gets in the way.
    &lt;/p&gt;
    &lt;h3 id=&quot;fdd9161164f64f438aa0bedf5ff6f9a8&quot;&gt;
        Motivation for explicit type definitions &lt;a href=&quot;#fdd9161164f64f438aa0bedf5ff6f9a8&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        When I extol the merits of static types, proponents of dynamically typed languages often argue that the types are in the way. Granted, this is &lt;a href=&quot;/2021/08/09/am-i-stuck-in-a-local-maximum&quot;&gt;a discussion that I still struggle with&lt;/a&gt;, but based on my understanding of the argument, it seems entirely reasonable. After all, if you have to spend time declaring the type of each and every parameter, as well as a function&apos;s return type, it does seem to be in the way. This is only exacerbated if you later change your mind.
    &lt;/p&gt;
    &lt;p&gt;
        Programming is, to a large extend, an explorative activity. You start with one notion of how your code should be structured, but as you progress, you learn. You&apos;ll often have to go back and change existing code. This, as far as I can tell, is much easier in, say, &lt;a href=&quot;https://www.python.org/&quot;&gt;Python&lt;/a&gt; or &lt;a href=&quot;https://clojure.org/&quot;&gt;Clojure&lt;/a&gt; than in C# or &lt;a href=&quot;https://www.java.com/&quot;&gt;Java&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If, however, one extrapolates from the experience with Java or C# to all statically typed languages, that would be a logical fallacy. My point with &lt;a href=&quot;/2019/12/16/zone-of-ceremony&quot;&gt;Zone of Ceremony&lt;/a&gt; was exactly that there&apos;s a group of languages &apos;to the right&apos; of high-ceremony languages with low levels of ceremony. Even though they&apos;re statically typed.
    &lt;/p&gt;
    &lt;p&gt;
        I have to admit, however, that in that article I cheated a little in order to drive home a point. While you &lt;em&gt;can&lt;/em&gt; write Haskell code in a low-ceremony style, the tooling (in the form of the &lt;code&gt;all&lt;/code&gt; warning set, at least) encourages a high-ceremony style. Add those type definitions, even thought they&apos;re redundant.
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s not that I don&apos;t understand some of the underlying motivation behind that rule. &lt;a href=&quot;http://dmwit.com/&quot;&gt;Daniel Wagner&lt;/a&gt; enumerated several reasons in &lt;a href=&quot;https://stackoverflow.com/a/19626857/126014&quot;&gt;a 2013 Stack Overflow answer&lt;/a&gt;. Some of the reasons still apply, but on the other hand, the world has also moved on in the intervening decade.
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, the Haskell &lt;a href=&quot;https://en.wikipedia.org/wiki/Integrated_development_environment&quot;&gt;IDE&lt;/a&gt; situation has always been precarious. One day, it works really well; the next day, I struggle with it. Over the years, though, things have improved.
    &lt;/p&gt;
    &lt;p&gt;
        There was a time when an explicit type definition was a indisputable help, because you couldn&apos;t rely on tools to light up and tell you what the inferred type was.
    &lt;/p&gt;
    &lt;p&gt;
        Today, on the other hand, the &lt;a href=&quot;https://marketplace.visualstudio.com/items?itemName=haskell.haskell&quot;&gt;Haskell extension for Visual Studio Code&lt;/a&gt; automatically displays the inferred type above a function implementation:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/haskell-code-with-inferred-type-displayed-by-vs-code.png&quot; alt=&quot;Screen shot of a Haskell function in Visual Studio Code with the function&apos;s type automatically displayed above it by the Haskell extension.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        To be clear, the top line that shows the type definition is not part of the source code. It&apos;s just shown by Visual Studio Code as a code lens (I think it&apos;s called), and it automatically changes if I edit the code in such a way that the type changes.
    &lt;/p&gt;
    &lt;p&gt;
        If you can rely on such automatic type information, it seems that an explicit type declaration is less useful. It&apos;s at least one less reason to add type annotations to the source code.
    &lt;/p&gt;
    &lt;h3 id=&quot;367135868de54bcb8eebd2d9bc9a0f8c&quot;&gt;
        Ceremony example &lt;a href=&quot;#367135868de54bcb8eebd2d9bc9a0f8c&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In order to explain what I mean by &lt;em&gt;the types being in the way&lt;/em&gt;, I&apos;ll give an example. Consider the code example from the article &lt;a href=&quot;/2024/10/21/legacy-security-manager-in-haskell&quot;&gt;Legacy Security Manager in Haskell&lt;/a&gt;. In it, I described how every time I made a change to the &lt;code&gt;createUser&lt;/code&gt; action, I had to effectively remove and re-add the type declaration.
    &lt;/p&gt;
    &lt;p&gt;
        It doesn&apos;t have to be like that. If instead I&apos;d started without type annotations, I could have moved forward without being slowed down by having to edit type definitions. Take the first edit, breaking the dependency on the console, as an example. Without type annotations, the &lt;code&gt;createUser&lt;/code&gt; action would look exactly as before, just without the type declaration. Its type would still be &lt;code&gt;IO ()&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        After the first edit, the first lines of the action now look like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;createUser&amp;nbsp;writeLine&amp;nbsp;readLine&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;()&lt;/span&gt;&amp;nbsp;&amp;lt;-&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;a&amp;nbsp;username&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;...&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Even without a type definition, the action still has a type. The compiler infers it to be &lt;code&gt;(&lt;span style=&quot;color:blue;&quot;&gt;Monad&lt;/span&gt;&amp;nbsp;m,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Eq&lt;/span&gt;&amp;nbsp;a,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;IsChar&lt;/span&gt;&amp;nbsp;a)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;=&amp;gt;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;())&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;[a]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/code&gt;, which is certainly a bit of a mouthful, but exactly what I had explicitly added in the other article.
    &lt;/p&gt;
    &lt;p&gt;
        The code doesn&apos;t compile until I also change the &lt;code&gt;main&lt;/code&gt; method to pass the new parameters:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;main&amp;nbsp;=&amp;nbsp;createUser&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;putStrLn&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;getLine&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;d have to make a similar edit in, say, Python, although there&apos;d be no compiler to remind you. My point isn&apos;t that this is better than a dynamically typed language, but rather that it&apos;s on par. The types aren&apos;t in the way.
    &lt;/p&gt;
    &lt;p&gt;
        We see the similar lack of required ceremony when the &lt;code&gt;createUser&lt;/code&gt; action finally pulls in the &lt;code&gt;comparePasswords&lt;/code&gt; and &lt;code&gt;validatePassword&lt;/code&gt; functions:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;createUser&amp;nbsp;writeLine&amp;nbsp;readLine&amp;nbsp;encrypt&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;()&lt;/span&gt;&amp;nbsp;&amp;lt;-&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;a&amp;nbsp;username&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;username&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;your&amp;nbsp;full&amp;nbsp;name&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;fullName&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;your&amp;nbsp;password&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;password&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Re-enter&amp;nbsp;your&amp;nbsp;password&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;confirmPassword&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
 
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;$&amp;nbsp;either
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;id&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(printf&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Saving&amp;nbsp;Details&amp;nbsp;for&amp;nbsp;User&amp;nbsp;(%s,&amp;nbsp;%s,&amp;nbsp;%s)&amp;quot;&lt;/span&gt;&amp;nbsp;username&amp;nbsp;fullName&amp;nbsp;.&amp;nbsp;encrypt)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(validatePassword&amp;nbsp;=&amp;lt;&amp;lt;&amp;nbsp;comparePasswords&amp;nbsp;password&amp;nbsp;confirmPassword)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Again, there&apos;s no type annotation, and while the type actually &lt;em&gt;does&lt;/em&gt; change to
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;(&lt;span style=&quot;color:blue;&quot;&gt;Monad&lt;/span&gt;&amp;nbsp;m,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;PrintfArg&lt;/span&gt;&amp;nbsp;b,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;PrintfArg&lt;/span&gt;&amp;nbsp;(t&amp;nbsp;a),&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Foldable&lt;/span&gt;&amp;nbsp;t,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Eq&lt;/span&gt;&amp;nbsp;(t&amp;nbsp;a))&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;=&amp;gt;&lt;/span&gt;
(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;())&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;(t&amp;nbsp;a)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;(t&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;b)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        it impacts none of the existing code. Again, the types aren&apos;t in the way, and no ceremony is required.
    &lt;/p&gt;
    &lt;p&gt;
        Compare that inferred type signature with the explicit final type annotation in &lt;a href=&quot;/2024/10/21/legacy-security-manager-in-haskell&quot;&gt;the previous article&lt;/a&gt;. The inferred type is much more abstract and permissive than the explicit declaration, although I also grant that Daniel Wagner had a point that you can make explicit type definitions more reader-friendly.
    &lt;/p&gt;
    &lt;h3 id=&quot;d4469073def54f289edb56d1ca8417ee&quot;&gt;
        Flies in the ointment &lt;a href=&quot;#d4469073def54f289edb56d1ca8417ee&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Do the inferred types communicate intent? That&apos;s debatable. For example, it&apos;s not immediately clear that the above &lt;code&gt;t a&lt;/code&gt; allows &lt;code&gt;String&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Another thing that annoys me is that I had to add that &lt;em&gt;unit&lt;/em&gt; binding on the first line:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;createUser&amp;nbsp;writeLine&amp;nbsp;readLine&amp;nbsp;encrypt&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;()&lt;/span&gt;&amp;nbsp;&amp;lt;-&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;a&amp;nbsp;username&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;...&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The reason for that is that if I don&apos;t do that (that is, if I just write &lt;code&gt;writeLine &quot;Xyz&quot;&lt;/code&gt; all the way), the compiler infers the type of &lt;code&gt;writeLine&lt;/code&gt; to be &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;b2&lt;/code&gt;, rather than just &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/code&gt;. In effect, I want &lt;code&gt;b2 ~ ()&lt;/code&gt;, but because the compiler thinks that &lt;code&gt;b2&lt;/code&gt; may be anything, it issues an &lt;a href=&quot;https://downloads.haskell.org/ghc/latest/docs/users_guide/using-warnings.html#ghc-flag--Wunused-do-bind&quot;&gt;unused-do-bind&lt;/a&gt; warning.
    &lt;/p&gt;
    &lt;p&gt;
        The idiomatic way to resolve that situation is to add a type definition, but that&apos;s the situation I&apos;m trying to avoid. Thus, my desire to do without annotations pushes me to write unnatural implementation code. This reminds me of the notion of &lt;a href=&quot;https://dhh.dk/2014/test-induced-design-damage.html&quot;&gt;test-induced damage&lt;/a&gt;. This is at best a disagreeable compromise.
    &lt;/p&gt;
    &lt;p&gt;
        It also annoys me that implementation details leak out to the inferred type, witnessed by the &lt;code&gt;PrintfArg&lt;/code&gt; type constraint. What happens if I change the implementation to use list concatenation?
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;createUser&amp;nbsp;writeLine&amp;nbsp;readLine&amp;nbsp;encrypt&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;()&lt;/span&gt;&amp;nbsp;&amp;lt;-&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;a&amp;nbsp;username&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;username&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;your&amp;nbsp;full&amp;nbsp;name&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;fullName&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Enter&amp;nbsp;your&amp;nbsp;password&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;password&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Re-enter&amp;nbsp;your&amp;nbsp;password&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;confirmPassword&amp;nbsp;&amp;lt;-&amp;nbsp;readLine
 
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;createMsg&amp;nbsp;pwd&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Saving&amp;nbsp;Details&amp;nbsp;for&amp;nbsp;User&amp;nbsp;(&amp;quot;&lt;/span&gt;&amp;nbsp;++&amp;nbsp;username&amp;nbsp;++&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;,&amp;nbsp;&amp;quot;&lt;/span&gt;&amp;nbsp;++&amp;nbsp;fullName&amp;nbsp;++&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;,&amp;nbsp;&amp;quot;&lt;/span&gt;&amp;nbsp;++&amp;nbsp;pwd&amp;nbsp;++&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;)&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;writeLine&amp;nbsp;$&amp;nbsp;either
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;id&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(createMsg&amp;nbsp;.&amp;nbsp;encrypt)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(validatePassword&amp;nbsp;=&amp;lt;&amp;lt;&amp;nbsp;comparePasswords&amp;nbsp;password&amp;nbsp;confirmPassword)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If I do that, the type also changes:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;Monad&lt;/span&gt;&amp;nbsp;m&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;=&amp;gt;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;())&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Char&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;([&lt;span style=&quot;color:#2b91af;&quot;&gt;Char&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Char&lt;/span&gt;])&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        While we get rid of the &lt;code&gt;PrintfArg&lt;/code&gt; type constraint, the type becomes otherwise more concrete, now operating on &lt;code&gt;String&lt;/code&gt; values (keeping in mind that &lt;code&gt;String&lt;/code&gt; is a type synonym for &lt;code&gt;[Char]&lt;/code&gt;).
    &lt;/p&gt;
    &lt;p&gt;
        The code still compiles, and all tests still pass, because the abstraction I&apos;ve had in mind all along is essentially this last type.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;writeLine&lt;/code&gt; action should take a &lt;code&gt;String&lt;/code&gt; and have some side effect, but return no data. The type &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/code&gt; nicely models that, striking a fine balance between being sufficiently concrete to capture intent, but still abstract enough to be testable.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;readLine&lt;/code&gt; action should provide input &lt;code&gt;String&lt;/code&gt; values, and again &lt;code&gt;m String&lt;/code&gt; nicely models that concern.
    &lt;/p&gt;
    &lt;p&gt;
        Finally, &lt;code&gt;encrypt&lt;/code&gt; is indeed a naked &lt;code&gt;String&lt;/code&gt; &lt;a href=&quot;https://en.wikipedia.org/wiki/Endomorphism&quot;&gt;endomorphism&lt;/a&gt;: &lt;code&gt;String -&amp;gt; String&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        With my decades of experience with object-oriented design, it still strikes me as odd that implementation details can make a type more abstract, but once you think it over, it may be okay.
    &lt;/p&gt;
    &lt;h3 id=&quot;a82d4017be064ce980c40e22aa6f801e&quot;&gt;
        More liberal abstractions &lt;a href=&quot;#a82d4017be064ce980c40e22aa6f801e&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The inferred types are consistently more liberal than the abstraction I have in mind, which is
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;Monad&lt;/span&gt;&amp;nbsp;m&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;=&amp;gt;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;())&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;m&amp;nbsp;()&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In all cases, the inferred types include that type as a subset.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/create-user-abstraction-sets.png&quot; alt=&quot;Various sets of inferred types.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I hope that I&apos;ve created the above diagram so that it makes sense, but the point I&apos;m trying to get across is that the two type definitions in the lower middle are equivalent, and are the most specific types. That&apos;s the intended abstraction. Thinking of &lt;a href=&quot;/2021/11/15/types-as-sets&quot;&gt;types as sets&lt;/a&gt;, all the other inferred types are supersets of that type, in various ways. Even though implementation details leak out in the shape of &lt;code&gt;PrintfArg&lt;/code&gt; and &lt;code&gt;IsChar&lt;/code&gt;, these are effectually larger sets.
    &lt;/p&gt;
    &lt;p&gt;
        This takes some getting used to: The implementation details are &lt;em&gt;more&lt;/em&gt; liberal than the abstraction. This seems to be at odds with the &lt;a href=&quot;https://en.wikipedia.org/wiki/Dependency_inversion_principle&quot;&gt;Dependency Inversion Principle&lt;/a&gt; (DIP), which suggests that abstractions shouldn&apos;t depend on implementation details. I&apos;m not yet sure what to make of this, but I suspect that this is more of problem of overlapping linguistic semantics than software design. What I mean is that I have a feeling that &apos;implementation detail&apos; have more than one meaning. At least, in the perspective of the DIP, an implementation detail &lt;em&gt;limits&lt;/em&gt; your options. For example, depending on a particular database technology is more constraining than depending on some abstract notion of what the persistence mechanism might be. Contrast this with an implementation detail such as the &lt;code&gt;PrintfArg&lt;/code&gt; type constraint. It doesn&apos;t narrow your options; on the contrary, it makes the implementation more liberal.
    &lt;/p&gt;
    &lt;p&gt;
        Still, while an implementation should &lt;a href=&quot;https://en.wikipedia.org/wiki/Robustness_principle&quot;&gt;be liberal in what it accepts&lt;/a&gt;, it&apos;s probably not a good idea to publish such a capability to the wider world. After all, if you do, &lt;a href=&quot;https://www.hyrumslaw.com/&quot;&gt;someone will eventually rely on it&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;42ffe5249c7542809ca55a95a8f15f6c&quot;&gt;
        For internal use only &lt;a href=&quot;#42ffe5249c7542809ca55a95a8f15f6c&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Going through all these considerations, I think I&apos;ll revise my position as the following.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll forgo type annotations as long as I explore a problem space. For internal application use, this may effectively mean forever, in the sense that how you compose an application from smaller building blocks is likely to be in permanent flux. Here I have in mind your average web asset or other public-facing service that&apos;s in constant development. You keep adding new features, or changing domain logic as the overall business evolves.
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve also recently discussed, &lt;a href=&quot;/2024/02/05/statically-and-dynamically-typed-scripts&quot;&gt;Haskell is a great scripting language&lt;/a&gt;, and I think that here, too, I&apos;ll dial down the type definitions.
    &lt;/p&gt;
    &lt;p&gt;
        If I ever do another &lt;a href=&quot;https://adventofcode.com/&quot;&gt;Advent of Code&lt;/a&gt; in Haskell, I think I&apos;ll also eschew explicit type annotations.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, I can see that once an API stabilizes, you may want to lock it down. This may also apply to internal abstractions if you&apos;re working in a team and you explicitly want to communicate what a contract is.
    &lt;/p&gt;
    &lt;p&gt;
        If the code is a reusable library, I think that explicit type definitions are still required. Both for the reasons outlined by Daniel Wagner, and also to avoid being the victim of &lt;a href=&quot;https://www.hyrumslaw.com/&quot;&gt;Hyrum&apos;s law&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        That&apos;s why I phrase this pendulum swing as a new &lt;em&gt;default&lt;/em&gt;. I&apos;ll begin programming without type definitions, but add them as needed. The point is rather that there may be parts of a code base where they&apos;re never needed, and then it&apos;s okay to keep going without them.
    &lt;/p&gt;
    &lt;p&gt;
        You can use a language pragma to opt out of the &lt;code&gt;missing-signatures&lt;/code&gt; compiler warning on a module-by-module basis:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;{-#&amp;nbsp;&lt;span style=&quot;color:gray;&quot;&gt;OPTIONS_GHC&lt;/span&gt;&amp;nbsp;-Wno-missing-signatures&amp;nbsp;#-}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This will enable me to rely on type inference in parts of the code base, while keeping the build clean of compiler warnings.
    &lt;/p&gt;
    &lt;h3 id=&quot;36e2b141fff548678e34d24eda5a3e03&quot;&gt;
        Conclusion &lt;a href=&quot;#36e2b141fff548678e34d24eda5a3e03&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I&apos;ve always appreciated the F# compiler&apos;s ability to infer types and just let type changes automatically ripple through the code base. For that reason, the Haskell norm of explicitly adding a (redundant) type annotation has always vexed me.
    &lt;/p&gt;
    &lt;p&gt;
        It often takes me a long time to reach seemingly obvious conclusions, such as: Don&apos;t always add type definitions to Haskell functions. Let the type inference engine do its job.
    &lt;/p&gt;
    &lt;p&gt;
        The reason it takes me so long to take such a small step is that I want to follow &apos;best practice&apos;; I want to write idiomatic code. When the standard compiler-warning set complains about missing type definitions, it takes me significant deliberation to discard such advice. I could imagine other programmers being in the same situation, which is one reason I wrote this article.
    &lt;/p&gt;
    &lt;p&gt;
        The point isn&apos;t that type definitions are a universally bad idea. They aren&apos;t. Rather, the point is only that it&apos;s also okay to do without them in parts of a code base. Perhaps only temporarily, but in some cases maybe permanently.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;missing-signatures&lt;/code&gt; warning shouldn&apos;t, I now believe, be considered an absolute law, but rather a contextual rule.
    &lt;/p&gt;
&lt;/div&gt;
&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/11/04/pendulum-swing-no-haskell-type-annotation-by-default</guid>
      </item>
    
      <item>
        <title>Functor compositions</title>
        <link>https://blog.ploeh.dk/2024/10/28/functor-compositions/</link>
        <pubDate>Mon, 28 Oct 2024 06:58:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A functor nested within another functor forms a functor. With examples in C# and another language.&lt;/em&gt;
    &lt;/p&gt;
	&lt;p&gt;
		This article is part of &lt;a href=&quot;/2022/07/11/functor-relationships&quot;&gt;a series of articles about functor relationships&lt;/a&gt;. In this one you&apos;ll learn about a universal composition of functors. In short, if you have one functor nested within another functor, then this composition itself gives rise to a functor.
	&lt;/p&gt;
    &lt;p&gt;
        Together with other articles in this series, this result can help you answer questions such as: &lt;em&gt;Does this data structure form a functor?&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since &lt;a href=&quot;/2018/03/22/functors&quot;&gt;functors&lt;/a&gt; tend to be quite common, and since they&apos;re useful enough that many programming languages have special support or syntax for them, the ability to recognize a potential functor can be useful. Given a type like &lt;code&gt;Foo&amp;lt;T&amp;gt;&lt;/code&gt; (C# syntax) or &lt;code&gt;Bar&amp;lt;T1, T2&amp;gt;&lt;/code&gt;, being able to recognize it as a functor can come in handy. One scenario is if you yourself have just defined this data type. Recognizing that it&apos;s a functor strongly suggests that you should give it a &lt;code&gt;Select&lt;/code&gt; method in C#, a &lt;code&gt;map&lt;/code&gt; function in &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt;, and so on.
    &lt;/p&gt;
    &lt;p&gt;
        Not all generic types give rise to a (covariant) functor. Some are rather &lt;a href=&quot;/2021/09/02/contravariant-functors&quot;&gt;contravariant functors&lt;/a&gt;, and some are &lt;a href=&quot;/2022/08/01/invariant-functors&quot;&gt;invariant&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If, on the other hand, you have a data type where one functor is nested within another functor, then the data type itself gives rise to a functor. You&apos;ll see some examples in this article.
    &lt;/p&gt;
    &lt;h3 id=&quot;a97b2f6471b74db6a83362a552ee5b03&quot;&gt;
        Abstract shape &lt;a href=&quot;#a97b2f6471b74db6a83362a552ee5b03&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Before we look at some examples found in other code, it helps if we know what we&apos;re looking for. Imagine that you have two functors &lt;code&gt;F&lt;/code&gt; and &lt;code&gt;G&lt;/code&gt;, and you&apos;re now considering a data structure that contains a value where &lt;code&gt;G&lt;/code&gt; is nested inside of &lt;code&gt;F&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;F&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;G&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;ginf;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;F&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;G&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ginf&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;.ginf&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ginf&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Methods&amp;nbsp;go&amp;nbsp;here...&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; class has a single class field. The type of this field is an &lt;code&gt;F&lt;/code&gt; &lt;a href=&quot;https://bartoszmilewski.com/2014/01/14/functors-are-containers/&quot;&gt;container&lt;/a&gt;, but &apos;inside&apos; &lt;code&gt;F&lt;/code&gt; there&apos;s a &lt;code&gt;G&lt;/code&gt; functor.
    &lt;/p&gt;
    &lt;p&gt;
        This kind of data structure gives rise to a functor. Knowing that, you can give it a &lt;code&gt;Select&lt;/code&gt; method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(ginf.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;g&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;g&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The composed &lt;code&gt;Select&lt;/code&gt; method calls &lt;code&gt;Select&lt;/code&gt; on the &lt;code&gt;F&lt;/code&gt; functor, passing it a lambda expression that calls &lt;code&gt;Select&lt;/code&gt; on the &lt;code&gt;G&lt;/code&gt; functor. That nested &lt;code&gt;Select&lt;/code&gt; call produces an &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;F&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;G&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; that the composed &lt;code&gt;Select&lt;/code&gt; method finally wraps in a &lt;code&gt;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&lt;/code&gt; object that it returns.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll have more to say about how this generalizes to a nested composition of more than two functors, but first, let&apos;s consider some examples.
    &lt;/p&gt;
    &lt;h3 id=&quot;fcd4126b51c24b10867de4280f5e8844&quot;&gt;
        Priority list &lt;a href=&quot;#fcd4126b51c24b10867de4280f5e8844&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A common configuration is when the &apos;outer&apos; functor is a collection, and the &apos;inner&apos; functor is some other kind of container. The article &lt;a href=&quot;/2024/07/01/an-immutable-priority-collection&quot;&gt;An immutable priority collection&lt;/a&gt; shows a straightforward example. The &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;PriorityCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; class composes a single class field:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;[]&amp;nbsp;priorities;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;priorities&lt;/code&gt; field is an array (a collection) of &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; objects. That type is a simple &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/record&quot;&gt;record&lt;/a&gt; type:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Priority&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If we squint a little and consider only the parameter list, we may realize that this is fundamentally an &apos;embellished&apos; tuple: &lt;code&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Priority&lt;/span&gt;)&lt;/code&gt;. &lt;a href=&quot;/2018/12/31/tuple-bifunctor&quot;&gt;A pair forms a bifunctor&lt;/a&gt;, but in the &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; &lt;code&gt;Prelude&lt;/code&gt; a tuple is also a &lt;code&gt;Functor&lt;/code&gt; instance over its rightmost element. In other words, if we&apos;d swapped the &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; constructor parameters, it might have naturally looked like something we could &lt;code&gt;fmap&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; fmap (elem &apos;r&apos;) (55, &quot;foo&quot;)
(55,False)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Here we have a tuple of an integer and a string. Imagine that the number &lt;code&gt;55&lt;/code&gt; is the priority that we give to the label &lt;code&gt;&quot;foo&quot;&lt;/code&gt;. This little ad-hoc example demonstrates how to map that tuple to another tuple with a priority, but now it instead holds a Boolean value indicating whether or not the string contained the character &lt;code&gt;&apos;r&apos;&lt;/code&gt; (which it didn&apos;t).
    &lt;/p&gt;
    &lt;p&gt;
        You can easily swap the elements:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; import Data.Tuple
ghci&amp;gt; swap (55, &quot;foo&quot;)
(&quot;foo&quot;,55)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This looks just like the &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; parameter list. This also implies that if you originally have the parameter list in that order, you could &lt;code&gt;swap&lt;/code&gt; it, map it, and swap it again:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; swap $ fmap (elem &apos;r&apos;) $ swap (&quot;foo&quot;, 55)
(False,55)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        My point is only that &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; is isomorphic to a known functor. In reality you rarely need to analyze things that thoroughly to come to that realization, but the bottom line is that you can give &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; a lawful &lt;code&gt;Select&lt;/code&gt; method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Item&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Priority&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Prioritized&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(Item),&amp;nbsp;Priority);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Hardly surprising, but since this article postulates that a functor of a functor is a functor, and since we already know that collections give rise to a functor, we should deduce that we can give &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;PriorityCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; a &lt;code&gt;Select&lt;/code&gt; method. And we can:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;PriorityCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;PriorityCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;priorities.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;p&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;());
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice how much this implementation looks like the above &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;GInF&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; &apos;shape&apos; implementation.
    &lt;/p&gt;
    &lt;h3 id=&quot;32b4e828d4584c3d8cda81a9682aee34&quot;&gt;
        Tree &lt;a href=&quot;#32b4e828d4584c3d8cda81a9682aee34&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        An example only marginally more complicated than the above is shown in &lt;a href=&quot;/2018/08/06/a-tree-functor&quot;&gt;A Tree functor&lt;/a&gt;. The &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; class shown in that article contains two constituents:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;children;
 
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;nbsp;Item&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;get&lt;/span&gt;;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Just like &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;PriorityCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; there&apos;s a collection, as well as a &apos;naked&apos; &lt;code&gt;T&lt;/code&gt; value. The main difference is that here, the collection is of the same type as the object itself: &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ve seen a similar example in &lt;a href=&quot;/2024/10/14/functor-sums&quot;&gt;the previous article&lt;/a&gt;, which also had a recursive data structure. If you assume, however, that &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; gives rise to a functor, then so does the nested composition of putting it in a collection. This means, from the &apos;theorem&apos; put forth in this article, that &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt; composes as a functor. Finally you have a product of a &lt;code&gt;T&lt;/code&gt; (which is isomorphic to the &lt;a href=&quot;/2018/09/03/the-identity-functor&quot;&gt;Identity functor&lt;/a&gt;) and that composed functor. From &lt;a href=&quot;/2024/09/16/functor-products&quot;&gt;Functor products&lt;/a&gt; it follows that that&apos;s a functor too, which explains why &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Tree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; forms a functor. &lt;a href=&quot;/2018/08/06/a-tree-functor&quot;&gt;The article&lt;/a&gt; shows the &lt;code&gt;Select&lt;/code&gt; implementation.
    &lt;/p&gt;
    &lt;h3 id=&quot;17209725eab64da598ba924342dafbd0&quot;&gt;
        Binary tree Zipper &lt;a href=&quot;#17209725eab64da598ba924342dafbd0&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In both previous articles you&apos;ve seen pieces of the puzzle explaining why the &lt;a href=&quot;/2024/09/09/a-binary-tree-zipper-in-c&quot;&gt;binary tree Zipper&lt;/a&gt; gives rise to functor. There&apos;s one missing piece, however, that we can now finally address.
    &lt;/p&gt;
    &lt;p&gt;
        Recall that &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;BinaryTreeZipper&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; composes these two objects:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BinaryTree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;nbsp;Tree&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;get&lt;/span&gt;;&amp;nbsp;}
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Crumb&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;Breadcrumbs&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;get&lt;/span&gt;;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        We&apos;ve already established that both &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;BinaryTree&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; and &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Crumb&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt; form functors. In this article you&apos;ve learned that a functor in a functor is a functor, which applies to &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Crumb&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&amp;gt;&lt;/code&gt;. Both of the above read-only properties are functors, then, which means that the entire class is a product of functors. The &lt;code&gt;Select&lt;/code&gt; method follows:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BinaryTreeZipper&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;BinaryTreeZipper&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;TResult&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Tree.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Breadcrumbs.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;c&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;c&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that this &lt;code&gt;Select&lt;/code&gt; implementation calls &lt;code&gt;Select&lt;/code&gt; on the &apos;outer&apos; &lt;code&gt;Breadcrumbs&lt;/code&gt; by calling &lt;code&gt;Select&lt;/code&gt; on each &lt;code&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Crumb&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;&amp;gt;&lt;/code&gt;. This is similar to the previous examples in this article.
    &lt;/p&gt;
    &lt;h3 id=&quot;800728c4c9c54aec815c62352843d52b&quot;&gt;
        Other nested containers &lt;a href=&quot;#800728c4c9c54aec815c62352843d52b&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        There are plenty of other examples of functors that contains other functor values. Asynchronous programming supplies its own family of examples.
    &lt;/p&gt;
    &lt;p&gt;
        The way that C# and many other languages model asynchronous or I/O-bound actions is to wrap them in a &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.threading.tasks.task-1&quot;&gt;Task&lt;/a&gt; container. If the value inside the &lt;code&gt;Task&amp;lt;T&amp;gt;&lt;/code&gt; container is itself a functor, you can make that a functor, too. Examples include &lt;code&gt;Task&amp;lt;IEnumerable&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;, &lt;code&gt;Task&amp;lt;Maybe&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; (or its close cousin &lt;code&gt;Task&amp;lt;T?&amp;gt;&lt;/code&gt;; notice &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/nullable-reference-types&quot;&gt;the question mark&lt;/a&gt;), &lt;code&gt;Task&amp;lt;Result&amp;lt;T1, T2&amp;gt;&amp;gt;&lt;/code&gt;, etc. You&apos;ll run into such types every time you have an I/O-bound or concurrent operation that returns &lt;code&gt;IEnumerable&amp;lt;T&amp;gt&lt;/code&gt;, &lt;code&gt;Maybe&amp;lt;T&amp;gt;&lt;/code&gt; etc. as an asynchronous result.
    &lt;/p&gt;
    &lt;p&gt;
        While you &lt;em&gt;can&lt;/em&gt; make such nested task functors a functor in its own right, you rarely need that in languages with native &lt;code&gt;async&lt;/code&gt; and &lt;code&gt;await&lt;/code&gt; features, since those languages nudge you in other directions.
    &lt;/p&gt;
    &lt;p&gt;
        You can, however, run into other issues with task-based programming, but you&apos;ll see examples and solutions in &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;a future article&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ll run into other examples of nested containers with many property-based testing libraries. They typically define &lt;a href=&quot;/2017/09/18/the-test-data-generator-functor&quot;&gt;Test Data Generators&lt;/a&gt;, often called &lt;code&gt;Gen&amp;lt;T&amp;gt;&lt;/code&gt;. For .NET, both &lt;a href=&quot;https://fscheck.github.io/FsCheck/&quot;&gt;FsCheck&lt;/a&gt;, &lt;a href=&quot;https://github.com/hedgehogqa/fsharp-hedgehog&quot;&gt;Hedgehog&lt;/a&gt;, and &lt;a href=&quot;https://github.com/AnthonyLloyd/CsCheck&quot;&gt;CsCheck&lt;/a&gt; does this. For Haskell, &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck&quot;&gt;QuickCheck&lt;/a&gt;, too, defines &lt;code&gt;Gen a&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        You often need to generate random collections, in which case you&apos;d work with &lt;code&gt;Gen&amp;lt;IEnumerable&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; or a similar collection type. If you need random &lt;a href=&quot;/2018/03/26/the-maybe-functor&quot;&gt;Maybe&lt;/a&gt; values, you&apos;ll work with &lt;code&gt;Gen&amp;lt;Maybe&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;, and so on.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, &lt;a href=&quot;/2016/06/28/roman-numerals-via-property-based-tdd&quot;&gt;sometimes you need&lt;/a&gt; to work with a collection of generators, such as &lt;code&gt;seq&amp;lt;Gen&amp;lt;&apos;a&amp;gt;&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        These are all examples of functors within functors. It&apos;s not a given that you &lt;em&gt;must&lt;/em&gt; treat such a combination as a functor in its own right. To be honest, typically, you don&apos;t. On the other hand, if you find yourself writing &lt;code&gt;Select&lt;/code&gt; within &lt;code&gt;Select&lt;/code&gt;, or &lt;code&gt;map&lt;/code&gt; within &lt;code&gt;map&lt;/code&gt;, depending on your language, it might make your code more succinct and readable if you give that combination a specialized functor affordance.
    &lt;/p&gt;
    &lt;h3 id=&quot;bffe8909eb904260be8aa4ab1a22efb2&quot;&gt;
        Higher arities &lt;a href=&quot;#bffe8909eb904260be8aa4ab1a22efb2&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Like the previous two articles, the &apos;theorem&apos; presented here generalizes to more than two functors. If you have a third &lt;code&gt;H&lt;/code&gt; functor, then &lt;code&gt;F&amp;lt;G&amp;lt;H&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;/code&gt; also gives rise to a functor. You can easily prove this by simple induction. We may first consider the base case. With a single functor (&lt;em&gt;n = 1&lt;/em&gt;) any functor (say, &lt;code&gt;F&lt;/code&gt;) is trivially a functor.
    &lt;/p&gt;
    &lt;p&gt;
        In the induction step (&lt;em&gt;n &gt; 1&lt;/em&gt;), you then assume that the &lt;em&gt;n - 1&lt;/em&gt; &apos;stack&apos; of functors already gives rise to a functor, and then proceed to prove that the configuration where all those nested functors are wrapped by yet another functor also forms a functor. Since the &apos;inner stack&apos; of functors forms a functor (by assumption), you only need to prove that a configuration of the outer functor, and that &apos;inner stack&apos;, gives rise to a functor. You&apos;ve seen how this works in this article, but I admit that a few examples constitute no proof. I&apos;ll leave you with only a sketch of this step, but you may consider using equational reasoning &lt;a href=&quot;https://bartoszmilewski.com/2015/01/20/functors/&quot;&gt;as demonstrated by Bartosz Milewski&lt;/a&gt; and then prove the functor laws for such a composition.
    &lt;/p&gt;
    &lt;p&gt;
        The Haskell &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-Functor-Compose.html&quot;&gt;Data.Functor.Compose&lt;/a&gt; module defines a general-purpose data type to compose functors. You may, for example, compose a tuple inside a Maybe inside a list:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;thriceNested&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Compose&lt;/span&gt;&amp;nbsp;[]&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;Compose&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Maybe&lt;/span&gt;&amp;nbsp;((,)&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Integer&lt;/span&gt;))&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;
thriceNested&amp;nbsp;=&amp;nbsp;Compose&amp;nbsp;[Compose&amp;nbsp;(Just&amp;nbsp;(42,&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;)),&amp;nbsp;Compose&amp;nbsp;Nothing,&amp;nbsp;Compose&amp;nbsp;(Just&amp;nbsp;(89,&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;ba&amp;quot;&lt;/span&gt;))]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You can easily &lt;code&gt;fmap&lt;/code&gt; that data structure, for example by evaluating whether the number of characters in each string is an odd number (if it&apos;s there at all):
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;ghci&amp;gt; fmap (odd . length) thriceNested
Compose [Compose (Just (42,True)),Compose Nothing,Compose (Just (89,False))]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The first element now has &lt;code&gt;True&lt;/code&gt; as the second tuple element, since &lt;code&gt;&quot;foo&quot;&lt;/code&gt; has an odd number of characters (3). The next element is &lt;code&gt;Nothing&lt;/code&gt;, because &lt;code&gt;Nothing&lt;/code&gt; maps to &lt;code&gt;Nothing&lt;/code&gt;. The third element has &lt;code&gt;False&lt;/code&gt; in the rightmost tuple element, since &lt;code&gt;&quot;ba&quot;&lt;/code&gt; doesn&apos;t have an odd number of characters (it has 2).
    &lt;/p&gt;
    &lt;h3 id=&quot;8c6ca7bcdc554856bee94bd11981aa6f&quot;&gt;
        Relations to monads &lt;a href=&quot;#8c6ca7bcdc554856bee94bd11981aa6f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A nested &apos;stack&apos; of functors may remind you of the way that I prefer to teach &lt;a href=&quot;/2022/03/28/monads&quot;&gt;monads&lt;/a&gt;: &lt;em&gt;A monad is a functor your can flatten&lt;/em&gt;. In short, the definition is the ability to &apos;flatten&apos; &lt;code&gt;F&amp;lt;F&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; to &lt;code&gt;F&amp;lt;T&amp;gt;&lt;/code&gt;. A function that can do that is often called &lt;code&gt;join&lt;/code&gt; or &lt;code&gt;Flatten&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        So far in this article, we&apos;ve been looking at stacks of different functors, abstractly denoted &lt;code&gt;F&amp;lt;G&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;. There&apos;s no rule, however, that says that &lt;code&gt;F&lt;/code&gt; and &lt;code&gt;G&lt;/code&gt; may not be the same. If &lt;code&gt;F = G&lt;/code&gt; then &lt;code&gt;F&amp;lt;G&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; is really &lt;code&gt;F&amp;lt;F&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;. This starts to look like the &lt;a href=&quot;https://en.wikipedia.org/wiki/Antecedent_(logic)&quot;&gt;antecedent&lt;/a&gt; of the monad definition.
    &lt;/p&gt;
    &lt;p&gt;
        While the starting point may be the same, these notions are not equivalent. Yes, &lt;code&gt;F&amp;lt;F&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; &lt;em&gt;may&lt;/em&gt; form a monad (if you can flatten it), but it does, universally, give rise to a functor. On the other hand, we can hardly talk about flattening &lt;code&gt;F&amp;lt;G&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;, because that would imply that you&apos;d have to somehow &apos;throw away&apos; either &lt;code&gt;F&lt;/code&gt; or &lt;code&gt;G&lt;/code&gt;. There may be specific functors (e.g. Identity) for which this is possible, but there&apos;s no universal law to that effect.
    &lt;/p&gt;
    &lt;p&gt;
        Not all &apos;stacks&apos; of functors are monads. &lt;a href=&quot;/2022/03/28/monads&quot;&gt;All monads, on the other hand, are functors&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;14f39729b7ab426e83a35a067cf8f3a1&quot;&gt;
        Conclusion &lt;a href=&quot;#14f39729b7ab426e83a35a067cf8f3a1&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A data structure that configures one type of functor inside of another functor itself forms a functor. The examples shown in this article are mostly constrained to two functors, but if you have a &apos;stack&apos; of three, four, or more functors, that arrangement still gives rise to a functor.
    &lt;/p&gt;
	&lt;p&gt;
		This is useful to know, particularly if you&apos;re working in a language with only partial support for functors. Mainstream languages aren&apos;t going to automatically turn such stacks into functors, in the way that Haskell&apos;s &lt;code&gt;Compose&lt;/code&gt; container almost does. Thus, knowing when you can safely give your generic types a &lt;code&gt;Select&lt;/code&gt; method or &lt;code&gt;map&lt;/code&gt; function may come in handy.
	&lt;/p&gt;
    &lt;p&gt;
        To be honest, though, this result is hardly the most important &apos;theorem&apos; concerning stacks of functors. In reality, you often run into situations where you &lt;em&gt;do&lt;/em&gt; have a stack of functors, but they&apos;re in the wrong order. You may have a collection of asynchronous tasks, but you really need an asynchronous task that contains a collection of values. The next article addresses that problem.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;Traversals&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2024/10/28/functor-compositions</guid>
      </item>
    

  </channel>
</rss>
